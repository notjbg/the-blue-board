<!DOCTYPE html>
<html lang="en">
<!--
  ═══════════════════════════════════════════════════════════════
  HUB REGISTRY — Canonical list of all United Airlines hubs
  ═══════════════════════════════════════════════════════════════
  IATA  ICAO   Timezone              City
  ORD   KORD   America/Chicago       Chicago O'Hare
  DEN   KDEN   America/Denver        Denver International
  IAH   KIAH   America/Chicago       Houston Intercontinental
  EWR   KEWR   America/New_York      Newark Liberty
  SFO   KSFO   America/Los_Angeles   San Francisco Int'l
  IAD   KIAD   America/New_York      Washington Dulles
  LAX   KLAX   America/Los_Angeles   Los Angeles Int'l
  NRT   RJAA   Asia/Tokyo            Tokyo Narita
  GUM   PGUM   Pacific/Guam          Guam Int'l

  When adding/removing a hub, update ALL of these locations:
    public/index.html  — AIRPORTS (hub:true), SCHED_HUB_TZ, hubCodes arrays,
                         hub health bar HTML, SEO metadata
    api/irrops.js      — HUBS array
    public/sitemap.xml — hub page entries
    public/hubs/       — individual hub HTML pages + cross-nav
  ═══════════════════════════════════════════════════════════════
-->
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0a0e14">
<link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%2064%2064%27%3E%3Crect%20width%3D%2764%27%20height%3D%2764%27%20rx%3D%2712%27%20fill%3D%27%230a0e14%27/%3E%3Ctext%20x%3D%2732%27%20y%3D%2742%27%20font-size%3D%2736%27%20text-anchor%3D%27middle%27%20fill%3D%27%23005DAA%27%20font-family%3D%27Arial%2C%20sans-serif%27%3EB%3C/text%3E%3C/svg%3E">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Blue Board">
<title>The Blue Board — United Flight Tracker | Live UA Flight Status, Delays & Fleet</title>
<meta name="description" content="Free United Airlines flight tracker updated every 30 seconds. Track any UA flight status live, check delays at all 9 hubs (ORD, DEN, IAH, EWR, SFO, IAD, LAX, NRT, GUM), see which planes have Starlink WiFi, browse the full fleet database, and monitor weather disruptions. Independent ops dashboard built for United flyers.">
<meta name="keywords" content="United flight tracker, United Airlines flight status, UA flight status, United Airlines flight tracker, United Airlines delays today, UA flight tracker, United Airlines live map, United hub delays, United Starlink tracker, United Starlink WiFi, United Airlines ORD delays, United Airlines DEN delays, United Airlines EWR delays, United Airlines IAH delays, United Airlines SFO delays, United Airlines NRT delays, United Airlines GUM delays, is my United flight on time, United Airlines cancellations, United fleet tracker, United Airlines aircraft, United Airlines schedule, United Airlines weather delays, UA delays, United Airlines ground stops, United Airlines disruptions, UA flight tracking">
<meta name="author" content="The Blue Board">
<meta name="robots" content="index, follow">
<meta property="og:type" content="website">
<meta property="og:title" content="The Blue Board — United Flight Tracker | Live Status, Delays & Fleet Database">
<meta property="og:description" content="Free United Airlines flight tracker — track any UA flight live, check delays at all 9 hubs, see which planes have Starlink WiFi, and monitor disruptions. Updated every 30 seconds.">
<meta property="og:url" content="https://theblueboard.co">
<meta property="og:site_name" content="The Blue Board">
<meta property="og:image" content="https://theblueboard.co/og-image.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="The Blue Board — live United Airlines flight tracker showing 600+ flights on a dark operations map of the United States with hub delay status">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="The Blue Board — United Flight Tracker | Live Status, Delays & Fleet Database">
<meta name="twitter:description" content="Free United Airlines flight tracker — track any UA flight live, check hub delays, Starlink WiFi status, fleet data, and schedules. Updated every 30 seconds.">
<meta name="twitter:image" content="https://theblueboard.co/og-image.png">
<meta name="twitter:site" content="@theblueboard">
<meta name="twitter:creator" content="@theblueboard">
<link rel="canonical" href="https://theblueboard.co">
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<link rel="dns-prefetch" href="https://unpkg.com">
<link rel="dns-prefetch" href="https://mesonet.agron.iastate.edu">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<!-- CSP enforced via vercel.json headers -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "The Blue Board",
  "alternateName": ["United Flight Tracker", "United Airlines Flight Tracker", "UA Flight Status", "UA Flight Tracker", "United Starlink Tracker", "United Airlines Operations Dashboard"],
  "description": "Track every United Airlines flight in real time. Live flight map updated every 30 seconds, delay and cancellation alerts across all 9 hubs (ORD, DEN, IAH, EWR, SFO, IAD, LAX, NRT, GUM), Starlink WiFi aircraft checker, full fleet database of 1,175+ aircraft, departure and arrival schedules, weather radar, and operational analytics. Free and independent — built for United flyers.",
  "url": "https://theblueboard.co",
  "applicationCategory": "Transportation",
  "operatingSystem": "Web",
  "offers": {"@type": "Offer", "price": "0", "priceCurrency": "USD"},
  "creator": {"@type": "Person", "name": "Jonah Berg", "url": "https://github.com/notjbg", "sameAs": ["https://x.com/theblueboard", "https://github.com/notjbg"]},
  "featureList": [
    "Real-time United Airlines flight tracking map with 600+ flights updated every 30 seconds",
    "Live delay and cancellation alerts for all 9 United hubs",
    "Ground stop and FAA NAS status monitoring",
    "Departure and arrival schedules for ORD, DEN, IAH, EWR, SFO, IAD, LAX, NRT, GUM",
    "Equipment swap detection and alerts",
    "On-time performance statistics by hub",
    "Starlink WiFi aircraft checker — see if your plane has fast internet",
    "Full United Airlines fleet database with 1,175+ aircraft, seat configs, and IFE details",
    "NEXRAD weather radar overlay on live map",
    "METAR weather conditions for all hub airports",
    "Hub-to-hub traffic flow and route analytics",
    "Flight search by flight number, tail number, or route",
    "Flight watch with browser push notifications on status changes",
    "Dark operations center interface optimized for mobile and desktop"
  ],
  "isAccessibleForFree": true,
  "browserRequirements": "Requires JavaScript",
  "softwareVersion": "2.0",
  "sourceOrganization": {"@type": "Organization", "name": "The Blue Board", "url": "https://github.com/notjbg/the-blue-board"}
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "How do I check if my United Airlines flight is on time?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "The Blue Board shows real-time status for every United Airlines flight. Use the search bar to look up your flight number (e.g., UA 1234) and see its current position, delays, and estimated arrival. The hub health bar at the top shows at-a-glance delay conditions at all 9 United hubs."
      }
    },
    {
      "@type": "Question",
      "name": "Which United Airlines planes have Starlink WiFi?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "The Blue Board tracks 258+ United Airlines aircraft equipped with Starlink satellite WiFi. Go to the Fleet tab and check the Starlink section to search by tail number, aircraft type, or fleet. You can also see WiFi status when looking up a specific flight."
      }
    },
    {
      "@type": "Question",
      "name": "Are there delays at United Airlines hubs today?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "The Blue Board monitors delays, cancellations, and ground stops at all 9 United hubs (Chicago O'Hare, Denver, Houston, Newark, San Francisco, Dulles, Los Angeles, Tokyo Narita, and Guam) in real time. The hub health bar shows on-time performance, and the IRROPS monitor breaks down disruption types at each hub."
      }
    },
    {
      "@type": "Question",
      "name": "What is The Blue Board?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "The Blue Board is a free, independent real-time operations dashboard for United Airlines flights. It tracks every United flight on a live map, shows delays and cancellations at all hubs, provides fleet and aircraft data, weather conditions, and operational analytics. Built for the United community — not affiliated with United Airlines, Inc."
      }
    },
    {
      "@type": "Question",
      "name": "How do I track a United Airlines flight?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Use The Blue Board's free United flight tracker at theblueboard.co. Enter any UA flight number (e.g., UA 875, UA 1234) in the search bar to see its live position, altitude, speed, route, delay status, and aircraft details. The map updates every 30 seconds with all 600+ United flights in the air."
      }
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Dataset",
  "name": "United Airlines Live Flight & Fleet Data",
  "description": "Real-time dataset of United Airlines flight positions, delays, cancellations, on-time performance across 9 hubs, and fleet information including 1,175+ aircraft with Starlink WiFi status, seat configurations, and equipment details. Updated every 30 seconds.",
  "url": "https://theblueboard.co",
  "license": "https://theblueboard.co",
  "creator": {"@type": "Person", "name": "Jonah Berg", "url": "https://github.com/notjbg"},
  "keywords": ["United Airlines", "flight tracking", "flight delays", "on-time performance", "Starlink WiFi", "fleet data", "aviation", "airline operations"],
  "temporalCoverage": "2025/..",
  "spatialCoverage": {"@type": "Place", "name": "United States"},
  "variableMeasured": [
    {"@type": "PropertyValue", "name": "Flight Status", "description": "Real-time position, delay, and cancellation status for every United Airlines flight"},
    {"@type": "PropertyValue", "name": "Hub On-Time Performance", "description": "On-time percentage for ORD, DEN, IAH, EWR, SFO, IAD, LAX, NRT, GUM"},
    {"@type": "PropertyValue", "name": "Starlink WiFi Equipment", "description": "Aircraft equipped with Starlink satellite internet by tail number"},
    {"@type": "PropertyValue", "name": "Fleet Composition", "description": "Aircraft type, seat configuration, IFE, and equipment details"}
  ],
  "distribution": {
    "@type": "DataDownload",
    "encodingFormat": "text/html",
    "contentUrl": "https://theblueboard.co"
  }
}
</script>
<link rel="preload" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet"></noscript>
<link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/></noscript>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
<!-- Preload LCP map tile for default US view (zoom 4, center ~39,-98) -->
<link rel="preload" href="https://a.basemaps.cartocdn.com/dark_all/4/3/5.png" as="image" fetchpriority="high">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--ua-blue:#005DAA;--ua-dark:#0a0e14;--ua-panel:#111827;--ua-border:#1e293b;--ua-text:#e2e8f0;--ua-muted:#64748b;--ua-accent:#8ab4f8;--ua-green:#22c55e;--ua-yellow:#eab308;--ua-red:#ef4444;--bg-card:#111827;--mono:'JetBrains Mono',monospace}
body{background:var(--ua-dark);color:var(--ua-text);font-family:var(--mono);overflow:hidden;font-size:12px;height:100vh;height:100dvh;display:flex;flex-direction:column}
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 49px,rgba(30,41,59,.15) 50px),repeating-linear-gradient(90deg,transparent,transparent 49px,rgba(30,41,59,.15) 50px);pointer-events:none;z-index:0}

/* Scrollbar */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--ua-dark)}
::-webkit-scrollbar-thumb{background:var(--ua-border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#2d3a4f}

/* Ticker */
.ticker-wrap{background:var(--ua-panel);border-bottom:1px solid var(--ua-border);overflow:hidden;height:28px;position:relative;z-index:100;flex-shrink:0}
.ticker{display:flex;align-items:center;height:100%;white-space:nowrap;width:max-content;min-width:200%;animation:tickerScroll 40s linear infinite}
@keyframes tickerScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.ticker-item{padding:0 40px;font-size:11px;font-weight:500;letter-spacing:.3px}
.ticker-item.info{color:var(--ua-green)}.ticker-item.advisory{color:var(--ua-yellow)}.ticker-item.critical{color:var(--ua-red)}
.ticker-label{background:var(--ua-blue);color:#fff;font-size:10px;font-weight:700;padding:2px 10px;position:absolute;left:0;top:0;height:100%;display:flex;align-items:center;z-index:2;letter-spacing:1px}

/* Header */
#header{display:flex;align-items:center;justify-content:space-between;padding:6px 16px;background:linear-gradient(90deg,var(--ua-dark),#0d1520);border-bottom:1px solid rgba(0,93,170,.3);flex-shrink:0}
#header h1{font-size:16px;font-weight:700;color:#fff;letter-spacing:1.5px}
#header h1 .ua{color:var(--ua-blue)}
#header-right{display:flex;align-items:center;gap:16px;font-size:11px}
.status-dot{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:4px}
.status-dot.live{background:var(--ua-green);box-shadow:0 0 8px var(--ua-green)}
#countdown{font-variant-numeric:tabular-nums;color:var(--ua-accent)}

/* Tabs */
#tab-bar{display:flex;background:var(--ua-panel);border-bottom:2px solid var(--ua-border);flex-shrink:0}
.tab-btn{flex:1;padding:10px 8px;text-align:center;font-size:11px;font-weight:600;letter-spacing:.5px;color:var(--ua-muted);cursor:pointer;border:none;background:none;transition:all .25s;border-bottom:2px solid transparent;font-family:var(--mono)}
.tab-btn:hover{color:#94a3b8;background:rgba(30,41,59,.5)}
.tab-btn.active{color:var(--ua-text);border-bottom-color:var(--ua-blue);background:rgba(0,93,170,.08)}
main{flex:1;min-height:0;display:flex;flex-direction:column;overflow:hidden}
.tab-content{display:none;position:relative;z-index:1;flex:1;min-height:0;overflow-y:auto}
.tab-content.active{display:flex;flex-direction:column}

/* ═══ TAB 1: LIVE OPS ═══ */
#tab-live{flex:1;min-height:0}
#tab-live .ops-layout{display:flex;height:100%;overflow:hidden}
#tab-live .sidebar{width:260px;background:var(--ua-panel);border-right:1px solid var(--ua-border);overflow-y:auto;flex-shrink:0}
#sidebar-filters-toggle{display:none}
#tab-live .sidebar h3{font-size:10px;color:var(--ua-blue);text-transform:uppercase;letter-spacing:1.5px;padding:12px 12px 6px;border-bottom:1px solid var(--ua-border)}
.hub-row{display:flex;justify-content:space-between;align-items:center;padding:6px 12px;border-bottom:1px solid rgba(30,41,59,.4);transition:background .15s;cursor:default}
.hub-row:hover{background:rgba(0,93,170,.06)}
.hub-code{font-weight:700;color:var(--ua-accent);font-size:13px}
.hub-counts{font-size:10px;color:var(--ua-muted)}
.hub-bar{height:3px;background:var(--ua-border);border-radius:2px;margin-top:3px}
.hub-bar-fill{height:100%;background:var(--ua-blue);border-radius:2px;transition:width .5s}
.busiest-badge{background:var(--ua-blue);color:#fff;font-size:9px;padding:1px 5px;border-radius:3px;font-weight:700}
#tab-live .map-area{flex:1;position:relative}
#tab-live #map{width:100%;height:100%}
#tab-live #controls{position:absolute;top:10px;right:10px;z-index:1000;display:flex;flex-direction:column;gap:5px}
.ctrl-btn{background:rgba(10,14,20,.9);border:1px solid var(--ua-border);color:#ccc;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:10px;font-family:var(--mono);backdrop-filter:blur(8px);transition:all .2s}
.ctrl-btn:hover{background:rgba(0,93,170,.3);border-color:var(--ua-blue)}
.ctrl-btn.active{border-color:var(--ua-accent);color:var(--ua-accent)}
#search-box{position:absolute;top:10px;left:10px;z-index:1000}
#search-input{background:rgba(10,14,20,.9);border:1px solid var(--ua-border);color:var(--ua-text);padding:7px 12px;border-radius:4px;font-family:var(--mono);font-size:11px;width:220px;backdrop-filter:blur(8px)}
#search-input:focus{outline:none;border-color:var(--ua-blue)}
#search-results{position:absolute;top:34px;left:0;background:rgba(17,24,39,.95);border:1px solid var(--ua-border);border-radius:4px;max-height:300px;overflow-y:auto;width:280px;display:none;backdrop-filter:blur(8px)}
.search-result{padding:6px 12px;cursor:pointer;border-bottom:1px solid rgba(30,41,59,.3);font-size:11px}
.search-result:hover{background:rgba(0,93,170,.15)}

/* Stats bar */
#stats-bar{background:var(--ua-panel);border-top:1px solid var(--ua-border);padding:6px 16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;font-size:10px;flex-shrink:0}
.stat-item{display:flex;align-items:center;gap:4px}
.stat-val{color:var(--ua-accent);font-weight:700;font-size:12px}
.stat-label{color:var(--ua-muted)}
.stat-sep{color:var(--ua-border);margin:0 4px}

/* Popups */
.leaflet-popup-content-wrapper{background:rgba(17,24,39,.96)!important;color:var(--ua-text)!important;border:1px solid var(--ua-border)!important;border-radius:8px!important;box-shadow:0 8px 32px rgba(0,0,0,.6)!important;backdrop-filter:blur(12px)!important;font-family:var(--mono)!important}
.leaflet-popup-tip{background:rgba(17,24,39,.96)!important}
.leaflet-popup-content{margin:0!important;font-size:11px!important;min-width:280px!important}
.popup-card{padding:12px}
.popup-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--ua-border)}
.popup-callsign{font-size:18px;font-weight:700;color:var(--ua-accent)}
.popup-route{font-size:13px;color:#fff;margin-top:2px}
.popup-route-est{font-size:9px;color:var(--ua-muted);font-style:italic}
.popup-phase{font-size:10px;padding:2px 8px;border-radius:3px;font-weight:600;display:inline-block}
.phase-ground{background:#374151;color:#9ca3af}
.phase-climb{background:rgba(34,197,94,.15);color:var(--ua-green)}
.phase-cruise{background:rgba(0,93,170,.15);color:var(--ua-accent)}
.phase-descent{background:rgba(234,179,8,.15);color:var(--ua-yellow)}
.phase-approach{background:rgba(239,68,68,.15);color:var(--ua-red)}
.popup-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 12px;margin:8px 0}
.popup-field{display:flex;flex-direction:column}
.popup-field-label{font-size:9px;color:var(--ua-muted);text-transform:uppercase;letter-spacing:.5px}
.popup-field-value{font-size:12px;font-weight:600}
.alt-bar{height:6px;background:var(--ua-border);border-radius:3px;margin:3px 0;overflow:hidden}
.alt-bar-fill{height:100%;background:linear-gradient(90deg,var(--ua-blue),var(--ua-accent));border-radius:3px;transition:width .3s}
.popup-aircraft{background:rgba(0,93,170,.08);border:1px solid rgba(0,93,170,.2);border-radius:4px;padding:6px 8px;margin:8px 0}
.popup-aircraft-type{font-size:13px;font-weight:700;color:var(--ua-blue)}
.popup-seats{display:flex;gap:4px;margin-top:4px}
.seat-block{padding:1px 5px;border-radius:2px;font-size:9px;font-weight:600}
.seat-J{background:rgba(0,93,170,.3);color:#60a5fa}
.seat-PP,.seat-PE{background:rgba(20,184,166,.3);color:#2dd4bf}
.seat-F{background:rgba(139,92,246,.3);color:#a78bfa}
.seat-E\\+{background:rgba(34,197,94,.3);color:#4ade80}
.seat-Y{background:rgba(100,116,139,.3);color:#94a3b8}
.starlink-badge{background:rgba(34,197,94,.2);color:var(--ua-green);padding:2px 6px;border-radius:3px;font-size:9px;font-weight:700}
.squawk-alert{background:var(--ua-red);color:#fff;padding:2px 8px;border-radius:3px;font-size:10px;font-weight:700;animation:blink 1s infinite}
@keyframes blink{50%{opacity:.5}}
.popup-times{display:grid;grid-template-columns:1fr 1fr;gap:4px 12px;margin:8px 0;padding:8px;background:rgba(0,93,170,.06);border:1px solid rgba(0,93,170,.15);border-radius:4px}
.popup-times .popup-field-value{font-size:11px}
.popup-times .time-delta{font-size:9px;font-weight:600;margin-left:4px}
.popup-times .time-delta.late{color:#ef4444}
.popup-times .time-delta.early{color:#22c55e}
.popup-times .time-delta.ontime{color:var(--ua-muted)}
.popup-times-loading{font-size:10px;color:var(--ua-muted);text-align:center;padding:6px;animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.popup-links{display:flex;gap:8px;margin-top:8px;padding-top:8px;border-top:1px solid var(--ua-border)}
.popup-links a{color:var(--ua-accent);text-decoration:none;font-size:10px;opacity:.7;transition:opacity .2s}
.popup-links a:hover{opacity:1}
.hub-tooltip{background:rgba(10,14,20,.85)!important;border:1px solid var(--ua-blue)!important;color:var(--ua-accent)!important;font-size:10px!important;font-weight:700!important;padding:2px 6px!important;border-radius:3px!important;font-family:var(--mono)!important}

/* ═══ TAB 2: FLEET ═══ */
#tab-fleet{padding:16px;flex:1;min-height:0;overflow-y:auto}
.card{background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:6px;padding:14px;margin-bottom:14px}
.card h3{font-size:10px;color:var(--ua-blue);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px}
.fleet-chips{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:6px;margin-bottom:14px}
.fleet-chip{background:rgba(15,23,41,.8);border:1px solid var(--ua-border);border-radius:6px;padding:8px;text-align:center;cursor:pointer;transition:all .2s}
.fleet-chip:hover,.fleet-chip.active{border-color:var(--ua-blue);background:rgba(0,93,170,.1)}
.fleet-chip .count{font-size:20px;font-weight:700;color:var(--ua-blue)}
.fleet-chip .label{font-size:9px;color:var(--ua-muted);margin-top:1px}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:900px){.two-col{grid-template-columns:1fr}}
.fleet-controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
.fleet-controls select,.fleet-controls input{background:rgba(15,23,41,.8);border:1px solid var(--ua-border);color:var(--ua-text);padding:6px 10px;border-radius:4px;font-family:var(--mono);font-size:11px}
.fleet-controls select:focus,.fleet-controls input:focus{outline:none;border-color:var(--ua-blue)}
.fleet-table-wrap{max-height:500px;overflow-y:auto;border:1px solid var(--ua-border);border-radius:4px}
table{width:100%;border-collapse:collapse;font-size:11px}
thead th{position:sticky;top:0;background:var(--ua-panel);color:var(--ua-muted);text-align:left;padding:7px 8px;border-bottom:2px solid var(--ua-blue);cursor:pointer;user-select:none;font-size:9px;text-transform:uppercase;letter-spacing:.5px}
thead th:hover{color:var(--ua-blue)}
tbody tr{border-bottom:1px solid rgba(30,41,59,.4);transition:background .15s}
tbody tr:hover{background:rgba(30,41,59,.4)}
tbody td{padding:5px 8px;white-space:nowrap}
.row-stored{color:var(--ua-muted);font-style:italic}
.row-maint{color:var(--ua-yellow)}
.chart-bar{display:flex;align-items:flex-end;gap:2px;height:120px;padding:8px 0}
.chart-col{display:flex;flex-direction:column;align-items:center;flex:1;min-width:0}
.chart-col .bar{background:var(--ua-blue);border-radius:2px 2px 0 0;width:100%;min-height:1px;transition:height .5s}
.chart-col .lbl{font-size:9px;color:var(--ua-muted);margin-top:2px;writing-mode:vertical-rl;transform:rotate(180deg);max-height:50px;overflow:hidden}
.chart-col .val{font-size:9px;color:var(--ua-accent);margin-bottom:1px}
.config-gallery{display:flex;gap:3px;flex-wrap:wrap;margin-top:6px}
.config-block{height:14px;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#fff;min-width:20px}
.config-J{background:#2563eb}.config-PP,.config-PE{background:#0d9488}.config-F{background:#7c3aed}.config-E\\+{background:#16a34a}.config-Y{background:#475569}
.refresh-btn{background:var(--ua-blue);color:#fff;border:none;padding:6px 14px;border-radius:4px;cursor:pointer;font-family:var(--mono);font-size:10px;font-weight:600;transition:all .2s}
.refresh-btn:hover{background:#0070cc}

/* ═══ TAB 3: WEATHER ═══ */
#tab-weather{padding:0;flex:1;min-height:0;overflow-y:auto}
.wx-hero{position:relative}
.wx-hero h3{position:absolute;top:10px;left:14px;z-index:500;font-size:13px;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.7)}
#radar-map{height:500px;width:100%}
.wx-legend{display:flex;align-items:center;justify-content:center;gap:18px;padding:8px 16px;background:var(--ua-panel);border-bottom:1px solid var(--ua-border);font-size:10px}
.wx-legend-item{display:flex;align-items:center;gap:5px}
.wx-legend-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
.hub-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;padding:16px}
.hub-card{background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:6px;overflow:hidden;transition:border-color .2s}
.hub-card:hover{border-color:var(--ua-accent)}
.hub-card-top{padding:12px 14px 8px;display:flex;align-items:center;justify-content:space-between}
.hub-card-code{font-size:22px;font-weight:700;color:#fff}
.hub-card-name{font-size:10px;color:var(--ua-muted);padding:0 14px;margin-top:-4px}
.cat-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:3px;letter-spacing:.5px}
.hub-metrics{display:grid;grid-template-columns:1fr 1fr;gap:1px;margin:10px 14px;background:var(--ua-border);border-radius:4px;overflow:hidden}
.hub-metric{background:rgba(0,0,0,.25);padding:8px 10px}
.hub-metric-label{font-size:9px;color:var(--ua-muted);text-transform:uppercase;letter-spacing:.5px}
.hub-metric-val{font-size:13px;font-weight:600;color:var(--ua-text);margin-top:2px}
.hub-faa{padding:6px 14px;font-size:10px;display:flex;align-items:center;gap:6px}
.hub-faa.normal{color:var(--ua-green)}.hub-faa.delay{color:var(--ua-red)}
.hub-explainer{padding:6px 14px;font-size:10px;line-height:1.5;color:var(--ua-muted)}
.hub-raw{padding:6px 14px 10px;font-size:9px;color:var(--ua-accent);opacity:.7;word-break:break-all;font-family:var(--mono)}

/* ═══ TAB 4: ANALYTICS ═══ */
#tab-analytics{padding:16px;flex:1;min-height:0;overflow-y:auto}
.metric-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:14px}
@media(max-width:900px){.metric-row{grid-template-columns:repeat(2,1fr)}}
.metric-card{background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:6px;padding:14px;text-align:center}
.metric-val{font-size:28px;font-weight:700;color:var(--ua-blue)}
.metric-label{font-size:9px;color:var(--ua-muted);text-transform:uppercase;letter-spacing:1px;margin-top:4px}

/* ═══ TAB 5: SOURCES ═══ */
#tab-sources{padding:20px;flex:1;min-height:0;overflow-y:auto}
.source-item{display:flex;align-items:flex-start;gap:12px;padding:12px;background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:6px;margin-bottom:10px;transition:border-color .2s}
.source-item:hover{border-color:var(--ua-blue)}
.source-icon{font-size:24px;flex-shrink:0}
.source-name{font-weight:700;color:var(--ua-accent);font-size:13px}
.source-desc{color:var(--ua-muted);font-size:11px;margin-top:2px}
.source-link{color:var(--ua-blue);text-decoration:none;font-size:10px;margin-top:4px;display:inline-block}
.source-link:hover{text-decoration:underline}
.freshness{display:inline-block;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:600;margin-left:6px}
.fresh-live{background:rgba(34,197,94,.15);color:var(--ua-green)}
.fresh-daily{background:rgba(234,179,8,.15);color:var(--ua-yellow)}
.fresh-static{background:rgba(100,116,139,.15);color:var(--ua-muted)}

/* Hub/Phase Filter Styles */
.hub-row{cursor:pointer}
.hub-row.hub-selected{background:rgba(0,93,170,.2);border-left:3px solid var(--ua-blue)}
.show-all-btn{display:block;padding:6px 12px;font-size:10px;color:var(--ua-accent);cursor:pointer;border-bottom:1px solid var(--ua-border);text-align:center;font-family:var(--mono);font-weight:600;transition:background .15s}
.show-all-btn:hover{background:rgba(0,93,170,.1)}
.phase-row{display:flex;justify-content:space-between;padding:4px 0;font-size:10px;cursor:pointer;border-radius:3px;padding:4px 6px;transition:background .15s}
.phase-row:hover{background:rgba(0,93,170,.1)}
.phase-row.phase-selected{background:rgba(0,93,170,.2);border-left:2px solid var(--ua-accent)}

/* Live Fleet Status */
.live-fleet-panel{background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:6px;padding:14px;margin-bottom:14px;position:relative;overflow:hidden}
.live-fleet-panel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--ua-green),var(--ua-blue),var(--ua-green));background-size:200% 100%;animation:liveShimmer 2s linear infinite}
@keyframes liveShimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.live-badge{display:inline-flex;align-items:center;gap:4px;background:rgba(34,197,94,.15);color:var(--ua-green);font-size:10px;font-weight:700;padding:2px 8px;border-radius:3px;letter-spacing:1px}
.pulse-dot{width:8px;height:8px;border-radius:50%;background:var(--ua-green);animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(34,197,94,.4)}50%{opacity:.7;box-shadow:0 0 0 6px rgba(34,197,94,0)}}
.big-number{font-size:36px;font-weight:700;color:var(--ua-blue);line-height:1}
.big-number-label{font-size:10px;color:var(--ua-muted);text-transform:uppercase;letter-spacing:1px}
.type-breakdown{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:4px;margin:10px 0}
.type-bar{display:flex;justify-content:space-between;align-items:center;padding:3px 6px;background:rgba(0,0,0,.2);border-radius:3px;font-size:10px}
.type-bar .airborne{color:var(--ua-green);font-weight:700}
.type-bar .total{color:var(--ua-muted)}
.live-table-wrap{max-height:350px;overflow-y:auto;border:1px solid var(--ua-border);border-radius:4px;margin-top:10px}

/* Weather Explainer */
.wx-explainer{background:rgba(0,93,170,.06);border:1px solid rgba(0,93,170,.15);border-radius:4px;padding:8px 10px;margin:4px 0 8px;font-size:10px;line-height:1.5;color:var(--ua-text)}
.wx-explainer .icon{font-size:12px;margin-right:4px}

/* Offline Banner */
#offline-banner{display:none;background:var(--ua-red);color:#fff;text-align:center;padding:8px 16px;font-size:11px;font-weight:600;letter-spacing:.5px;z-index:9999}
#offline-banner.show{display:block}

/* Error/Empty States */
.error-state,.empty-state{text-align:center;padding:40px 20px;color:var(--ua-muted);font-size:12px}
.error-state .error-icon,.empty-state .empty-icon{font-size:32px;margin-bottom:10px}
.retry-btn{background:var(--ua-blue);color:#fff;border:none;padding:8px 20px;border-radius:4px;cursor:pointer;font-family:var(--mono);font-size:11px;font-weight:600;margin-top:12px;transition:background .2s}
.retry-btn:hover{background:#0070cc}

/* Visually Hidden (for screen readers / LLMs) */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

/* Animations */
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.tab-content.active{animation:fadeIn .2s ease}

/* ═══ MOBILE RESPONSIVE ═══ */
@media(max-width:768px){
  body{font-size:14px;height:calc(100vh - 56px);height:calc(100dvh - 56px)}
  /* ── Compact Header ── */
  #header{flex-direction:row;gap:0;padding:0 12px;height:44px;text-align:left;align-items:center}
  #header h1{font-size:14px;letter-spacing:1px;white-space:nowrap}
  #header h1 span[style]{display:none}
  #global-search-wrap{position:absolute!important;top:44px;left:0;right:0;flex:none!important;order:0;display:none;padding:8px 12px;background:var(--ua-dark);border-bottom:1px solid var(--ua-border);z-index:999}
  #global-search-wrap.mobile-search-open{display:block!important}
  #header-right{font-size:14px;gap:8px;margin-left:auto}
  #header-right #countdown,#header-right #clock{display:none}
  #mobile-search-toggle{display:flex!important}
  /* ── Hide top tab bar, show bottom nav ── */
  #tab-bar{display:none!important}
  #mobile-bottom-nav{display:flex!important}
  /* ── Live Ops ── */
  #tab-live{flex:1;min-height:0}
  #tab-live .ops-layout{flex-direction:column}
  /* Sidebar collapsed by default on mobile */
  #tab-live .sidebar{width:100%;max-height:none;border-right:none;border-bottom:1px solid var(--ua-border);display:none;position:relative;z-index:10}
  #tab-live .sidebar.mobile-sidebar-open{display:block;max-height:60vh;overflow-y:auto}
  #tab-live .sidebar #sidebar-extra-filters{display:none}
  #tab-live .sidebar #sidebar-filters-toggle{display:block}
  #tab-live .sidebar #sidebar-extra-filters.show{display:block}
  #mobile-sidebar-toggle{display:flex!important}
  #tab-live .map-area{height:calc(100vh - 100px);min-height:300px}
  #tab-live #map{height:100%}
  /* ── Map controls: collapse behind menu toggle (Change 1) ── */
  #tab-live #controls{top:6px;right:6px;gap:3px}
  #tab-live #controls .ctrl-btn:not(#btn-refresh):not(#mobile-ctrl-toggle){display:none}
  #tab-live #controls.ctrl-menu-open .ctrl-btn{display:flex}
  #mobile-ctrl-toggle{display:flex!important}
  .ctrl-btn{padding:6px 10px;font-size:12px;min-height:36px}
  /* ── Stats bar: horizontal scrollable strip (Changes 2, 7) ── */
  #stats-bar{padding:4px 10px;gap:0;display:flex!important;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;max-height:40px}
  #stats-bar::-webkit-scrollbar{display:none}
  .stat-sep{display:none}
  .stat-item{min-width:auto;text-align:center;flex-direction:row;gap:4px;padding:4px 10px;white-space:nowrap;flex-shrink:0;background:rgba(30,41,59,.4);border-radius:12px;margin:2px 3px}
  .stat-val{font-size:13px;font-weight:700}
  .stat-label{font-size:10px;color:var(--ua-muted)}
  /* Schedule tab mobile */
  #tab-schedule .card:first-child > div{flex-direction:column;gap:8px}
  #tab-schedule .card:first-child > div > div{flex-direction:column;gap:6px;width:100%}
  #tab-schedule select,#tab-schedule input[type="text"]{width:100%!important;min-height:44px;font-size:14px!important;padding:8px 10px!important}
  #tab-schedule button{min-height:44px}
  #sched-stats.metric-row{grid-template-columns:repeat(2,1fr)!important;gap:8px}
  .fleet-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  table{min-width:600px}
  /* Fleet tab mobile */
  #tab-fleet{padding:10px}
  .fleet-chips{grid-template-columns:repeat(3,1fr)}
  .fleet-controls{flex-direction:column}
  .fleet-controls select,.fleet-controls input{width:100%;min-height:44px;font-size:14px}
  .two-col{grid-template-columns:1fr}
  /* Weather tab mobile */
  #radar-map{height:300px}
  .hub-cards{grid-template-columns:1fr;padding:10px}
  /* Analytics mobile */
  .metric-row{grid-template-columns:repeat(2,1fr)!important;gap:8px}
  .metric-val{font-size:22px}
  /* General touch targets */
  .sched-day-btn{min-height:44px;padding:8px 14px;font-size:14px}
  .hub-row{padding:10px 12px}
  .phase-row{padding:8px 6px}
  .search-result{padding:10px 12px}
  /* Footer mobile */
  #disclaimer-modal > div{margin:10px;padding:16px}
  /* ── Ticker: static single-line with fade rotation (Change 3) ── */
  .ticker-wrap{overflow:hidden}
  .ticker{animation:none!important;transform:none!important;overflow:hidden;position:relative}
  .ticker .ticker-item{display:none;position:absolute;left:60px;right:0;top:0;height:100%;align-items:center;overflow:hidden;text-overflow:ellipsis;padding:0 10px;transition:opacity .4s ease}
  .ticker .ticker-item.mobile-active{display:flex;opacity:1}
  .ticker .ticker-item.mobile-fade-out{opacity:0}
  /* ── Bottom nav: 4 tabs max, larger icons (Change 4) ── */
  #mobile-bottom-nav button .bnav-icon{font-size:22px}
  #mobile-bottom-nav button .bnav-label{font-size:12px}
  #mobile-bottom-nav .bnav-overflow-item{display:none}
  #mobile-more-btn{display:flex!important}
  #mobile-more-menu{display:none;position:fixed;bottom:58px;right:8px;background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:8px;padding:6px 0;z-index:9999;box-shadow:0 -4px 20px rgba(0,0,0,.5);min-width:160px}
  #mobile-more-menu.open{display:block}
  #mobile-more-menu button{display:flex;align-items:center;gap:10px;width:100%;background:none;border:none;color:var(--ua-text);font-family:var(--mono);font-size:13px;padding:10px 16px;cursor:pointer;transition:background .15s}
  #mobile-more-menu button:hover{background:rgba(30,41,59,.5)}
  #mobile-more-menu button .bnav-icon{font-size:18px}
  /* ── Hub health bar: hidden on mobile (Change 5) ── */
  #hub-health-bar{display:none!important}
  /* ── Footer: condensed single line (Change 6) ── */
  .footer-hub-links,.footer-data-sources{display:none!important}
  /* ── Header live count emphasis (Change 7) ── */
  #header-flight-count{font-size:11px!important;color:var(--ua-accent)!important;font-weight:600}
}
/* ── Bottom Nav (hidden on desktop) ── */
#mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;height:56px;background:var(--ua-panel);border-top:1px solid var(--ua-border);z-index:9998;align-items:stretch;justify-content:space-around}
#mobile-bottom-nav button{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;background:none;border:none;color:var(--ua-muted);font-family:var(--mono);font-size:11px;cursor:pointer;padding:4px 0;transition:color .2s;min-height:44px}
#mobile-bottom-nav button .bnav-icon{font-size:18px;line-height:1}
#mobile-bottom-nav button.active{color:var(--ua-blue)}
#mobile-bottom-nav button.active .bnav-label{color:var(--ua-blue)}
#mobile-more-btn{display:none}
#mobile-more-menu{display:none}
/* ── Mobile search toggle (hidden on desktop) ── */
#mobile-search-toggle{display:none!important;background:none;border:none;color:var(--ua-muted);font-size:16px;cursor:pointer;padding:4px;align-items:center;justify-content:center}
/* ── Mobile sidebar toggle (hidden on desktop) ── */
#mobile-sidebar-toggle{display:none!important;align-items:center;gap:4px;background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:4px;color:var(--ua-accent);font-family:var(--mono);font-size:10px;padding:6px 12px;cursor:pointer;margin:6px 10px;width:calc(100% - 20px)}
/* Schedule Tab */
.sched-day-btn{background:none;border:1px solid var(--ua-border);color:var(--ua-muted);padding:3px 10px;font-family:var(--mono);font-size:10px;cursor:pointer;border-radius:3px;transition:all .2s}
.sched-day-btn:hover{color:var(--ua-text);border-color:var(--ua-blue)}
.sched-day-btn.active{background:var(--ua-blue);color:white;border-color:var(--ua-blue)}
#sched-table th{position:sticky;top:0;background:var(--bg-card);z-index:2;font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--ua-muted);padding:8px 10px;border-bottom:1px solid var(--ua-border);white-space:nowrap}
#sched-table td{padding:6px 10px;font-size:11px;border-bottom:1px solid rgba(51,65,85,.3);white-space:nowrap}
#sched-table tr:hover{background:rgba(0,93,170,.06)}
.sched-status{display:inline-block;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:600;letter-spacing:.3px}
.sched-status.on-time,.sched-status.scheduled,.sched-status.estimated{background:rgba(34,197,94,.12);color:#22c55e}
.sched-status.landed{background:rgba(59,130,246,.12);color:#3b82f6}
.sched-status.departed,.sched-status.enroute{background:rgba(14,165,233,.12);color:#0ea5e9}
.sched-status.delayed{background:rgba(245,158,11,.15);color:#f59e0b}
.sched-status.canceled,.sched-status.diverted{background:rgba(239,68,68,.15);color:#ef4444}
.sched-status.unknown{background:rgba(100,116,139,.12);color:#94a3b8}
.sched-fleet-match{font-size:9px;color:var(--ua-green)}
.sched-fleet-miss{font-size:9px;color:var(--ua-muted)}
.sched-time-actual{font-size:9px;color:#f59e0b;margin-top:1px}
.sched-load-more{background:none;border:1px solid var(--ua-border);color:var(--ua-blue);padding:6px 16px;font-family:var(--mono);font-size:10px;cursor:pointer;border-radius:3px;margin:4px;transition:all .2s}
.sched-load-more:hover{background:rgba(0,93,170,.1);border-color:var(--ua-blue)}
.sched-load-more:disabled{opacity:.4;cursor:default}

/* Onboarding Overlay */
#onboarding-overlay{position:fixed;inset:0;background:rgba(10,14,20,.85);z-index:10000;display:flex;align-items:center;justify-content:center;opacity:0;animation:obFadeIn .4s ease forwards;backdrop-filter:blur(4px)}
#onboarding-overlay.ob-hidden{opacity:0;pointer-events:none;transition:opacity .3s ease}
#onboarding-card{background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:12px;max-width:480px;width:90%;padding:32px;text-align:center;box-shadow:0 0 60px rgba(0,93,170,.15)}
#onboarding-card h2{font-size:20px;color:#fff;margin-bottom:6px;letter-spacing:.5px}
.onboarding-subtitle{color:var(--ua-muted);font-size:12px;margin-bottom:24px}
.onboarding-features{text-align:left;display:flex;flex-direction:column;gap:12px;margin-bottom:24px}
.onboarding-feature{display:flex;align-items:flex-start;gap:12px;font-size:12px;line-height:1.5}
.onboarding-icon{font-size:18px;flex-shrink:0;margin-top:1px}
.onboarding-feature strong{color:var(--ua-accent);display:block}
.onboarding-desc{color:var(--ua-muted);display:block}
.onboarding-footer{color:var(--ua-muted);font-size:10px;margin-bottom:20px;opacity:.7}
#onboarding-dismiss{background:var(--ua-blue);color:#fff;border:none;padding:10px 28px;border-radius:6px;font-family:var(--mono);font-size:13px;font-weight:600;cursor:pointer;letter-spacing:.5px;transition:background .2s}
#onboarding-dismiss:hover{background:#0070cc}
#onboarding-help{background:none;border:1px solid var(--ua-border);color:var(--ua-muted);width:22px;height:22px;border-radius:50%;font-family:var(--mono);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;padding:0;line-height:1}
#onboarding-help:hover{border-color:var(--ua-blue);color:var(--ua-accent)}
@keyframes obFadeIn{from{opacity:0}to{opacity:1}}
@media(max-width:500px){#onboarding-card{padding:24px 18px}#onboarding-card h2{font-size:17px}}

/* Hub Health Bar */
#hub-health-bar{background:var(--ua-panel);border-bottom:1px solid var(--ua-border);padding:6px 16px;font-size:10px;display:flex;align-items:center;gap:4px;flex-wrap:wrap;overflow:hidden;flex-shrink:0}
#hub-health-bar .hh-label{color:var(--ua-blue);font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-right:4px;font-size:9px;white-space:nowrap}
#hub-health-bar .hh-explainer{color:var(--ua-muted);font-size:8px;margin-right:4px;white-space:nowrap}
#hub-health-bar .hh-info{color:var(--ua-muted);font-size:9px;cursor:pointer;margin-right:8px;opacity:.6;position:relative;border:1px solid var(--ua-border);border-radius:50%;width:14px;height:14px;display:inline-flex;align-items:center;justify-content:center;line-height:1}
#hub-health-bar .hh-info:hover{opacity:1;color:var(--ua-accent)}
#hub-health-bar .hh-tooltip{display:none;position:absolute;top:20px;left:0;background:rgba(17,24,39,.95);border:1px solid var(--ua-border);border-radius:4px;padding:8px 10px;font-size:9px;color:var(--ua-text);white-space:normal;width:260px;z-index:9999;line-height:1.4;backdrop-filter:blur(8px)}
#hub-health-bar .hh-info:hover .hh-tooltip{display:block}
.hh-hub{display:inline-flex;align-items:center;gap:3px;padding:2px 6px;border-radius:3px;white-space:nowrap}
.hh-hub .hh-code{font-weight:700;color:var(--ua-text)}
.hh-hub .hh-pct{font-weight:600}
.hh-sep{color:var(--ua-border);margin:0 2px}

/* Equipment Change Badge */
.equip-change-badge{display:inline-block;background:rgba(245,158,11,.15);color:#f59e0b;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:600;margin-top:2px}
#equip-change-summary{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:4px;padding:6px 12px;margin:4px 16px;font-size:10px;color:#f59e0b;display:none}

/* Fleet Enrichment Tooltip */
.fleet-enrich-icon{cursor:pointer;color:var(--ua-accent);font-size:10px;margin-left:3px;opacity:.7;transition:opacity .15s}
.fleet-enrich-icon:hover{opacity:1}
.fleet-enrich-detail{background:rgba(0,93,170,.08);border:1px solid rgba(0,93,170,.2);border-radius:4px;padding:6px 8px;margin-top:4px;font-size:9px;line-height:1.6;display:none}
.fleet-enrich-detail.show{display:block}
.fleet-enrich-inline{font-size:9px;color:var(--ua-muted);margin-top:1px}

/* IRROPS Monitor */
#irrops-section{padding:16px;border-bottom:1px solid var(--ua-border)}
#irrops-section h3{font-size:13px;color:#f59e0b;margin-bottom:12px}
.irrops-metrics{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:14px}
.irrops-card{background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:6px;padding:10px;text-align:center}
.irrops-card .iv{font-size:22px;font-weight:700}
.irrops-card .il{font-size:9px;color:var(--ua-muted);text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.irrops-score{display:inline-block;padding:4px 12px;border-radius:4px;font-size:16px;font-weight:700;margin-bottom:10px}
.irrops-score.low{background:rgba(34,197,94,.15);color:#22c55e}
.irrops-score.med{background:rgba(245,158,11,.15);color:#f59e0b}
.irrops-score.high{background:rgba(239,68,68,.15);color:#ef4444}
.irrops-worst{margin-top:10px}
.irrops-worst h4{font-size:10px;color:var(--ua-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.irrops-worst-row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(30,41,59,.3);font-size:10px}
.irrops-empty{text-align:center;padding:30px;color:var(--ua-muted);font-size:11px}

/* FAA Delay Context */
.faa-delay-context{font-size:9px;color:#f59e0b;font-style:italic;margin-top:2px;opacity:.85}

/* Flight Watch */
.watch-btn{background:none;border:1px solid var(--ua-border);color:var(--ua-muted);padding:2px 6px;border-radius:3px;cursor:pointer;font-size:10px;font-family:var(--mono);transition:all .15s}
.watch-btn:hover{border-color:var(--ua-accent);color:var(--ua-accent)}
.watch-btn.watching{border-color:#f59e0b;color:#f59e0b;background:rgba(245,158,11,.1)}
.share-btn{background:none;border:1px solid var(--ua-border);color:var(--ua-muted);padding:2px 6px;border-radius:3px;cursor:pointer;font-size:10px;font-family:var(--mono);transition:all .15s}
.share-btn:hover{border-color:var(--ua-accent);color:var(--ua-accent)}
.share-btn.copied{border-color:#22c55e;color:#22c55e}
#push-prompt{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(17,24,39,.97);border:1px solid var(--ua-border);border-radius:8px;padding:12px 16px;font-size:11px;color:var(--ua-text);z-index:10001;display:none;align-items:center;gap:10px;backdrop-filter:blur(12px);box-shadow:0 8px 32px rgba(0,0,0,.5);max-width:400px;font-family:var(--mono)}
#push-prompt.show{display:flex}
#push-prompt button{padding:4px 10px;border-radius:3px;cursor:pointer;font-family:var(--mono);font-size:10px;border:1px solid}
#push-prompt .pp-enable{background:var(--ua-blue);color:#fff;border-color:var(--ua-blue)}
#push-prompt .pp-dismiss{background:none;color:var(--ua-muted);border-color:var(--ua-border)}
#watch-header-btn{position:relative;background:none;border:1px solid var(--ua-border);color:var(--ua-muted);padding:3px 8px;border-radius:4px;cursor:pointer;font-family:var(--mono);font-size:11px;transition:all .15s}
#watch-header-btn:hover{border-color:var(--ua-accent);color:var(--ua-accent)}
.watch-badge{position:absolute;top:-4px;right:-4px;background:var(--ua-red);color:#fff;font-size:8px;font-weight:700;padding:1px 4px;border-radius:6px;min-width:14px;text-align:center}
#watch-panel{display:none;position:absolute;top:36px;right:0;background:rgba(17,24,39,.97);border:1px solid var(--ua-border);border-radius:6px;width:340px;max-height:400px;overflow-y:auto;z-index:9999;backdrop-filter:blur(12px);box-shadow:0 8px 32px rgba(0,0,0,.5)}
#watch-panel.show{display:block}
.watch-panel-header{padding:10px 12px;border-bottom:1px solid var(--ua-border);font-size:10px;color:var(--ua-blue);font-weight:700;text-transform:uppercase;letter-spacing:1px;display:flex;justify-content:space-between;align-items:center}
.watch-flight-item{padding:8px 12px;border-bottom:1px solid rgba(30,41,59,.3);font-size:10px;display:flex;justify-content:space-between;align-items:center}
.watch-flight-item:hover{background:rgba(0,93,170,.06)}
.watch-flight-info .wf-num{font-weight:700;color:var(--ua-accent);font-size:11px}
.watch-flight-info .wf-route{color:var(--ua-muted)}
.watch-flight-status{text-align:right}
.watch-remove{background:none;border:none;color:var(--ua-muted);cursor:pointer;font-size:12px;margin-left:6px;padding:2px}
.watch-remove:hover{color:var(--ua-red)}
#watch-notification{position:fixed;top:0;left:0;right:0;background:rgba(0,93,170,.95);color:#fff;padding:10px 16px;font-size:12px;font-weight:600;z-index:10000;display:none;align-items:center;justify-content:space-between;backdrop-filter:blur(8px)}
#watch-notification.show{display:flex}
#watch-notification .wn-dismiss{background:none;border:1px solid rgba(255,255,255,.3);color:#fff;padding:4px 10px;border-radius:3px;cursor:pointer;font-family:var(--mono);font-size:10px}
</style>
</head>
<body>
<!-- ONBOARDING OVERLAY -->
<div id="onboarding-overlay">
  <div id="onboarding-card">
    <h2>Welcome to The Blue Board ✈️</h2>
    <p class="onboarding-subtitle">Your real-time command center for United flights</p>
    <div class="onboarding-features">
      <div class="onboarding-feature"><span class="onboarding-icon">📡</span><div><strong>Live Map</strong><span class="onboarding-desc">See where every United flight is right now — updated every 30 seconds</span></div></div>
      <div class="onboarding-feature"><span class="onboarding-icon">⚠️</span><div><strong>Delays &amp; Disruptions</strong><span class="onboarding-desc">Know before the app does — hub delays, cancellations, and ground stops at a glance</span></div></div>
      <div class="onboarding-feature"><span class="onboarding-icon">📅</span><div><strong>Schedules</strong><span class="onboarding-desc">Departures &amp; arrivals at all 9 hubs with on-time stats and equipment swap alerts</span></div></div>
      <div class="onboarding-feature"><span class="onboarding-icon">🌦</span><div><strong>Weather &amp; Hub Status</strong><span class="onboarding-desc">Conditions at every hub airport — radar, visibility, wind, and how it's affecting flights</span></div></div>
      <div class="onboarding-feature"><span class="onboarding-icon">✈️</span><div><strong>Fleet &amp; WiFi</strong><span class="onboarding-desc">Check if your plane has Starlink WiFi, seat config, and aircraft details</span></div></div>
      <div class="onboarding-feature"><span class="onboarding-icon">📊</span><div><strong>Stats</strong><span class="onboarding-desc">Fleet utilization, route patterns, and network health — the truly nerdy stuff</span></div></div>
    </div>
    <p class="onboarding-footer">Built by a United flyer, for United flyers. Not affiliated with United Airlines.</p>
    <button id="onboarding-dismiss">Let's Fly the Friendly Skies ✈️</button>
  </div>
</div>
<div id="offline-banner" aria-live="assertive" role="alert">⚠ You are offline — data may be outdated. Reconnect to see live updates.</div>
<noscript>
<div style="background:#111827;color:#e2e8f0;padding:40px;text-align:center;font-family:monospace">
<h2>The Blue Board — United Airlines Flight Tracker & Live Status</h2>
<p>Track every United Airlines flight in real time with The Blue Board — a free, independent operations dashboard. See live flight positions on an interactive map updated every 30 seconds. Check delays, cancellations, and ground stops at all 9 United hubs: Chicago O'Hare (ORD), Denver (DEN), Houston (IAH), Newark (EWR), San Francisco (SFO), Washington Dulles (IAD), Los Angeles (LAX), Tokyo Narita (NRT), and Guam (GUM). Look up any flight by number to see status, aircraft type, and route. Browse the full United fleet database of 1,175+ aircraft and check which planes have Starlink WiFi. View departure and arrival schedules with on-time performance stats and equipment swap alerts. Monitor weather conditions with radar, METAR observations, and FAA NAS alerts. Explore fleet utilization, route analytics, and hub-to-hub traffic patterns. Built for the United community. Not affiliated with United Airlines, Inc. JavaScript is required.</p>
</div>
</noscript>
<div class="sr-only">The Blue Board is a free, independent United Airlines flight tracker and operations dashboard. Track every United flight in real time on a live map updated every 30 seconds. Check if your United flight is on time, delayed, or cancelled. Monitor delays and ground stops at all 9 United hubs: Chicago O'Hare ORD, Denver DEN, Houston IAH, Newark EWR, San Francisco SFO, Washington Dulles IAD, Los Angeles LAX, Tokyo Narita NRT, and Guam GUM. Search flights by number, tail number, or route. Check which United planes have Starlink WiFi. Browse the full fleet database of 1,175+ aircraft with seat configurations and IFE details. View departure and arrival schedules with on-time performance and equipment swap alerts. Weather radar, METAR conditions, and FAA delay alerts for all hub airports. Fleet utilization analytics, hub-to-hub route flow, and network health stats. Built for the United community. Not affiliated with United Airlines, Inc.</div>
<!-- TICKER -->
<div class="ticker-wrap">
  <span class="ticker-label">▌ALERTS</span>
  <div class="ticker" id="ticker"></div>
</div>

<!-- HUB HEALTH BAR -->
<div id="hub-health-bar" aria-live="polite" title="On-Time Performance: % of operated flights departing within 30 min of schedule. 🟢 >70% · 🟡 50-70% · 🔴 <50%"><span class="hh-label">Hub Health</span><span class="hh-explainer">ON-TIME %</span><span class="hh-info">?<span class="hh-tooltip">% of operated flights departing within 30 min of schedule. 🟢 &gt;70% · 🟡 50–70% · 🔴 &lt;50%</span></span><span style="color:var(--ua-muted)">Loading…</span></div>

<!-- WATCH NOTIFICATION BANNER -->
<div id="watch-notification" aria-live="polite" role="status"><span id="wn-text"></span><button class="wn-dismiss" data-action="dismiss-watch-notification">Dismiss</button></div>
<div id="push-prompt">🔔 Get push alerts for watched flights?<div style="display:flex;gap:6px"><button class="pp-enable" data-action="enable-push">Enable</button><button class="pp-dismiss" data-action="dismiss-push">No thanks</button></div></div>

<!-- HEADER -->
<div id="header">
  <h1><a href="#" data-action="go-home" style="text-decoration:none;color:inherit;cursor:pointer"><span class="ua">THE BLUE BOARD</span></a> <span style="font-size:9px;color:var(--ua-muted);font-weight:300;letter-spacing:0.5px">COMMUNITY · FOR UNITED FLYERS, BY UNITED FLYERS</span></h1>
  <div id="global-search-wrap" style="position:relative;flex:0 1 300px">
    <input type="text" id="global-search-input" aria-label="Global flight search" placeholder="Track a flight (UA 1234, N12345, ORD...)" style="width:100%;background:rgba(15,23,41,.8);border:1px solid var(--ua-border);color:var(--ua-text);padding:6px 10px;border-radius:4px;font-family:var(--mono);font-size:11px">
    <div id="global-search-results" style="position:absolute;top:34px;left:0;right:0;background:rgba(17,24,39,.95);border:1px solid var(--ua-border);border-radius:4px;max-height:300px;overflow-y:auto;display:none;z-index:9999;backdrop-filter:blur(8px)"></div>
  </div>
  <div id="header-right">
    <span><span class="status-dot live" id="status-dot"></span><span id="status-text">LIVE</span> <span id="header-flight-count" style="color:var(--ua-muted);font-size:10px"></span></span>
    <span id="countdown">Next refresh: --:--</span>
    <span id="clock" style="color:var(--ua-muted)"></span>
    <div style="position:relative"><button id="watch-header-btn" data-action="toggle-watch-panel" title="Watched flights" aria-label="Toggle watched flights panel">👁️<span class="watch-badge" id="watch-badge" style="display:none">0</span></button><div id="watch-panel"><div class="watch-panel-header"><span>👁️ Watched Flights</span><button data-action="clear-all-watched" style="background:none;border:none;color:var(--ua-muted);cursor:pointer;font-size:9px;font-family:var(--mono)">Clear All</button></div><div id="watch-panel-list"></div></div></div>
    <button id="mobile-search-toggle" aria-label="Toggle search" title="Search">🔍</button>
    <button id="onboarding-help" title="About this dashboard" aria-label="About this dashboard">?</button>
  </div>
</div>

<!-- TAB BAR -->
<nav id="tab-bar" aria-label="Dashboard navigation" role="tablist">
  <button class="tab-btn active" data-tab="tab-live" role="tab" tabindex="0" aria-selected="true" aria-controls="tab-live"><span aria-hidden="true">📡</span> LIVE OPS</button>
  <button class="tab-btn" data-tab="tab-schedule" role="tab" tabindex="-1" aria-selected="false" aria-controls="tab-schedule"><span aria-hidden="true">📅</span> SCHEDULE</button>
  <button class="tab-btn" data-tab="tab-fleet" role="tab" tabindex="-1" aria-selected="false" aria-controls="tab-fleet"><span aria-hidden="true">✈️</span> FLEET</button>
  <button class="tab-btn" data-tab="tab-weather" role="tab" tabindex="-1" aria-selected="false" aria-controls="tab-weather"><span aria-hidden="true">🌦</span> DELAYS · WEATHER · HUBS</button>
  <button class="tab-btn" data-tab="tab-analytics" role="tab" tabindex="-1" aria-selected="false" aria-controls="tab-analytics" aria-label="Stats"><span aria-hidden="true">📊</span> STATS</button>
  <button class="tab-btn" data-tab="tab-sources" role="tab" tabindex="-1" aria-selected="false" aria-controls="tab-sources"><span aria-hidden="true">ℹ️</span> SOURCES</button>
</nav>

<!-- MOBILE BOTTOM NAV -->
<nav id="mobile-bottom-nav" aria-label="Mobile navigation">
  <button data-tab="tab-live" class="active"><span class="bnav-icon">📡</span><span class="bnav-label">Live</span></button>
  <button data-tab="tab-schedule"><span class="bnav-icon">📅</span><span class="bnav-label">Schedule</span></button>
  <button data-tab="tab-fleet"><span class="bnav-icon">✈️</span><span class="bnav-label">Fleet</span></button>
  <button data-tab="tab-weather"><span class="bnav-icon">🌦</span><span class="bnav-label">Weather</span></button>
  <button data-tab="tab-analytics" class="bnav-overflow-item"><span class="bnav-icon">📊</span><span class="bnav-label">Stats</span></button>
  <button data-tab="tab-sources" class="bnav-overflow-item"><span class="bnav-icon">ℹ️</span><span class="bnav-label">Sources</span></button>
  <button id="mobile-more-btn" aria-label="More tabs"><span class="bnav-icon">▾</span><span class="bnav-label">More</span></button>
</nav>
<div id="mobile-more-menu">
  <button data-tab="tab-analytics"><span class="bnav-icon">📊</span> Stats</button>
  <button data-tab="tab-sources"><span class="bnav-icon">ℹ️</span> Sources</button>
</div>

<!-- TAB 1: LIVE OPS -->
<main><div class="tab-content active" id="tab-live" role="tabpanel" aria-label="Live flight operations map">
  <div class="ops-layout">
    <button id="mobile-sidebar-toggle" aria-label="Toggle filters">🔍 Filters ▾</button>
    <div class="sidebar" id="sidebar">
      <h3>🏢 Hub Operations</h3>
      <div id="hub-stats"></div>
      <button id="sidebar-filters-toggle" data-action="toggle-sidebar-filters" style="width:100%;background:none;border:none;border-bottom:1px solid var(--ua-border);color:var(--ua-accent);font-family:var(--mono);font-size:10px;padding:6px 12px;cursor:pointer;text-align:center">Filters ▾</button>
      <div id="sidebar-extra-filters">
      <h3 style="margin-top:4px">🔍 Search</h3>
      <div style="padding:8px 12px">
        <input type="text" id="search-input-side" aria-label="Sidebar flight search" placeholder="Flight #, tail, airport..." style="width:100%;background:rgba(15,23,41,.8);border:1px solid var(--ua-border);color:var(--ua-text);padding:6px 8px;border-radius:4px;font-family:var(--mono);font-size:10px">
        <div id="search-results-side" style="max-height:400px;overflow-y:auto;margin-top:4px"></div>
      </div>
      <h3>📊 Phase Breakdown</h3>
      <div id="phase-stats" style="padding:8px 12px"></div>
      </div>
    </div>
    <div class="map-area">
      <div id="map"></div>
      <div id="controls">
        <button class="ctrl-btn" id="mobile-ctrl-toggle" style="display:none" aria-label="Toggle map layers">☰</button>
        <button class="ctrl-btn" data-action="toggle-hubs" id="btn-hubs">🏢 Hubs</button>
        <button class="ctrl-btn" data-action="toggle-longhaul" id="btn-longhaul">🌍 Long-haul</button>
        <button class="ctrl-btn" data-action="toggle-weather" id="btn-wx">🌧 Weather</button>
        <button class="ctrl-btn" data-action="view-pacific" id="btn-pacific">🌏 Pacific</button>
        <button class="ctrl-btn" data-action="refresh-flights" id="btn-refresh">🔄 Refresh</button>
      </div>
    </div>
  </div>
  <div id="stats-bar" aria-live="polite">
    <div class="stat-item"><span class="stat-val" id="st-airborne">--</span><span class="stat-label">Airborne</span></div>
    <span class="stat-sep">│</span>
    <div class="stat-item"><span class="stat-val" id="st-util">--</span><span class="stat-label">Utilization</span></div>
    <span class="stat-sep">│</span>
    <div class="stat-item"><span class="stat-val" id="st-starlink">--</span><span class="stat-label">⚡ Starlink</span></div>
    <span class="stat-sep">│</span>
    <div class="stat-item"><span class="stat-val" id="st-climb">--</span><span class="stat-label">Climbing</span></div>
    <span class="stat-sep">│</span>
    <div class="stat-item"><span class="stat-val" id="st-cruise">--</span><span class="stat-label">Cruising</span></div>
    <span class="stat-sep">│</span>
    <div class="stat-item"><span class="stat-val" id="st-desc">--</span><span class="stat-label">Descending</span></div>
    <span class="stat-sep">│</span>
    <div class="stat-item"><span class="stat-val" id="st-ground">--</span><span class="stat-label">Ground</span></div>
    <span class="stat-sep">│</span>
    <div class="stat-item"><span class="stat-val" id="st-avgalt">--</span><span class="stat-label">Avg Alt</span></div>
    <span class="stat-sep">│</span>
    <div class="stat-item"><span class="stat-val" id="st-avgspd">--</span><span class="stat-label">Avg Spd</span></div>
  </div>
</div>

<!-- TAB 2: SCHEDULE -->
<div class="tab-content" id="tab-schedule" role="tabpanel" aria-label="Flight schedule">
  <div class="card" style="margin-bottom:0;padding:12px 16px">
    <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:12px">
        <h3 style="font-size:10px;color:var(--ua-blue);text-transform:uppercase;letter-spacing:1.5px;margin:0">📅 Flight Schedule</h3>
        <div id="sched-day-btns" style="display:flex;gap:4px">
          <button class="sched-day-btn" data-day="-1">Yesterday</button>
          <button class="sched-day-btn active" data-day="0">Today</button>
          <button class="sched-day-btn" data-day="1">Tomorrow</button>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <select id="sched-hub" aria-label="Schedule hub filter" style="background:var(--bg-card);color:var(--ua-text);border:1px solid var(--ua-border);padding:4px 8px;font-family:var(--mono);font-size:10px;border-radius:3px">
          <option value="">All Hubs</option>
          <option value="ORD" selected>ORD — Chicago O'Hare</option>
          <option value="DEN">DEN — Denver</option>
          <option value="IAH">IAH — Houston</option>
          <option value="EWR">EWR — Newark</option>
          <option value="SFO">SFO — San Francisco</option>
          <option value="IAD">IAD — Washington Dulles</option>
          <option value="LAX">LAX — Los Angeles</option>
          <option value="NRT">NRT — Tokyo Narita</option>
          <option value="GUM">GUM — Guam</option>
        </select>
        <select id="sched-dir" aria-label="Schedule direction filter" style="background:var(--bg-card);color:var(--ua-text);border:1px solid var(--ua-border);padding:4px 8px;font-family:var(--mono);font-size:10px;border-radius:3px">
          <option value="departures">Departures</option>
          <option value="arrivals">Arrivals</option>
        </select>
        <button id="sched-refresh-btn" data-action="schedule-refresh" style="background:var(--ua-blue);color:white;border:none;padding:4px 10px;font-family:var(--mono);font-size:10px;border-radius:3px;cursor:pointer">↻ Refresh</button>
        <button id="sched-more-filters-btn" data-action="schedule-more-filters" style="background:none;border:1px solid var(--ua-border);color:var(--ua-muted);padding:4px 10px;font-family:var(--mono);font-size:10px;border-radius:3px;cursor:pointer">More Filters ▾</button>
        <div id="sched-adv-filters" style="display:none;align-items:center;gap:8px;flex-wrap:wrap">
        <select id="sched-status" aria-label="Schedule status filter" style="background:var(--bg-card);color:var(--ua-text);border:1px solid var(--ua-border);padding:4px 8px;font-family:var(--mono);font-size:10px;border-radius:3px">
          <option value="">All Status</option>
          <option value="scheduled">Scheduled</option>
          <option value="estimated">Estimated</option>
          <option value="departed">Departed</option>
          <option value="enroute">En Route</option>
          <option value="landed">Landed</option>
          <option value="delayed">Delayed</option>
          <option value="canceled">Canceled</option>
          <option value="diverted">Diverted</option>
        </select>
        <select id="sched-aircraft" aria-label="Schedule aircraft filter" style="background:var(--bg-card);color:var(--ua-text);border:1px solid var(--ua-border);padding:4px 8px;font-family:var(--mono);font-size:10px;border-radius:3px">
          <option value="">All Aircraft</option>
        </select>
        <input type="text" id="sched-search" aria-label="Schedule search" placeholder="Flight, city, reg..." style="background:var(--bg-card);color:var(--ua-text);border:1px solid var(--ua-border);padding:4px 8px;font-family:var(--mono);font-size:10px;border-radius:3px;width:140px">
        </div>
      </div>
    </div>
  </div>
  <div id="equip-change-summary"></div>
  <div id="sched-stats" class="metric-row" style="margin:8px 0"></div>
  <div class="card" style="padding:0;overflow:hidden">
    <div id="sched-loading" style="text-align:center;padding:40px;color:var(--ua-muted);font-size:12px">
      <div style="font-size:24px;margin-bottom:8px">📅</div>
      Select a hub and click Refresh to load schedule data
    </div>
    <div class="fleet-table-wrap" style="max-height:calc(100vh - 260px);display:none" id="sched-table-wrap">
      <table id="sched-table">
        <thead>
          <tr>
            <th data-sort="time" style="cursor:pointer;min-width:100px">Time ↕</th>
            <th data-sort="flight" style="cursor:pointer">Flight ↕</th>
            <th data-sort="route" style="cursor:pointer;min-width:140px">Route</th>
            <th data-sort="aircraft" style="cursor:pointer">Aircraft</th>
            <th data-sort="reg" style="cursor:pointer">Reg</th>
            <th>Gate</th>
            <th data-sort="status" style="cursor:pointer;min-width:130px">Status ↕</th>
            <th>Fleet</th>
            <th>👁️</th>
          </tr>
        </thead>
        <tbody id="sched-tbody"></tbody>
      </table>
    </div>
  </div>
  <div id="sched-pagination" style="display:none;text-align:center;padding:8px;font-size:10px;color:var(--ua-muted)"></div>
  <div id="sched-tz-footer" style="font-size:9px;color:var(--ua-muted);text-align:center;padding:6px 0">Schedule data via <a href="https://www.flightradar24.com" target="_blank" rel="noopener noreferrer" style="color:var(--ua-green)">Flightradar24</a> · United flights only · Times in local airport timezone</div>
</div>

<!-- TAB 3: FLEET -->
<div class="tab-content" id="tab-fleet" role="tabpanel" aria-label="Fleet information">
  <!-- Crawlable fleet summary for SEO — visible to screen readers and search engines -->
  <section class="sr-only" aria-label="United Airlines Fleet Summary">
    <h2>United Airlines Fleet Database — 1,078 Aircraft</h2>
    <p>Complete searchable database of all 1,078 United Airlines mainline aircraft across 19 types: Boeing 737-700 (40), 737-800 (141), 737-900 (12), 737-900ER (136), 737 MAX 8 (123), 737 MAX 9 (129), 757-200 (40), 757-300 (21), 767-300ER (37), 767-400ER (16), 777-200 (19), 777-200ER (55), 777-300ER (22), 787-8 (12), 787-9 (48), 787-10 (21), and Airbus A319 (76), A320 (68), A321neo (62). Includes registration, seat configuration, WiFi type, IFE system, delivery date, and operational status. 258 aircraft equipped with SpaceX Starlink satellite WiFi. Live fleet utilization updated every 30 seconds. <a href="/fleet">View full fleet database</a>.</p>
  </section>
  <div class="live-fleet-panel" id="live-fleet-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 style="font-size:10px;color:var(--ua-blue);text-transform:uppercase;letter-spacing:1.5px;margin:0">🛩 Live Fleet Status</h3>
      <div style="display:flex;align-items:center;gap:8px"><span class="live-badge"><span class="pulse-dot"></span> LIVE</span><span id="fleet-live-time" style="font-size:9px;color:var(--ua-muted)"></span></div>
    </div>
    <div id="fleet-live-content"><div style="color:var(--ua-muted);font-size:11px;padding:20px 0;text-align:center">Loading live fleet data...<br><button class="retry-btn" data-action="refresh-flights" style="margin-top:8px">⏳ Load Now</button></div></div>
  </div>
  <div class="card">
    <h3 id="fleet-overview-title">Fleet Overview</h3>
    <div class="fleet-chips" id="fleet-chips"></div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
      <div style="flex:1;background:var(--ua-border);height:4px;border-radius:2px;overflow:hidden">
        <div id="starlink-progress" style="height:100%;background:var(--ua-green);border-radius:2px;transition:width .5s"></div>
      </div>
      <span id="starlink-pct" style="font-size:10px;color:var(--ua-green);font-weight:700"></span>
      <span style="font-size:9px;color:var(--ua-muted)">Starlink Equipped</span>
    </div>
  </div>
  <div class="two-col">
    <div class="card">
      <h3>Fleet Delivery Timeline</h3>
      <div style="font-size:9px;color:var(--ua-muted);margin-bottom:4px">Aircraft deliveries by year · colored by family</div>
      <div id="age-chart" style="position:relative"></div>
      <div id="age-stats" style="font-size:10px;color:var(--ua-muted);margin-top:6px"></div>
    </div>
    <div class="card">
      <h3>Seat Configuration</h3>
      <div id="config-display"></div>
    </div>
  </div>
  <div class="card">
    <h3>Aircraft Database</h3>
    <div style="font-size:10px;color:var(--ua-muted);margin-bottom:8px">Fleet data via <a href="https://sites.google.com/site/unitedfleetsite/mainline-fleet-tracking" target="_blank" rel="noopener noreferrer" style="color:var(--ua-green)">United Fleet Site</a>, updated daily</div>
    <div class="fleet-controls">
      <select id="fleet-filter-type" aria-label="Fleet type filter"><option value="">All Types</option></select>
      <select id="fleet-filter-wifi" aria-label="Fleet WiFi filter"><option value="">All WiFi</option></select>
      <select id="fleet-filter-status" aria-label="Fleet status filter"><option value="">All Status</option><option value="active">Active</option><option value="stored">Stored/Maint</option><option value="starlink">⚡ Starlink</option></select>
      <input type="text" id="fleet-search" aria-label="Fleet search" placeholder="Search reg, config...">
      <button class="refresh-btn" data-action="refresh-fleet-data">↻ Refresh Fleet Data</button>
    </div>
    <div class="fleet-table-wrap">
      <table id="fleet-table">
        <thead><tr><th data-sort="r">Reg ↕</th><th data-sort="t">Type ↕</th><th data-sort="a">AC# ↕</th><th data-sort="c">Config</th><th data-sort="tot">Seats ↕</th><th data-sort="w">WiFi</th><th data-sort="i">IFE</th><th data-sort="d">Del ↕</th><th data-sort="s">Status</th><th>⚡</th></tr></thead>
        <tbody id="fleet-tbody"></tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <h3>⚡ Starlink Tracker — <span id="starlink-count">258</span> Aircraft</h3>
    <div style="font-size:10px;color:var(--ua-muted);margin-bottom:8px">Starlink data via <a href="https://unitedstarlinktracker.com" target="_blank" rel="noopener noreferrer" style="color:var(--ua-green)">unitedstarlinktracker.com</a>, updated daily</div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
      <input type="text" id="starlink-search" aria-label="Search Starlink aircraft" placeholder="Search tail..." style="background:var(--bg-card);color:var(--ua-text);border:1px solid var(--ua-border);padding:4px 8px;font-family:var(--mono);font-size:10px;border-radius:3px;width:120px">
      <select id="starlink-filter-fleet" aria-label="Starlink fleet filter" style="background:var(--bg-card);color:var(--ua-text);border:1px solid var(--ua-border);padding:4px 6px;font-family:var(--mono);font-size:10px;border-radius:3px"><option value="">All Fleets</option><option value="Mainline">Mainline</option><option value="Express">Express</option></select>
      <select id="starlink-filter-type" aria-label="Starlink type filter" style="background:var(--bg-card);color:var(--ua-text);border:1px solid var(--ua-border);padding:4px 6px;font-family:var(--mono);font-size:10px;border-radius:3px"><option value="">All Types</option></select>
      <select id="starlink-filter-operator" aria-label="Starlink operator filter" style="background:var(--bg-card);color:var(--ua-text);border:1px solid var(--ua-border);padding:4px 6px;font-family:var(--mono);font-size:10px;border-radius:3px"><option value="">All Operators</option></select>
      <span id="starlink-filtered-count" style="font-size:9px;color:var(--ua-muted);align-self:center"></span>
    </div>
    <div class="fleet-table-wrap" style="max-height:400px">
      <table id="starlink-table">
        <thead><tr><th data-starlink-sort="tail" style="cursor:pointer">Tail ↕</th><th data-starlink-sort="fleet" style="cursor:pointer">Fleet ↕</th><th data-starlink-sort="type" style="cursor:pointer">Type ↕</th><th data-starlink-sort="operator" style="cursor:pointer">Operator ↕</th></tr></thead>
        <tbody id="starlink-tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- TAB 3: WEATHER -->
<div class="tab-content" id="tab-weather" role="tabpanel" aria-label="Delays, weather, and hub status">
  <div class="wx-hero">
    <h3 id="radar-title">🌧 NEXRAD Radar</h3>
    <div id="radar-map"></div>
  </div>
  <div class="wx-legend">
    <div class="wx-legend-item"><span class="wx-legend-dot" style="background:#22c55e"></span>VFR</div>
    <div class="wx-legend-item"><span class="wx-legend-dot" style="background:#eab308"></span>MVFR</div>
    <div class="wx-legend-item"><span class="wx-legend-dot" style="background:#ef4444"></span>IFR</div>
    <div class="wx-legend-item"><span class="wx-legend-dot" style="background:#c026d3"></span>LIFR</div>
  </div>
  <!-- IRROPS Monitor -->
  <div id="irrops-section">
    <h3>⚠️ IRROPS Monitor</h3>
    <div id="irrops-content" aria-live="polite"><div class="irrops-empty" style="color:var(--ua-muted);font-size:10px">Loading IRROPS data…</div></div>
  </div>
  <div class="hub-cards" id="hub-cards"></div>
</div>

<!-- TAB 4: ANALYTICS -->
<div class="tab-content" id="tab-analytics" role="tabpanel" aria-label="Analytics and statistics">
  <div class="metric-row" id="analytics-metrics"></div>
  <div class="two-col">
    <div class="card">
      <h3>✈️ Live Fleet Utilization</h3>
      <div style="font-size:9px;color:var(--ua-muted);margin-bottom:8px">Airborne now vs. total fleet · updates every 30s</div>
      <div id="util-chart"></div>
    </div>
    <div class="card">
      <h3>🛫 Airborne by Flight Phase</h3>
      <div style="font-size:9px;color:var(--ua-muted);margin-bottom:8px">Current phase distribution · updates every 30s</div>
      <div id="phase-chart"></div>
    </div>
  </div>
  <div class="card">
    <h3>🔥 Hub-to-Hub Flow Matrix</h3>
    <div style="font-size:9px;color:var(--ua-muted);margin-bottom:8px">Active flights between UA hubs · darker = more traffic</div>
    <div id="hub-matrix" style="overflow-x:auto"></div>
  </div>
  <div class="two-col">
    <div class="card">
      <h3>📈 Top Routes Right Now</h3>
      <div id="route-heatmap" style="min-height:200px"></div>
    </div>
    <div class="card">
      <h3>📅 Average Fleet Age by Type</h3>
      <div id="avg-age-chart"></div>
    </div>
  </div>
</div>

<!-- TAB 5: SOURCES -->
<div class="tab-content" id="tab-sources" role="tabpanel" aria-label="Data sources and credits">
  <h2 style="font-size:16px;margin-bottom:16px;color:var(--ua-accent)">📋 Data Sources & Credits</h2>

  <div class="source-item">
    <div class="source-icon">📡</div>
    <div>
      <div class="source-name">Flight Data — Flightradar24 <span class="freshness fresh-live">LIVE</span></div>
      <div class="source-desc">Real-time flight tracking with registration, origin, destination, aircraft type, and flight number. Updates every 30 seconds.</div>
      <a class="source-link" href="https://www.flightradar24.com" target="_blank" rel="noopener noreferrer">flightradar24.com →</a>
    </div>
  </div>

  <div class="source-item">
    <div class="source-icon">📅</div>
    <div>
      <div class="source-name">Flight Schedule — Flightradar24 <span class="freshness fresh-live">LIVE</span></div>
      <div class="source-desc">Airport departure/arrival schedules with status, gate, terminal, and aircraft info.</div>
      <a class="source-link" href="https://www.flightradar24.com" target="_blank" rel="noopener noreferrer">flightradar24.com →</a>
    </div>
  </div>

  <div class="source-item">
    <div class="source-icon">✈️</div>
    <div>
      <div class="source-name">Fleet Database — United Fleet Site <span class="freshness fresh-daily">DAILY</span></div>
      <div class="source-desc">Comprehensive fleet data: mainline aircraft with type, config, WiFi, IFE, seats, delivery year.</div>
      <a class="source-link" href="https://sites.google.com/site/unitedfleetsite/" target="_blank" rel="noopener noreferrer">United Fleet Site →</a>
      <a class="source-link" href="https://docs.google.com/spreadsheets/d/1ZlYgN_IZmd6CSx_nXnuP0L0PiodapDRx3RmNkIpxXAo" target="_blank" rel="noopener noreferrer" style="margin-left:12px">Google Sheet →</a>
    </div>
  </div>

  <div class="source-item">
    <div class="source-icon">⚡</div>
    <div>
      <div class="source-name">Starlink Tracker — @martinamps <span class="freshness fresh-daily">DAILY</span></div>
      <div class="source-desc">258 Starlink-equipped United aircraft. Community-maintained tracker.</div>
      <a class="source-link" href="https://github.com/martinamps/ua-starlink-tracker" target="_blank" rel="noopener noreferrer">github.com/martinamps/ua-starlink-tracker →</a>
      <a class="source-link" href="https://unitedstarlinktracker.com" target="_blank" rel="noopener noreferrer" style="margin-left:12px">unitedstarlinktracker.com →</a>
    </div>
  </div>

  <div class="source-item">
    <div class="source-icon">🌦</div>
    <div>
      <div class="source-name">Aviation Weather — AWC <span class="freshness fresh-live">LIVE</span></div>
      <div class="source-desc">METAR observations and TAF forecasts for hub airports.</div>
      <a class="source-link" href="https://aviationweather.gov" target="_blank" rel="noopener noreferrer">aviationweather.gov →</a>
    </div>
  </div>

  <div class="source-item">
    <div class="source-icon">🌧</div>
    <div>
      <div class="source-name">NEXRAD Radar — Iowa State / NWS <span class="freshness fresh-live">LIVE</span></div>
      <div class="source-desc">Composite NEXRAD radar imagery overlaid on maps.</div>
      <a class="source-link" href="https://mesonet.agron.iastate.edu" target="_blank" rel="noopener noreferrer">Iowa State Mesonet →</a>
    </div>
  </div>

  <div class="source-item">
    <div class="source-icon">🏛</div>
    <div>
      <div class="source-name">NAS Status — FAA <span class="freshness fresh-live">LIVE</span></div>
      <div class="source-desc">National Airspace System status, ground stops, delays, and TFRs.</div>
      <a class="source-link" href="https://nasstatus.faa.gov" target="_blank" rel="noopener noreferrer">nasstatus.faa.gov →</a>
    </div>
  </div>

  <div class="source-item">
    <div class="source-icon">🛠</div>
    <div>
      <div class="source-name">Route Estimation — Algorithmic</div>
      <div class="source-desc">Origin/destination airports estimated using aircraft position, heading, and nearest airport matching. Routes marked as "estimated" — not from flight plans.</div>
      <span class="freshness fresh-static">COMPUTED</span>
    </div>
  </div>

  <h2 style="font-size:14px;margin:24px 0 12px;color:var(--ua-accent)">🤝 Community</h2>

  <div class="source-item">
    <div class="source-icon">💬</div>
    <div>
      <div class="source-name">r/UnitedAirlines</div>
      <div class="source-desc">The United Airlines community on Reddit — news, trip reports, MileagePlus discussion, and more.</div>
      <a class="source-link" href="https://www.reddit.com/r/UnitedAirlines/" target="_blank" rel="noopener noreferrer">reddit.com/r/UnitedAirlines →</a>
    </div>
  </div>

  <div style="margin-top:20px;padding:12px;background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:6px;font-size:10px;color:var(--ua-muted);line-height:1.6">
    <strong style="color:var(--ua-accent)">Disclaimer:</strong> This dashboard is an independent project and is not affiliated with, endorsed by, or connected to United Airlines, Inc. All trademarks belong to their respective owners. Flight tracking data is sourced from publicly available ADS-B receivers. Route estimates are algorithmic approximations and may not reflect actual flight plans.
  </div>
</div>

<script>

// ═══════════════════════════════════════════════
// HUB LIST — CANONICAL REFERENCE
// All 9 United hubs: ORD, DEN, IAH, EWR, SFO, IAD, LAX, NRT, GUM
// When adding/removing a hub, update ALL of these locations:
//   1. AIRPORTS array (hub:true entries) — ~line 1010
//   2. hubCodes in updateHubHealth() — search "hubCodes"
//   3. SCHED_HUB_TZ — search "SCHED_HUB_TZ"
//   4. preloadHubs in schedule init — search "preloadHubs"
//   5. hubs arrays in hub health bar render — search "const hubs = ["
//   6. HUBS in api/irrops.js
//   7. Hub health bar HTML (#hub-health-bar)
//   8. public/sitemap.xml
//   9. public/hubs/*.html (individual hub pages + nav in each)
//  10. Schema/SEO in <head> of this file
// ═══════════════════════════════════════════════

// ═══ DEBOUNCE UTILITY ═══
function debounce(fn, ms) { let t; return function(...a) { clearTimeout(t); t = setTimeout(() => fn.apply(this, a), ms); }; }

// ═══ HTML SANITIZATION ═══
function escapeHtml(str) {
  if (typeof str !== 'string') return str;
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// ═══════════════════════════════════════════════
// EMBEDDED DATA
// ═══════════════════════════════════════════════

let FLEET_DB = [];
let STARLINK_DB = [];
let STARLINK_TAILS = new Set();

// Build registration lookup
const FLEET_BY_REG = {};

async function loadFleetData() {
  try {
    const [fleetRes, starlinkRes] = await Promise.all([
      fetch('/data/fleet.json'),
      fetch('/data/starlink.json')
    ]);
    if (!fleetRes.ok || !starlinkRes.ok) throw new Error('Fleet data load failed');
    FLEET_DB = await fleetRes.json();
    STARLINK_DB = await starlinkRes.json();
  } catch (err) {
    console.error('Fleet data load error:', err);
    FLEET_DB = [];
    STARLINK_DB = [];
  }

  STARLINK_TAILS = new Set(STARLINK_DB.map(s => s.tail));
  Object.keys(FLEET_BY_REG).forEach(key => delete FLEET_BY_REG[key]);
  FLEET_DB.forEach(a => { FLEET_BY_REG[a.r] = a; });
}

// ═══ AIRPORT DATABASE (150 airports) ═══
const AIRPORTS = [
  // United Hubs
  {iata:"EWR",lat:40.6925,lon:-74.1687,hub:true},{iata:"IAH",lat:29.9844,lon:-95.3414,hub:true},
  {iata:"ORD",lat:41.9742,lon:-87.9073,hub:true},{iata:"DEN",lat:39.8561,lon:-104.6737,hub:true},
  {iata:"SFO",lat:37.6213,lon:-122.3790,hub:true},{iata:"LAX",lat:33.9425,lon:-118.4081,hub:true},
  {iata:"IAD",lat:38.9531,lon:-77.4565,hub:true},
  // Major US
  {iata:"ATL",lat:33.6407,lon:-84.4277},{iata:"DFW",lat:32.8998,lon:-97.0403},
  {iata:"JFK",lat:40.6413,lon:-73.7781},{iata:"LGA",lat:40.7769,lon:-73.8740},
  {iata:"SEA",lat:47.4502,lon:-122.3088},{iata:"BOS",lat:42.3656,lon:-71.0096},
  {iata:"PHX",lat:33.4373,lon:-112.0078},{iata:"MCO",lat:28.4312,lon:-81.3081},
  {iata:"CLT",lat:35.2140,lon:-80.9431},{iata:"MIA",lat:25.7959,lon:-80.2870},
  {iata:"FLL",lat:26.0742,lon:-80.1506},{iata:"MSP",lat:44.8848,lon:-93.2223},
  {iata:"DTW",lat:42.2162,lon:-83.3554},{iata:"PHL",lat:39.8744,lon:-75.2424},
  {iata:"SLC",lat:40.7899,lon:-111.9791},{iata:"SAN",lat:32.7338,lon:-117.1933},
  {iata:"TPA",lat:27.9755,lon:-82.5332},{iata:"PDX",lat:45.5898,lon:-122.5951},
  {iata:"BNA",lat:36.1263,lon:-86.6774},{iata:"STL",lat:38.7487,lon:-90.3700},
  {iata:"AUS",lat:30.1975,lon:-97.6664},{iata:"RDU",lat:35.8801,lon:-78.7880},
  {iata:"MCI",lat:39.2976,lon:-94.7139},{iata:"SMF",lat:38.6954,lon:-121.5908},
  {iata:"SJC",lat:37.3626,lon:-121.9290},{iata:"OAK",lat:37.7213,lon:-122.2208},
  {iata:"CLE",lat:41.4117,lon:-81.8498},{iata:"CMH",lat:39.9980,lon:-82.8919},
  {iata:"PIT",lat:40.4915,lon:-80.2329},{iata:"IND",lat:39.7173,lon:-86.2944},
  {iata:"MKE",lat:42.9472,lon:-87.8966},{iata:"RSW",lat:26.5362,lon:-81.7552},
  {iata:"JAX",lat:30.4941,lon:-81.6879},{iata:"BDL",lat:41.9389,lon:-72.6832},
  {iata:"ABQ",lat:35.0402,lon:-106.6090},{iata:"ONT",lat:34.0560,lon:-117.6012},
  {iata:"BUR",lat:34.2005,lon:-118.3585},{iata:"HNL",lat:21.3187,lon:-157.9225},
  {iata:"OGG",lat:20.8986,lon:-156.4305},{iata:"KOA",lat:19.7388,lon:-156.0456},
  {iata:"LIH",lat:21.9760,lon:-159.3390},{iata:"ANC",lat:61.1743,lon:-149.9962},
  {iata:"SNA",lat:33.6757,lon:-117.8682},{iata:"DAL",lat:32.8471,lon:-96.8518},
  {iata:"HOU",lat:29.6454,lon:-95.2789},{iata:"MDW",lat:41.7868,lon:-87.7522},
  {iata:"BWI",lat:39.1754,lon:-76.6683},{iata:"DCA",lat:38.8512,lon:-77.0402},
  {iata:"MSY",lat:29.9934,lon:-90.2580},{iata:"RNO",lat:39.4991,lon:-119.7681},
  {iata:"LAS",lat:36.0840,lon:-115.1537},{iata:"PBI",lat:26.6832,lon:-80.0956},
  {iata:"SAT",lat:29.5337,lon:-98.4698},{iata:"CHS",lat:32.8986,lon:-80.0405},
  {iata:"BOI",lat:43.5644,lon:-116.2228},{iata:"TUS",lat:32.1161,lon:-110.9410},
  {iata:"OMA",lat:41.3032,lon:-95.8941},{iata:"DSM",lat:41.5340,lon:-93.6631},
  {iata:"BUF",lat:42.9405,lon:-78.7322},{iata:"ROC",lat:43.1189,lon:-77.6724},
  {iata:"SYR",lat:43.1112,lon:-76.1063},{iata:"ALB",lat:42.7483,lon:-73.8017},
  {iata:"RIC",lat:37.5052,lon:-77.3197},{iata:"ORF",lat:36.8946,lon:-76.2012},
  {iata:"GSO",lat:36.0978,lon:-79.9373},{iata:"CVG",lat:39.0488,lon:-84.6678},
  {iata:"MEM",lat:35.0424,lon:-89.9767},{iata:"OKC",lat:35.3931,lon:-97.6007},
  {iata:"TUL",lat:36.1984,lon:-95.8881},{iata:"ELP",lat:31.8073,lon:-106.3778},
  {iata:"GEG",lat:47.6199,lon:-117.5338},{iata:"PSP",lat:33.8297,lon:-116.5067},
  {iata:"SBN",lat:41.7087,lon:-86.3173},{iata:"GRR",lat:42.8808,lon:-85.5228},
  {iata:"MSN",lat:43.1399,lon:-89.3375},{iata:"XNA",lat:36.2819,lon:-94.3068},
  {iata:"ICT",lat:37.6499,lon:-97.4331},{iata:"LIT",lat:34.7294,lon:-92.2243},
  // International
  {iata:"LHR",lat:51.4700,lon:-0.4543},{iata:"FRA",lat:50.0379,lon:8.5622},
  {iata:"CDG",lat:49.0097,lon:2.5479},{iata:"AMS",lat:52.3105,lon:4.7683},
  {iata:"MUC",lat:48.3538,lon:11.7861},{iata:"ZRH",lat:47.4647,lon:8.5492},
  {iata:"FCO",lat:41.8003,lon:12.2389},{iata:"MAD",lat:40.4983,lon:-3.5676},
  {iata:"BCN",lat:41.2974,lon:2.0833},{iata:"LIS",lat:38.7813,lon:-9.1359},
  {iata:"DUB",lat:53.4213,lon:-6.2701},{iata:"EDI",lat:55.9508,lon:-3.3615},
  {iata:"GUM",lat:13.4834,lon:144.7960,hub:true},{iata:"NRT",lat:35.7720,lon:140.3929,hub:true},{iata:"HND",lat:35.5494,lon:139.7798},
  {iata:"ICN",lat:37.4602,lon:126.4407},{iata:"PEK",lat:40.0799,lon:116.6031},
  {iata:"PVG",lat:31.1443,lon:121.8083},{iata:"HKG",lat:22.3080,lon:113.9185},
  {iata:"SIN",lat:1.3644,lon:103.9915},{iata:"BKK",lat:13.6900,lon:100.7501},
  {iata:"DEL",lat:28.5562,lon:77.1000},{iata:"BOM",lat:19.0896,lon:72.8656},
  {iata:"SYD",lat:-33.9399,lon:151.1753},{iata:"MEL",lat:-37.6690,lon:144.8410},
  {iata:"GRU",lat:-23.4356,lon:-46.4731},{iata:"EZE",lat:-34.8222,lon:-58.5358},
  {iata:"SCL",lat:-33.3930,lon:-70.7858},{iata:"BOG",lat:4.7016,lon:-74.1469},
  {iata:"MEX",lat:19.4363,lon:-99.0721},{iata:"CUN",lat:21.0365,lon:-86.8771},
  {iata:"GDL",lat:20.5218,lon:-103.3113},{iata:"SJD",lat:23.1518,lon:-109.7215},
  {iata:"PVR",lat:20.6801,lon:-105.2544},{iata:"LIM",lat:-12.0219,lon:-77.1143},
  {iata:"PTY",lat:9.0714,lon:-79.3835},{iata:"SJO",lat:9.9939,lon:-84.2088},
  {iata:"YYZ",lat:43.6777,lon:-79.6248},{iata:"YVR",lat:49.1967,lon:-123.1815},
  {iata:"YUL",lat:45.4706,lon:-73.7408},{iata:"YYC",lat:51.1315,lon:-114.0106},
  {iata:"TLV",lat:32.0114,lon:34.8867},{iata:"DOH",lat:25.2731,lon:51.6082},
  {iata:"DXB",lat:25.2532,lon:55.3657},{iata:"ADD",lat:8.9779,lon:38.7993},
  {iata:"ACC",lat:5.6052,lon:-0.1668},{iata:"CPT",lat:-33.9649,lon:18.6017},
  {iata:"JNB",lat:-26.1392,lon:28.2460},{iata:"CAI",lat:30.1219,lon:31.4056},
  {iata:"IST",lat:41.2753,lon:28.7519},{iata:"MNL",lat:14.5086,lon:121.0198},
  {iata:"TPE",lat:25.0777,lon:121.2327},{iata:"BRU",lat:50.9014,lon:4.4844},
  {iata:"OSL",lat:60.1976,lon:11.1004},{iata:"CPH",lat:55.6180,lon:12.6560},
  {iata:"ARN",lat:59.6519,lon:17.9186},{iata:"HEL",lat:60.3172,lon:24.9633}
];

const HUBS = AIRPORTS.filter(a => a.hub);
const HUB_CODES = HUBS.map(h => h.iata);

// ═══ UA ROUTE LOOKUP TABLE ═══
// Static mapping of UA flight numbers to known city pairs (fallback for missing FR24 route data)
const UA_ROUTES = {
  1:{from:'SFO',to:'SIN'},2:{from:'SIN',to:'SFO'},3:{from:'SFO',to:'HKG'},4:{from:'HKG',to:'SFO'},
  5:{from:'SFO',to:'SYD'},6:{from:'SYD',to:'SFO'},7:{from:'SFO',to:'NRT'},8:{from:'NRT',to:'SFO'},
  9:{from:'EWR',to:'CDG'},10:{from:'CDG',to:'EWR'},11:{from:'EWR',to:'BRU'},12:{from:'BRU',to:'EWR'},
  17:{from:'EWR',to:'LHR'},18:{from:'LHR',to:'EWR'},21:{from:'EWR',to:'LIS'},22:{from:'LIS',to:'EWR'},
  23:{from:'SFO',to:'ICN'},24:{from:'ICN',to:'SFO'},25:{from:'EWR',to:'FRA'},26:{from:'FRA',to:'EWR'},
  27:{from:'EWR',to:'ZRH'},28:{from:'ZRH',to:'EWR'},29:{from:'EWR',to:'DUB'},30:{from:'DUB',to:'EWR'},
  31:{from:'EWR',to:'FCO'},32:{from:'FCO',to:'EWR'},33:{from:'EWR',to:'AMS'},34:{from:'AMS',to:'EWR'},
  35:{from:'SFO',to:'TPE'},36:{from:'TPE',to:'SFO'},37:{from:'EWR',to:'IST'},38:{from:'IST',to:'EWR'},
  39:{from:'EWR',to:'MAD'},40:{from:'MAD',to:'EWR'},41:{from:'EWR',to:'BCN'},42:{from:'BCN',to:'EWR'},
  43:{from:'SFO',to:'BKK'},44:{from:'BKK',to:'SFO'},45:{from:'IAH',to:'LHR'},46:{from:'LHR',to:'IAH'},
  50:{from:'EWR',to:'TLV'},51:{from:'TLV',to:'EWR'},52:{from:'IAD',to:'LHR'},53:{from:'LHR',to:'IAD'},
  54:{from:'SFO',to:'DEL'},55:{from:'DEL',to:'SFO'},56:{from:'EWR',to:'DEL'},57:{from:'DEL',to:'EWR'},
  58:{from:'EWR',to:'EDI'},59:{from:'EDI',to:'EWR'},60:{from:'EWR',to:'MUC'},61:{from:'MUC',to:'EWR'},
  62:{from:'EWR',to:'CPH'},63:{from:'CPH',to:'EWR'},64:{from:'EWR',to:'HEL'},65:{from:'HEL',to:'EWR'},
  66:{from:'EWR',to:'ARN'},67:{from:'ARN',to:'EWR'},68:{from:'EWR',to:'OSL'},69:{from:'OSL',to:'EWR'},
  70:{from:'IAD',to:'CDG'},71:{from:'CDG',to:'IAD'},72:{from:'IAD',to:'FRA'},73:{from:'FRA',to:'IAD'},
  78:{from:'ORD',to:'LHR'},79:{from:'LHR',to:'ORD'},80:{from:'ORD',to:'FRA'},81:{from:'FRA',to:'ORD'},
  82:{from:'ORD',to:'CDG'},83:{from:'CDG',to:'ORD'},84:{from:'ORD',to:'MUC'},85:{from:'MUC',to:'ORD'},
  86:{from:'ORD',to:'NRT'},87:{from:'NRT',to:'ORD'},88:{from:'ORD',to:'PEK'},89:{from:'PEK',to:'ORD'},
  90:{from:'ORD',to:'ICN'},91:{from:'ICN',to:'ORD'},92:{from:'ORD',to:'HND'},93:{from:'HND',to:'ORD'},
  94:{from:'ORD',to:'DEL'},95:{from:'DEL',to:'ORD'},96:{from:'SFO',to:'PVG'},97:{from:'PVG',to:'SFO'},
  100:{from:'EWR',to:'PEK'},101:{from:'PEK',to:'EWR'},102:{from:'EWR',to:'PVG'},103:{from:'PVG',to:'EWR'},
  106:{from:'EWR',to:'HND'},107:{from:'HND',to:'EWR'},108:{from:'EWR',to:'NRT'},109:{from:'NRT',to:'EWR'},
  116:{from:'SFO',to:'MNL'},117:{from:'MNL',to:'SFO'},118:{from:'IAH',to:'NRT'},119:{from:'NRT',to:'IAH'},
  120:{from:'LAX',to:'SYD'},121:{from:'SYD',to:'LAX'},122:{from:'LAX',to:'MEL'},123:{from:'MEL',to:'LAX'},
  130:{from:'IAD',to:'TLV'},131:{from:'TLV',to:'IAD'},132:{from:'IAH',to:'EZE'},133:{from:'EZE',to:'IAH'},
  134:{from:'IAH',to:'GRU'},135:{from:'GRU',to:'IAH'},136:{from:'EWR',to:'GRU'},137:{from:'GRU',to:'EWR'},
  138:{from:'IAH',to:'SCL'},139:{from:'SCL',to:'IAH'},142:{from:'IAH',to:'BOG'},143:{from:'BOG',to:'IAH'},
  146:{from:'IAH',to:'LIM'},147:{from:'LIM',to:'IAH'},148:{from:'EWR',to:'BOG'},149:{from:'BOG',to:'EWR'},
  150:{from:'DEN',to:'NRT'},151:{from:'NRT',to:'DEN'},152:{from:'LAX',to:'NRT'},153:{from:'NRT',to:'LAX'},
  154:{from:'LAX',to:'ICN'},155:{from:'ICN',to:'LAX'},156:{from:'LAX',to:'PVG'},157:{from:'PVG',to:'LAX'},
  160:{from:'SFO',to:'LHR'},161:{from:'LHR',to:'SFO'},162:{from:'IAH',to:'FRA'},163:{from:'FRA',to:'IAH'},
  168:{from:'EWR',to:'SIN'},169:{from:'SIN',to:'EWR'},170:{from:'SFO',to:'FRA'},171:{from:'FRA',to:'SFO'},
  174:{from:'EWR',to:'HKG'},175:{from:'HKG',to:'EWR'},176:{from:'EWR',to:'BOM'},177:{from:'BOM',to:'EWR'},
  178:{from:'DEN',to:'LHR'},179:{from:'LHR',to:'DEN'},180:{from:'DEN',to:'FRA'},181:{from:'FRA',to:'DEN'},
  182:{from:'IAH',to:'MEX'},183:{from:'MEX',to:'IAH'},186:{from:'ORD',to:'DUB'},187:{from:'DUB',to:'ORD'},
  194:{from:'LAX',to:'LHR'},195:{from:'LHR',to:'LAX'},198:{from:'IAH',to:'CUN'},199:{from:'CUN',to:'IAH'},
  200:{from:'SFO',to:'GRU'},201:{from:'GRU',to:'SFO'},204:{from:'IAH',to:'PTY'},205:{from:'PTY',to:'IAH'},
  214:{from:'IAD',to:'IST'},215:{from:'IST',to:'IAD'},218:{from:'DEN',to:'NRT'},219:{from:'NRT',to:'DEN'},
  234:{from:'ORD',to:'AMS'},235:{from:'AMS',to:'ORD'},238:{from:'ORD',to:'IST'},239:{from:'IST',to:'ORD'},
  250:{from:'ORD',to:'BCN'},251:{from:'BCN',to:'ORD'},252:{from:'ORD',to:'ZRH'},253:{from:'ZRH',to:'ORD'},
  254:{from:'ORD',to:'FCO'},255:{from:'FCO',to:'ORD'},262:{from:'ORD',to:'EDI'},263:{from:'EDI',to:'ORD'},
  315:{from:'DEN',to:'HND'},316:{from:'HND',to:'DEN'},400:{from:'DEN',to:'SFO'},401:{from:'SFO',to:'DEN'},
  444:{from:'EWR',to:'LAX'},445:{from:'LAX',to:'EWR'},500:{from:'SFO',to:'EWR'},501:{from:'EWR',to:'SFO'},
  507:{from:'LAX',to:'HNL'},508:{from:'HNL',to:'LAX'},509:{from:'SFO',to:'HNL'},510:{from:'HNL',to:'SFO'},
  708:{from:'ORD',to:'DOH'},709:{from:'DOH',to:'ORD'},730:{from:'IAD',to:'ADD'},731:{from:'ADD',to:'IAD'},
  733:{from:'IAD',to:'ACC'},734:{from:'ACC',to:'IAD'},735:{from:'IAD',to:'JNB'},736:{from:'JNB',to:'IAD'},
  737:{from:'EWR',to:'CPT'},738:{from:'CPT',to:'EWR'},780:{from:'EWR',to:'DOH'},781:{from:'DOH',to:'EWR'},
  788:{from:'EWR',to:'DXB'},789:{from:'DXB',to:'EWR'},838:{from:'SFO',to:'ICN'},839:{from:'ICN',to:'SFO'},
  857:{from:'SFO',to:'PEK'},858:{from:'PEK',to:'SFO'},872:{from:'SFO',to:'HND'},873:{from:'HND',to:'SFO'},
  875:{from:'SFO',to:'NRT'},876:{from:'NRT',to:'SFO'},881:{from:'LAX',to:'HND'},882:{from:'HND',to:'LAX'},
  893:{from:'IAH',to:'SYD'},894:{from:'SYD',to:'IAH'},896:{from:'SFO',to:'MEL'},897:{from:'MEL',to:'SFO'},
  1100:{from:'EWR',to:'SFO'},1101:{from:'SFO',to:'EWR'},1200:{from:'SFO',to:'ORD'},1201:{from:'ORD',to:'SFO'},
  1300:{from:'DEN',to:'EWR'},1301:{from:'EWR',to:'DEN'},1400:{from:'IAH',to:'SFO'},1401:{from:'SFO',to:'IAH'},
  1500:{from:'DEN',to:'LAX'},1501:{from:'LAX',to:'DEN'},1600:{from:'ORD',to:'LAX'},1601:{from:'LAX',to:'ORD'},
  1700:{from:'DEN',to:'ORD'},1701:{from:'ORD',to:'DEN'},1800:{from:'IAH',to:'EWR'},1801:{from:'EWR',to:'IAH'},
  1900:{from:'IAD',to:'LAX'},1901:{from:'LAX',to:'IAD'},2000:{from:'IAD',to:'SFO'},2001:{from:'SFO',to:'IAD'}
};

// ═══ IATA → CITY NAME MAPPING ═══
const IATA_CITIES = {
  // United Hubs
  EWR:'Newark',IAH:'Houston',ORD:'Chicago O\'Hare',DEN:'Denver',SFO:'San Francisco',LAX:'Los Angeles',IAD:'Washington Dulles',
  // Major US
  ATL:'Atlanta',DFW:'Dallas/Fort Worth',JFK:'New York JFK',LGA:'New York LaGuardia',SEA:'Seattle',BOS:'Boston',
  PHX:'Phoenix',MCO:'Orlando',CLT:'Charlotte',MIA:'Miami',FLL:'Fort Lauderdale',MSP:'Minneapolis',
  DTW:'Detroit',PHL:'Philadelphia',SLC:'Salt Lake City',SAN:'San Diego',TPA:'Tampa',PDX:'Portland',
  BNA:'Nashville',STL:'St. Louis',AUS:'Austin',RDU:'Raleigh-Durham',MCI:'Kansas City',SMF:'Sacramento',
  SJC:'San José',OAK:'Oakland',CLE:'Cleveland',CMH:'Columbus',PIT:'Pittsburgh',IND:'Indianapolis',
  MKE:'Milwaukee',RSW:'Fort Myers',JAX:'Jacksonville',BDL:'Hartford',ABQ:'Albuquerque',ONT:'Ontario',
  BUR:'Burbank',HNL:'Honolulu',OGG:'Maui Kahului',KOA:'Kona',LIH:'Kauai Lihue',ANC:'Anchorage',
  SNA:'Orange County',DAL:'Dallas Love',HOU:'Houston Hobby',MDW:'Chicago Midway',BWI:'Baltimore',
  DCA:'Washington Reagan',MSY:'New Orleans',RNO:'Reno',LAS:'Las Vegas',PBI:'West Palm Beach',
  SAT:'San Antonio',CHS:'Charleston',BOI:'Boise',TUS:'Tucson',OMA:'Omaha',DSM:'Des Moines',
  BUF:'Buffalo',ROC:'Rochester',SYR:'Syracuse',ALB:'Albany',RIC:'Richmond',ORF:'Norfolk',
  GSO:'Greensboro',CVG:'Cincinnati',MEM:'Memphis',OKC:'Oklahoma City',TUL:'Tulsa',ELP:'El Paso',
  GEG:'Spokane',PSP:'Palm Springs',SBN:'South Bend',GRR:'Grand Rapids',MSN:'Madison',XNA:'Fayetteville',
  ICT:'Wichita',LIT:'Little Rock',
  // Europe
  LHR:'London Heathrow',FRA:'Frankfurt',CDG:'Paris CDG',AMS:'Amsterdam',MUC:'Munich',ZRH:'Zurich',
  FCO:'Rome Fiumicino',MAD:'Madrid',BCN:'Barcelona',LIS:'Lisbon',DUB:'Dublin',EDI:'Edinburgh',
  BRU:'Brussels',OSL:'Oslo',CPH:'Copenhagen',ARN:'Stockholm',HEL:'Helsinki',IST:'Istanbul',
  // Asia-Pacific
  GUM:'Guam',NRT:'Tokyo Narita',HND:'Tokyo Haneda',ICN:'Seoul Incheon',PEK:'Beijing',PVG:'Shanghai Pudong',
  HKG:'Hong Kong',SIN:'Singapore',BKK:'Bangkok',DEL:'Delhi',BOM:'Mumbai',MNL:'Manila',TPE:'Taipei',
  SYD:'Sydney',MEL:'Melbourne',
  // Americas (International)
  GRU:'São Paulo',EZE:'Buenos Aires',SCL:'Santiago',BOG:'Bogotá',MEX:'Mexico City',CUN:'Cancún',
  GDL:'Guadalajara',SJD:'Los Cabos',PVR:'Puerto Vallarta',LIM:'Lima',PTY:'Panama City',SJO:'San José CR',
  YYZ:'Toronto',YVR:'Vancouver',YUL:'Montreal',YYC:'Calgary',
  // Middle East & Africa
  TLV:'Tel Aviv',DOH:'Doha',DXB:'Dubai',ADD:'Addis Ababa',ACC:'Accra',CPT:'Cape Town',
  JNB:'Johannesburg',CAI:'Cairo'
};

// ═══ GLOBALS ═══
let map, flightMarkers = {}, routeLine = null, routeGroup = null, hubMarkers = [], wxLayer = null;
let allFlights = [], showHubs = true, showLonghaul = false, showWeather = false;
let activeHubFilter = null, activePhaseFilter = null;
let refreshTimer = null, countdown = 30;
let deepLinkHandled = false;

// ═══ TAB SWITCHING ═══
const TAB_HASHES = {'tab-live':'#live','tab-schedule':'#schedule','tab-fleet':'#fleet','tab-weather':'#weather','tab-analytics':'#stats','tab-sources':'#sources'};
const HASH_TABS = Object.fromEntries(Object.entries(TAB_HASHES).map(([k,v])=>[v,k]));

function switchToTab(tabId, updateHash) {
  document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); b.setAttribute('tabindex', '-1'); });
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
  if (!btn) return;
  btn.classList.add('active');
  btn.setAttribute('aria-selected', 'true');
  btn.setAttribute('tabindex', '0');
  document.getElementById(tabId).classList.add('active');
  if (updateHash !== false && TAB_HASHES[tabId]) history.replaceState(null, '', TAB_HASHES[tabId]);
  // Defer heavy tab-specific init to next frame so the click event completes fast (INP fix)
  requestAnimationFrame(() => {
    if (tabId === 'tab-live' && map) map.invalidateSize();
    if (tabId === 'tab-schedule') { initScheduleTab(); if (schedInitialized && !schedAllFlights.length && !schedLoading) loadScheduleData(); }
    if (tabId === 'tab-fleet') { if (!allFlights.length && !flightsLoading) refreshFlights(); updateLiveFleetPanel(); }
    if (tabId === 'tab-weather') initWeatherTab();
    if (tabId === 'tab-analytics') updateAnalytics();
  });
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchToTab(btn.dataset.tab));
});
// Keyboard navigation for tabs (arrow keys, Home, End)
document.getElementById('tab-bar')?.addEventListener('keydown', function(e) {
  const tabs = Array.from(this.querySelectorAll('.tab-btn'));
  const idx = tabs.indexOf(document.activeElement);
  if (idx < 0) return;
  let next = -1;
  if (e.key === 'ArrowRight' || e.key === 'ArrowDown') next = (idx + 1) % tabs.length;
  else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') next = (idx - 1 + tabs.length) % tabs.length;
  else if (e.key === 'Home') next = 0;
  else if (e.key === 'End') next = tabs.length - 1;
  if (next >= 0) { e.preventDefault(); tabs[next].focus(); tabs[next].click(); }
});

// Deep-link hash on load
(function(){
  const h = location.hash;
  if (h && HASH_TABS[h]) switchToTab(HASH_TABS[h], false);
})();

// ═══ QUERY PARAM DEEP-LINKING (hub pages) ═══
(function(){
  const params = new URLSearchParams(location.search);
  const tab = params.get('tab');
  const hub = params.get('hub');
  const filter = params.get('filter');
  if (!tab) return;

  // Map ?tab= values to internal tab IDs
  const TAB_MAP = {
    'live': 'tab-live',
    'schedule': 'tab-schedule',
    'fleet': 'tab-fleet',
    'weather': 'tab-weather',
    'irrops': 'tab-weather',  // IRROPS lives inside weather tab
    'stats': 'tab-analytics',
    'sources': 'tab-sources'
  };

  const tabId = TAB_MAP[tab];
  if (!tabId) return;
  switchToTab(tabId, false);

  // After tab switch, handle sub-navigation
  requestAnimationFrame(() => {
    setTimeout(() => {
      // Scroll to IRROPS section if requested
      if (tab === 'irrops') {
        const el = document.getElementById('irrops-section');
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // Fleet tab: auto-select Starlink filter
      if (tab === 'fleet' && filter === 'starlink') {
        const sel = document.getElementById('fleet-filter-status');
        if (sel) { sel.value = 'starlink'; sel.dispatchEvent(new Event('change')); }
      }

      // Schedule tab: filter by hub airport
      if (tab === 'schedule' && hub) {
        const searchInput = document.getElementById('sched-search');
        if (searchInput) { searchInput.value = hub.toUpperCase(); searchInput.dispatchEvent(new Event('input')); }
      }
    }, 500); // wait for tab content to render
  });
})();

// ═══ MOBILE BOTTOM NAV (4 tabs + More menu) ═══
(function(){
  var moreBtn = document.getElementById('mobile-more-btn');
  var moreMenu = document.getElementById('mobile-more-menu');
  // Direct tab buttons (not More, not overflow)
  document.querySelectorAll('#mobile-bottom-nav button[data-tab]:not(.bnav-overflow-item)').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('#mobile-bottom-nav button').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      if (moreMenu) moreMenu.classList.remove('open');
      switchToTab(btn.dataset.tab);
    });
  });
  // More button toggle
  if (moreBtn && moreMenu) {
    moreBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      moreMenu.classList.toggle('open');
    });
    // More menu items
    moreMenu.querySelectorAll('button[data-tab]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        moreMenu.classList.remove('open');
        document.querySelectorAll('#mobile-bottom-nav button').forEach(function(b) { b.classList.remove('active'); });
        moreBtn.classList.add('active');
        switchToTab(btn.dataset.tab);
      });
    });
    // Dismiss on outside tap
    document.addEventListener('click', function(e) {
      if (!moreMenu.contains(e.target) && e.target !== moreBtn) {
        moreMenu.classList.remove('open');
      }
    });
  }
})();
// Sync bottom nav active state when switchToTab is called from elsewhere
const _origSwitchToTab = switchToTab;
switchToTab = function(tabId, updateHash) {
  _origSwitchToTab(tabId, updateHash);
  var overflowTabs = ['tab-analytics','tab-sources'];
  var moreBtn = document.getElementById('mobile-more-btn');
  document.querySelectorAll('#mobile-bottom-nav button[data-tab]:not(.bnav-overflow-item)').forEach(function(b) {
    b.classList.toggle('active', b.dataset.tab === tabId);
  });
  if (moreBtn) moreBtn.classList.toggle('active', overflowTabs.indexOf(tabId) !== -1);
};

// ═══ MOBILE MAP CONTROLS TOGGLE (Change 1) ═══
(function(){
  var toggle = document.getElementById('mobile-ctrl-toggle');
  var controls = document.getElementById('controls');
  if (toggle && controls) {
    toggle.addEventListener('click', function(e) {
      e.stopPropagation();
      controls.classList.toggle('ctrl-menu-open');
    });
    document.addEventListener('click', function(e) {
      if (!controls.contains(e.target)) {
        controls.classList.remove('ctrl-menu-open');
      }
    });
  }
})();

// ═══ MOBILE TICKER ROTATION (Change 3) ═══
(function(){
  var isMobile = function() { return window.innerWidth <= 768; };
  var rotateInterval = null;
  var currentIndex = 0;

  function setupMobileTicker() {
    var ticker = document.getElementById('ticker');
    if (!ticker) return;
    var items = ticker.querySelectorAll('.ticker-item');
    // Only take unique items (ticker duplicates items for seamless scroll)
    var uniqueCount = Math.ceil(items.length / 2);
    if (uniqueCount === 0) return;

    // Reset all
    for (var i = 0; i < items.length; i++) {
      items[i].classList.remove('mobile-active', 'mobile-fade-out');
    }

    if (!isMobile()) return;

    // Show first item
    currentIndex = 0;
    if (items[0]) items[0].classList.add('mobile-active');

    clearInterval(rotateInterval);
    if (uniqueCount <= 1) return;

    rotateInterval = setInterval(function() {
      if (!isMobile()) { clearInterval(rotateInterval); return; }
      var items = ticker.querySelectorAll('.ticker-item');
      var uniqueCount = Math.ceil(items.length / 2);
      if (uniqueCount <= 1) return;

      var current = items[currentIndex];
      if (current) {
        current.classList.add('mobile-fade-out');
        setTimeout(function() {
          current.classList.remove('mobile-active', 'mobile-fade-out');
          currentIndex = (currentIndex + 1) % uniqueCount;
          var next = items[currentIndex];
          if (next) next.classList.add('mobile-active');
        }, 400);
      }
    }, 5000);
  }

  // Run on load and whenever ticker content changes
  var tickerEl = document.getElementById('ticker');
  if (tickerEl) {
    var observer = new MutationObserver(function() { setTimeout(setupMobileTicker, 50); });
    observer.observe(tickerEl, { childList: true, subtree: true });
  }
  window.addEventListener('resize', function() {
    if (isMobile()) setupMobileTicker();
    else {
      clearInterval(rotateInterval);
      // Restore all items visibility for desktop
      var items = (tickerEl || document.getElementById('ticker')).querySelectorAll('.ticker-item');
      for (var i = 0; i < items.length; i++) {
        items[i].classList.remove('mobile-active', 'mobile-fade-out');
      }
    }
  });
  setTimeout(setupMobileTicker, 1000);
})();

// ═══ MOBILE SEARCH TOGGLE ═══
(function(){
  const btn = document.getElementById('mobile-search-toggle');
  const wrap = document.getElementById('global-search-wrap');
  if (btn && wrap) {
    btn.addEventListener('click', () => {
      wrap.classList.toggle('mobile-search-open');
      if (wrap.classList.contains('mobile-search-open')) {
        document.getElementById('global-search-input').focus();
      }
    });
  }
})();

// ═══ MOBILE SIDEBAR TOGGLE ═══
(function(){
  const btn = document.getElementById('mobile-sidebar-toggle');
  const sidebar = document.getElementById('sidebar');
  if (btn && sidebar) {
    btn.addEventListener('click', () => {
      sidebar.classList.toggle('mobile-sidebar-open');
      btn.textContent = sidebar.classList.contains('mobile-sidebar-open') ? '🔍 Filters ▴' : '🔍 Filters ▾';
      if (map) setTimeout(() => map.invalidateSize(), 300);
    });
  }
})();

// ═══ CLOCK ═══
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toUTCString().slice(17, 25) + 'Z';
}
setInterval(updateClock, 1000);
updateClock();

// ═══ AIRPORT MATCHING ═══
function toRad(d) { return d * Math.PI / 180; }
function toDeg(r) { return r * 180 / Math.PI; }
function haversine(lat1, lon1, lat2, lon2) {
  const R = 3440.065; // nm
  const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
function bearing(lat1, lon1, lat2, lon2) {
  const dLon = toRad(lon2 - lon1);
  const y = Math.sin(dLon) * Math.cos(toRad(lat2));
  const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) - Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
  return (toDeg(Math.atan2(y, x)) + 360) % 360;
}
function angleDiff(a, b) { let d = Math.abs(a - b) % 360; return d > 180 ? 360 - d : d; }

function estimateRoute(lat, lon, hdg, alt, vr, flightNum) {
  // Try static UA route lookup first
  if (flightNum) {
    const num = parseInt(String(flightNum).replace(/^UA/i, '').replace(/^UAL/i, ''), 10);
    if (num && UA_ROUTES[num]) {
      const r = UA_ROUTES[num];
      const oApt = AIRPORTS.find(a => a.iata === r.from);
      const dApt = AIRPORTS.find(a => a.iata === r.to);
      if (oApt && dApt) return { origin: oApt, dest: dApt };
    }
  }
  if (!lat || !lon || hdg === null || hdg === undefined) return { origin: null, dest: null };
  const reverseHdg = (hdg + 180) % 360;
  let bestOrigin = null, bestDest = null;
  let bestOrigDist = Infinity, bestDestDist = Infinity;
  const lowAlt = alt !== null && alt < 5000;
  const tolerance = lowAlt ? 90 : 60;

  for (const apt of AIRPORTS) {
    const dist = haversine(lat, lon, apt.lat, apt.lon);
    const brng = bearing(lat, lon, apt.lat, apt.lon);

    // Behind aircraft = origin
    if (angleDiff(brng, reverseHdg) < tolerance && dist < bestOrigDist && dist < 2000) {
      bestOrigDist = dist; bestOrigin = apt;
    }
    // Ahead = destination
    if (angleDiff(brng, hdg) < tolerance && dist < bestDestDist && dist < 2000) {
      bestDestDist = dist; bestDest = apt;
    }
  }

  // For low altitude, nearest airport is likely origin or dest
  if (lowAlt) {
    let nearest = null, nearDist = Infinity;
    for (const apt of AIRPORTS) {
      const d = haversine(lat, lon, apt.lat, apt.lon);
      if (d < nearDist) { nearDist = d; nearest = apt; }
    }
    if (nearest && nearDist < 50) {
      if (vr > 0) bestOrigin = nearest;
      else bestDest = nearest;
    }
  }

  // Don't let origin = dest
  if (bestOrigin && bestDest && bestOrigin.iata === bestDest.iata) {
    if (bestOrigDist < bestDestDist) bestDest = null;
    else bestOrigin = null;
  }

  return { origin: bestOrigin, dest: bestDest };
}

// ═══ FLIGHT PHASE ═══
function getPhase(alt, vr, spd) {
  const altFt = alt != null ? alt * 3.28084 : null;
  const vrFpm = vr != null ? vr * 196.85 : null; // m/s to fpm
  const spdKts = spd != null ? spd * 1.944 : null;

  if (altFt !== null && altFt < 100 && spdKts !== null && spdKts < 50) return { phase: 'Ground', icon: '🅿️', cls: 'phase-ground' };
  if (altFt !== null && altFt < 5000 && vrFpm !== null && vrFpm > 500) return { phase: 'Takeoff', icon: '🛫', cls: 'phase-climb' };
  if (altFt !== null && altFt < 5000 && vrFpm !== null && vrFpm < -300) return { phase: 'Approach', icon: '🛬', cls: 'phase-approach' };
  if (vrFpm !== null && vrFpm > 300) return { phase: 'Climb', icon: '↗️', cls: 'phase-climb' };
  if (vrFpm !== null && vrFpm < -300) return { phase: 'Descent', icon: '↘️', cls: 'phase-descent' };
  if (altFt !== null && altFt > 25000) return { phase: 'Cruise', icon: '✈️', cls: 'phase-cruise' };
  return { phase: 'En Route', icon: '✈️', cls: 'phase-cruise' };
}

// ═══ SQUAWK DECODER ═══
function decodeSquawk(sq) {
  if (!sq) return null;
  const s = String(sq);
  if (s === '7500') return { text: '⚠️ HIJACK', cls: 'squawk-alert' };
  if (s === '7600') return { text: '⚠️ RADIO FAILURE', cls: 'squawk-alert' };
  if (s === '7700') return { text: '⚠️ EMERGENCY', cls: 'squawk-alert' };
  if (s === '1200') return { text: 'VFR', cls: '' };
  return null;
}

// ═══ ICAO24 to N-number (approximate) ═══
function icao24ToNNumber(hex) {
  // US registrations: A00001-AFFFFF (hex)
  const h = parseInt(hex, 16);
  if (h < 0xA00001 || h > 0xAFFFFF) return null;
  const offset = h - 0xA00001;
  // Simplified mapping - not perfectly accurate but works for many
  const d1 = Math.floor(offset / 101711);
  const rem1 = offset % 101711;
  const d2 = Math.floor(rem1 / 10111);
  const rem2 = rem1 % 10111;
  const d3 = Math.floor(rem2 / 951);
  const rem3 = rem2 % 951;

  let nnum = 'N' + (d1 + 1);
  if (d2 > 0) {
    nnum += d2 - 1;
    if (d3 > 0) {
      nnum += d3 - 1;
      if (rem3 > 0) {
        if (rem3 <= 25) nnum += String.fromCharCode(64 + rem3);
        else {
          const d4 = Math.floor((rem3 - 1) / 25);
          const r4 = (rem3 - 1) % 25;
          nnum += d4;
          if (r4 > 0) nnum += String.fromCharCode(64 + r4);
        }
      }
    } else if (rem3 > 0) {
      if (rem3 <= 25) nnum += String.fromCharCode(64 + rem3);
      else {
        nnum += Math.floor((rem3 - 1) / 25);
      }
    }
  } else if (rem2 > 0) {
    if (rem2 <= 25) nnum += String.fromCharCode(64 + rem2);
  }
  return nnum;
}

function matchAircraft(f) {
  // FR24 gives us registration directly — try that first
  if (f.reg) {
    const reg = f.reg.replace('-', '');
    if (FLEET_BY_REG[reg]) return { ...FLEET_BY_REG[reg], nnum: reg };
    if (FLEET_BY_REG[f.reg]) return { ...FLEET_BY_REG[f.reg], nnum: f.reg };
  }
  // Fallback to ICAO24 conversion
  if (f.icao24) {
    const nnum = icao24ToNNumber(f.icao24);
    if (nnum && FLEET_BY_REG[nnum]) return { ...FLEET_BY_REG[nnum], nnum };
  }
  return null;
}

// ═══ MAP INIT ═══
function initMap() {
  map = L.map('map', {
    center: [39, -98], zoom: 4, zoomControl: false,
    attributionControl: false, worldCopyJump: true
  });
  L.control.zoom({ position: 'bottomright' }).addTo(map);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 18, subdomains: 'abcd'
  }).addTo(map);

  // Clear route on popup close and remove flight URL param
  map.on('popupclose', () => {
    if (routeGroup) { map.removeLayer(routeGroup); routeGroup = null; }
    if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
    const url = new URL(window.location);
    if (url.searchParams.has('flight')) {
      url.searchParams.delete('flight');
      history.replaceState(null, '', url.pathname + url.search + url.hash);
    }
  });

  // Hub markers
  drawHubs();
  refreshFlights();
  refreshTimer = setInterval(() => {
    countdown--;
    document.getElementById('countdown').textContent = 'Next refresh: ' + countdown + 's';
    if (countdown <= 0) { refreshFlights(); countdown = 30; }
  }, 1000);
}

function drawHubs() {
  hubMarkers.forEach(m => map.removeLayer(m));
  hubMarkers = [];
  if (!showHubs) return;

  HUBS.forEach(h => {
    const circle = L.circleMarker([h.lat, h.lon], {
      radius: 8, color: '#005DAA', fillColor: '#005DAA', fillOpacity: 0.3, weight: 2
    }).addTo(map);
    circle.bindTooltip(h.iata, { permanent: true, direction: 'top', className: 'hub-tooltip', offset: [0, -10] });
    hubMarkers.push(circle);

    // Pulse
    const pulse = L.circleMarker([h.lat, h.lon], {
      radius: 8, color: '#005DAA', fillOpacity: 0, weight: 1, className: 'hub-pulse'
    }).addTo(map);
    hubMarkers.push(pulse);
  });
}

function toggleHubs() { showHubs = !showHubs; drawHubs(); document.getElementById('btn-hubs').classList.toggle('active'); }
function toggleLonghaul() { showLonghaul = !showLonghaul; document.getElementById('btn-longhaul').classList.toggle('active'); updateMarkers(); }
function toggleWeather() {
  showWeather = !showWeather;
  document.getElementById('btn-wx').classList.toggle('active');
  if (showWeather && !wxLayer) {
    wxLayer = L.tileLayer('https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png', {
      opacity: 0.5, maxZoom: 18
    }).addTo(map);
  } else if (!showWeather && wxLayer) {
    map.removeLayer(wxLayer); wxLayer = null;
  }
}

let pacificView = false;
const US_VIEW = { center: [39, -98], zoom: 4 };
const PACIFIC_VIEW = { center: [25, 145], zoom: 4 };
function togglePacific() {
  pacificView = !pacificView;
  document.getElementById('btn-pacific').classList.toggle('active');
  const view = pacificView ? PACIFIC_VIEW : US_VIEW;
  map.flyTo(view.center, view.zoom, { duration: 1.2 });
}

// ═══ FLIGHT DATA (FlightRadar24) ═══
let flightsLoading = false;
let isRefreshing = false;
async function refreshFlights() {
  if (isRefreshing) return;
  isRefreshing = true;
  flightsLoading = true;
  document.getElementById('btn-refresh').textContent = '⏳ Loading...';
  try {
    const res = await fetch('/api/fr24-feed?airline=UAL');
    if (!res.ok) throw new Error(res.status);
    const data = await res.json();
    allFlights = [];
    for (const [id, arr] of Object.entries(data)) {
      if (id === 'full_count' || id === 'version' || id === 'stats' || !Array.isArray(arr)) continue;
      const f = {
        fr24id: id,
        icao24: arr[0],
        lat: arr[1], lon: arr[2], hdg: arr[3],
        alt: arr[4] ? arr[4] / 3.28084 : 0, // FR24 gives feet, convert to meters for compatibility
        spd: arr[5] ? arr[5] / 1.944 : 0,   // FR24 gives knots, convert to m/s for compatibility
        vr: arr[15] ? arr[15] / 196.85 : 0,  // FR24 gives fpm, convert to m/s for compatibility
        squawk: null,
        acType: arr[8] || '',
        reg: arr[9] || '',
        origin: arr[11] || '',
        dest: arr[12] || '',
        flightIATA: arr[13] || '',
        onGround: arr[14] === 1,
        callsign: arr[16] || '',
        airline: arr[18] || ''
      };
      if (f.lat && f.lon) allFlights.push(f);
    }

    document.getElementById('status-dot').className = 'status-dot live';
    document.getElementById('status-text').textContent = 'LIVE';
    document.getElementById('header-flight-count').textContent = '· ' + allFlights.length + ' flights';
    const errOverlay = document.getElementById('map-error-overlay');
    if (errOverlay) errOverlay.remove();
  } catch (e) {
    console.error('FR24 error:', e);
    document.getElementById('status-dot').className = 'status-dot';
    document.getElementById('status-dot').style.background = '#ff9800';
    document.getElementById('status-text').textContent = 'ERROR';
    if (allFlights.length === 0) {
      const mapEl = document.getElementById('map');
      if (!document.getElementById('map-error-overlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'map-error-overlay';
        overlay.style.cssText = 'position:absolute;inset:0;z-index:999;display:flex;align-items:center;justify-content:center;background:rgba(10,14,20,.85);pointer-events:auto';
        overlay.innerHTML = '<div class="error-state"><div class="error-icon">📡</div><div style="color:var(--ua-text);font-size:13px;margin-bottom:4px">Live data temporarily unavailable</div><div style="color:var(--ua-muted);font-size:11px">Could not reach flight data server</div><button class="retry-btn" data-action="map-error-retry">↻ Retry</button></div>';
        mapEl.parentElement.style.position = 'relative';
        mapEl.parentElement.appendChild(overlay);
      }
    }
  } finally {
    countdown = 30;
    document.getElementById('btn-refresh').textContent = '🔄 Refresh';
    flightsLoading = false;
    isRefreshing = false;
    updateMarkers();
    updateStats();
    updateHubStats();
    updateTicker();
    // Only update tab-specific panels when their tab is actually active
    if (document.getElementById('tab-fleet')?.classList.contains('active')) updateLiveFleetPanel();
    if (document.getElementById('tab-analytics')?.classList.contains('active')) updateAnalytics();
    // Handle deep link: ?flight=UA1234 on first load
    if (!deepLinkHandled) {
      deepLinkHandled = true;
      const urlParams = new URLSearchParams(window.location.search);
      const flightParam = urlParams.get('flight');
      if (flightParam && allFlights.length > 0) {
        const q = flightParam.trim().toUpperCase().replace(/\s+/g, '');
        const match = allFlights.find(f => {
          const flt = (f.flightIATA || '').toUpperCase();
          const cs = (f.callsign || '').toUpperCase();
          return flt === q || cs === q || flt === 'UA' + q || cs === 'UAL' + q;
        });
        if (match && flightMarkers[match.icao24]) {
          setTimeout(() => focusFlight(match.icao24), 300);
        } else {
          setTimeout(() => lookupFR24Flight(flightParam), 300);
        }
      }
    }
  }
}

const AIRPORT_COORDS = {};
AIRPORTS.forEach(a => { AIRPORT_COORDS[a.iata] = a; });

function haversineNm(lat1, lon1, lat2, lon2) {
  const R = 3440.065; // Earth radius in nautical miles
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function isLonghaulFlight(f) {
  // Use airport coords to calculate distance; >2500nm = longhaul
  const orig = AIRPORT_COORDS[f.origin];
  const dest = AIRPORT_COORDS[f.dest];
  if (orig && dest) return haversineNm(orig.lat, orig.lon, dest.lat, dest.lon) > 2500;
  // Fallback: old flight number heuristic (sub-100) for flights without matched airports
  const num = parseInt((f.callsign || '').replace(/^UAL/, ''));
  return num > 0 && num < 100;
}

// Icon cache: key = "hdg_rounded|isLonghaul|phase" → L.divIcon
const _iconCache = {};
function createPlaneIcon(hdg, isLonghaul, phase) {
  // Round heading to nearest 5° to maximize cache hits (72 possible angles × 3 color combos = ~216 cached icons)
  const hdgRounded = Math.round((hdg || 0) / 5) * 5;
  const cacheKey = `${hdgRounded}|${isLonghaul?1:0}|${phase}`;
  if (_iconCache[cacheKey]) return _iconCache[cacheKey];
  const color = isLonghaul ? '#fbbf24' : (phase === 'Ground' ? '#6b7280' : '#60a5fa');
  const size = isLonghaul ? 14 : 10;
  // SVG plane pointing north (0°) — classic top-down aircraft silhouette, cross-platform consistent
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 256 256" fill="${color}" style="filter:drop-shadow(0 0 2px ${color})"><path d="M128 16c-4 0-8 3-9 7l-15 72-88 34c-3 1-4 4-4 7s2 5 5 6l87 20 4 52-28 18c-2 1-3 3-3 5v8c0 2 1 4 3 4l20-6h28l20 6c2 0 3-2 3-4v-8c0-2-1-4-3-5l-28-18 4-52 87-20c3-1 5-3 5-6s-1-6-4-7l-88-34-15-72c-1-4-5-7-9-7z"/></svg>`;
  const icon = L.divIcon({
    html: `<div style="transform:rotate(${hdgRounded}deg);line-height:0">${svg}</div>`,
    iconSize: [size, size], iconAnchor: [size/2, size/2], className: ''
  });
  _iconCache[cacheKey] = icon;
  return icon;
}

function getFilteredFlights() {
  return allFlights.filter(f => {
    if (activeHubFilter) {
      const hub = HUBS.find(h => h.iata === activeHubFilter);
      // FR24 gives real origin/dest — use those first, fall back to estimation
      const matchesHub = f.origin === activeHubFilter || f.dest === activeHubFilter ||
        (f.onGround && hub && haversine(f.lat, f.lon, hub.lat, hub.lon) < 93); // ~50nm
      if (!matchesHub) return false;
    }
    if (activePhaseFilter) {
      const p = getPhase(f.alt, f.vr, f.spd);
      const phaseGroup = getPhaseGroup(p.phase);
      if (phaseGroup !== activePhaseFilter) return false;
    }
    return true;
  });
}

function getPhaseGroup(phase) {
  if (phase === 'Ground') return 'Ground';
  if (phase === 'Takeoff' || phase === 'Climb') return 'Climb';
  if (phase === 'Cruise' || phase === 'En Route') return 'Cruise';
  if (phase === 'Descent') return 'Descent';
  if (phase === 'Approach') return 'Approach';
  return 'Cruise';
}

function updateMarkers() {
  const filtered = getFilteredFlights();
  const filteredIcaos = new Set(filtered.map(f => f.icao24));
  const allIcaos = new Set(allFlights.map(f => f.icao24));

  // Remove markers for flights no longer in feed
  Object.keys(flightMarkers).forEach(id => {
    if (!allIcaos.has(id)) { map.removeLayer(flightMarkers[id]); delete flightMarkers[id]; }
  });
  // Hide markers not in filtered set
  Object.keys(flightMarkers).forEach(id => {
    if (!filteredIcaos.has(id)) { map.removeLayer(flightMarkers[id]); }
    else if (!map.hasLayer(flightMarkers[id])) { flightMarkers[id].addTo(map); }
  });

  filtered.forEach(f => {
    const isLonghaul = showLonghaul && isLonghaulFlight(f);
    const phaseInfo = getPhase(f.alt, f.vr, f.spd);
    const icon = createPlaneIcon(f.hdg, isLonghaul, phaseInfo.phase);

    // Normalize longitude to nearest world copy relative to map center
    // so IDL-crossing flights (e.g. SFO→BNE) are always visible
    let lon = f.lon;
    const centerLng = map.getCenter().lng;
    while (lon - centerLng > 180) lon -= 360;
    while (lon - centerLng < -180) lon += 360;

    if (flightMarkers[f.icao24]) {
      flightMarkers[f.icao24].setLatLng([f.lat, lon]).setIcon(icon);
    } else {
      const marker = L.marker([f.lat, lon], { icon }).addTo(map);
      marker._icao24 = f.icao24;
      marker.on('click', () => {
        const currentFlight = allFlights.find(fl => fl.icao24 === marker._icao24);
        if (currentFlight) showFlightPopup(currentFlight, marker);
      });
      flightMarkers[f.icao24] = marker;
    }
  });
}

function showFlightPopup(f, marker) {
  // Update URL with flight parameter for shareable links
  const shareFlightId = f.flightIATA || f.callsign || '';
  if (shareFlightId) {
    const url = new URL(window.location);
    url.searchParams.set('flight', shareFlightId);
    history.replaceState(null, '', url);
  }
  // Remove old route layers
  if (routeGroup) { map.removeLayer(routeGroup); routeGroup = null; }
  if (routeLine) { map.removeLayer(routeLine); routeLine = null; }

  // FR24 gives us real route data — fall back to estimation only if missing
  const hasRealRoute = f.origin && f.dest;
  let originObj = null, destObj = null;
  if (hasRealRoute) {
    originObj = HUBS.find(h => h.iata === f.origin) || { iata: f.origin, lat: null, lon: null };
    destObj = HUBS.find(h => h.iata === f.dest) || { iata: f.dest, lat: null, lon: null };
  }
  if (!hasRealRoute) {
    const est = estimateRoute(f.lat, f.lon, f.hdg, f.alt ? f.alt * 3.28084 : null, f.vr, f.flightIATA || f.callsign);
    originObj = est.origin;
    destObj = est.dest;
  }

  const phaseInfo = getPhase(f.alt, f.vr, f.spd);
  const squawk = decodeSquawk(f.squawk);
  const aircraft = matchAircraft(f);
  const isStarlink = aircraft ? STARLINK_TAILS.has(aircraft.r) : (f.reg && STARLINK_TAILS.has(f.reg));
  const flightNum = f.flightIATA || f.callsign.replace(/^UAL/, '');
  const displayFlight = f.flightIATA || f.callsign || 'N/A';

  const altFt = f.alt ? Math.round(f.alt * 3.28084) : null;
  const spdKts = f.spd ? Math.round(f.spd * 1.944) : null;
  const altPct = altFt ? Math.min(100, (altFt / 41000) * 100) : 0;
  const mach = altFt && altFt > 28000 && spdKts ? (spdKts / 661).toFixed(2) : null;

  const origCode = f.origin || originObj?.iata || '???';
  const destCode = f.dest || destObj?.iata || '???';
  const origCity = IATA_CITIES[origCode] || '';
  const destCity = IATA_CITIES[destCode] || '';
  const hasCityNames = origCity && destCity;
  const routeStr = origCode + ' → ' + destCode;

  let html = `<div class="popup-card">`;
  html += `<div class="popup-header"><div>`;
  html += `<div class="popup-callsign">${escapeHtml(displayFlight)}</div>`;
  if (hasCityNames) html += `<div class="popup-route" style="font-size:14px;font-weight:600">${escapeHtml(origCity)} → ${escapeHtml(destCity)}</div>`;
  html += `<div class="popup-route" style="${hasCityNames ? 'font-size:11px;color:var(--ua-muted);margin-top:1px' : ''}">${escapeHtml(routeStr)}</div>`;
  if (!hasRealRoute && (originObj || destObj)) html += `<div class="popup-route-est">estimated route</div>`;
  html += `</div><div>`;
  html += `<span class="popup-phase ${phaseInfo.cls}">${phaseInfo.icon} ${phaseInfo.phase}</span>`;
  if (squawk) html += `<br><span class="${squawk.cls}">${squawk.text}</span>`;
  html += `</div></div>`;

  html += `<div class="popup-grid">`;
  html += `<div class="popup-field"><span class="popup-field-label">Altitude</span><span class="popup-field-value">${altFt ? altFt.toLocaleString() + ' ft' : 'N/A'}</span>`;
  html += `<div class="alt-bar"><div class="alt-bar-fill" style="width:${altPct}%"></div></div></div>`;
  html += `<div class="popup-field"><span class="popup-field-label">Speed</span><span class="popup-field-value">${spdKts ? spdKts + ' kts' : 'N/A'}${mach ? ' / M' + mach : ''}</span></div>`;
  html += `<div class="popup-field"><span class="popup-field-label">Heading</span><span class="popup-field-value">${f.hdg ? Math.round(f.hdg) + '°' : 'N/A'}</span></div>`;
  html += `<div class="popup-field"><span class="popup-field-label">V/S</span><span class="popup-field-value">${f.vr ? Math.round(f.vr * 196.85) + ' fpm' : 'N/A'}</span></div>`;
  html += `</div>`;

  // Aircraft info — FR24 type + fleet DB match
  if (aircraft) {
    html += `<div class="popup-aircraft">`;
    html += `<div class="popup-aircraft-type">${escapeHtml(aircraft.t)} <span style="color:var(--ua-muted);font-size:10px">${escapeHtml(aircraft.r)}</span></div>`;
    html += `<div style="font-size:10px;color:var(--ua-muted)">${escapeHtml(aircraft.c || '')} | ${escapeHtml(aircraft.w || '')} | ${escapeHtml(aircraft.i || '')}</div>`;
    if (isStarlink) html += `<span class="starlink-badge">⚡ STARLINK</span> `;
    if (aircraft.seats && Object.keys(aircraft.seats).length > 0) {
      html += `<div class="popup-seats">`;
      for (const [cls, cnt] of Object.entries(aircraft.seats)) {
        html += `<span class="seat-block seat-${cls}">${cnt}${cls}</span>`;
      }
      html += `<span style="font-size:9px;color:var(--ua-muted);margin-left:4px">(${aircraft.tot} total)</span></div>`;
    }
    html += `</div>`;
  } else {
    // Show FR24 data even without fleet match
    let acInfo = [];
    if (f.acType) acInfo.push(f.acType);
    if (f.reg) acInfo.push(f.reg);
    if (acInfo.length) html += `<div style="font-size:10px;color:var(--ua-muted);margin:4px 0">${escapeHtml(acInfo.join(' · '))} (not in mainline fleet DB — likely United Express)</div>`;
  }

  // Departure/Arrival times — placeholder, filled async
  html += `<div id="popup-times-${escapeHtml(f.icao24)}" class="popup-times-loading">✈️ Loading departure & arrival times…</div>`;

  html += `<div class="popup-links">`;
  const fltLink = flightNum.replace(/^UA/, '');
  if (fltLink) html += `<a href="https://flightaware.com/live/flight/UAL${encodeURIComponent(fltLink)}" target="_blank" rel="noopener noreferrer">FlightAware ↗</a>`;
  const regLink = aircraft?.r || f.reg;
  if (regLink) html += `<a href="https://www.planespotters.net/search?q=${encodeURIComponent(regLink)}" target="_blank" rel="noopener noreferrer">Planespotters ↗</a>`;
  html += `<a href="https://globe.adsbexchange.com/?icao=${encodeURIComponent(f.icao24)}" target="_blank" rel="noopener noreferrer">ADS-B ↗</a>`;
  // Watch button in popup
  const popupFlt = displayFlight;
  const popupRoute = (f.origin||'?') + '→' + (f.dest||'?');
  const popupWatched = isFlightWatched(popupFlt);
  html += `<button class="watch-btn${popupWatched ? ' watching' : ''}" data-action="toggle-watch-flight" data-flight="${escapeHtml(popupFlt)}" data-route="${escapeHtml(popupRoute)}" data-status="airborne" aria-label="${popupWatched ? 'Unwatch flight' : 'Watch flight'}" style="margin-left:auto">${popupWatched ? '👁️ Watching' : '👁 Watch'}</button>`;
  html += `<button class="share-btn" data-action="share-flight" data-flight="${escapeHtml(popupFlt)}" aria-label="Share flight link" title="Copy shareable link">📤 Share</button>`;
  html += `</div></div>`;

  if (marker.getPopup()) marker.unbindPopup();
  marker.bindPopup(html, { maxWidth: 320, closeButton: true }).openPopup();

  // Async fetch departure/arrival times from FlightAware
  (function fetchFlightTimes() {
    const timesId = 'popup-times-' + f.icao24;
    const fltQuery = f.flightIATA || f.callsign || '';
    if (!fltQuery) {
      const el = document.getElementById(timesId);
      if (el) el.style.display = 'none';
      return;
    }
    fetch('/api/flight-times?flight=' + encodeURIComponent(fltQuery))
      .then(r => r.ok ? r.json() : { success: false })
      .then(data => {
        const el = document.getElementById(timesId);
        if (!el) return;
        if (!data.success) { el.style.display = 'none'; return; }

        const dep = data.departure || {};
        const arr = data.arrival || {};
        const orig = data.origin || {};
        const dest = data.destination || {};

        function fmtTimeInTz(iso, tz) {
          if (!iso) return null;
          try {
            const d = new Date(iso);
            if (isNaN(d)) return null;
            const opts = { hour: 'numeric', minute: '2-digit', hour12: true };
            if (tz) opts.timeZone = tz;
            return d.toLocaleTimeString([], opts);
          } catch(e) { return null; }
        }
        function fmtTimeWithTz(iso, tz) {
          if (!iso) return null;
          try {
            const d = new Date(iso);
            if (isNaN(d)) return null;
            const opts = { hour: 'numeric', minute: '2-digit', hour12: true, timeZoneName: 'short' };
            if (tz) opts.timeZone = tz;
            return d.toLocaleTimeString([], opts);
          } catch(e) { return null; }
        }
        function deltaMin(schedIso, actualIso) {
          if (!schedIso || !actualIso) return null;
          try {
            const diff = Math.round((new Date(actualIso) - new Date(schedIso)) / 60000);
            return isNaN(diff) ? null : diff;
          } catch(e) { return null; }
        }
        function deltaBadge(diff) {
          if (diff === null || isNaN(diff)) return '';
          if (Math.abs(diff) <= 5) return ' <span class="time-delta ontime">On time</span>';
          if (diff > 0) return ' <span class="time-delta late">+' + diff + 'm</span>';
          return ' <span class="time-delta early">' + diff + 'm</span>';
        }

        // Departure: prefer actual, then estimated, then scheduled
        const depGate = dep.gate || {};
        const depTakeoff = dep.takeoff || {};
        const depActual = depGate.actual || depTakeoff.actual;
        const depEst = depGate.estimated || depTakeoff.estimated;
        const depSched = depGate.scheduled || depTakeoff.scheduled;
        const depBest = depActual || depEst || depSched;

        // Arrival: prefer actual, then estimated, then scheduled
        const arrGate = arr.gate || {};
        const arrLand = arr.landing || {};
        const arrActual = arrGate.actual || arrLand.actual;
        const arrEst = arrGate.estimated || arrLand.estimated;
        const arrSched = arrGate.scheduled || arrLand.scheduled;
        const arrBest = arrActual || arrEst || arrSched;

        if (!depBest && !arrBest) { el.style.display = 'none'; return; }

        let h = '<div class="popup-times">';

        // Departure column
        h += '<div class="popup-field"><span class="popup-field-label">Departure' + (orig.terminal ? ' · T' + orig.terminal : '') + (orig.gate ? ' G' + orig.gate : '') + '</span><span class="popup-field-value">';
        if (depActual) {
          h += (fmtTimeInTz(depActual, orig.tz) || 'N/A') + deltaBadge(deltaMin(depSched, depActual));
        } else if (depEst) {
          h += (fmtTimeInTz(depEst, orig.tz) || 'N/A') + deltaBadge(deltaMin(depSched, depEst));
        } else if (depSched) {
          h += (fmtTimeInTz(depSched, orig.tz) || 'N/A');
        }
        h += '</span>';
        const depDiff = deltaMin(depSched, depActual || depEst);
        if ((depActual || depEst) && depSched && depDiff !== null && Math.abs(depDiff) > 5) {
          h += '<span style="font-size:9px;color:var(--ua-muted)">Sched ' + fmtTimeInTz(depSched, orig.tz) + '</span>';
        }
        h += '</div>';

        // Arrival column
        h += '<div class="popup-field"><span class="popup-field-label">Arrival' + (dest.terminal ? ' · T' + dest.terminal : '') + (dest.gate ? ' G' + dest.gate : '') + '</span><span class="popup-field-value">';
        if (arrActual) {
          h += (fmtTimeWithTz(arrActual, dest.tz) || 'N/A') + deltaBadge(deltaMin(arrSched, arrActual));
        } else if (arrEst) {
          h += (fmtTimeWithTz(arrEst, dest.tz) || 'N/A') + deltaBadge(deltaMin(arrSched, arrEst));
        } else if (arrSched) {
          h += (fmtTimeWithTz(arrSched, dest.tz) || 'N/A');
        }
        h += '</span>';
        const arrDiff = deltaMin(arrSched, arrActual || arrEst);
        if ((arrActual || arrEst) && arrSched && arrDiff !== null && Math.abs(arrDiff) > 5) {
          h += '<span style="font-size:9px;color:var(--ua-muted)">Sched ' + fmtTimeWithTz(arrSched, dest.tz) + '</span>';
        }
        h += '</div>';

        h += '</div>';
        el.className = '';
        el.innerHTML = h;
      })
      .catch(() => {
        const el = document.getElementById(timesId);
        if (el) el.style.display = 'none';
      });
  })();

  // Draw great circle route lines with traveled/remaining segments + endpoint markers
  {
    let oApt = null, dApt = null;
    if (f.origin && f.dest) {
      oApt = HUBS.find(h => h.iata === f.origin) || AIRPORTS.find(a => a.iata === f.origin);
      dApt = HUBS.find(h => h.iata === f.dest) || AIRPORTS.find(a => a.iata === f.dest);
    } else if (originObj && destObj && originObj.lat && destObj.lat) {
      oApt = originObj; dApt = destObj;
    }
    if (oApt && dApt && oApt.lat && dApt.lat) {
      const layers = [];
      const planePos = [f.lat, f.lon];
      // Traveled segment: origin → plane (solid) — continuous lon for IDL crossing
      const traveledPts = normalizeLonContinuity(greatCirclePoints(oApt.lat, oApt.lon, f.lat, f.lon, 60));
      layers.push(L.polyline(traveledPts, { color: '#005DAA', weight: 2.5, opacity: 0.8 }));
      // Remaining segment: plane → destination (dashed)
      const remainPts = normalizeLonContinuity(greatCirclePoints(f.lat, f.lon, dApt.lat, dApt.lon, 60));
      layers.push(L.polyline(remainPts, { color: '#005DAA', weight: 1.5, dashArray: '6,4', opacity: 0.4 }));
      // Origin marker — use normalized lon from route start
      const oLon = traveledPts[0][1];
      const oLabel = oApt.iata + (IATA_CITIES[oApt.iata] ? ' — ' + IATA_CITIES[oApt.iata] : '');
      layers.push(L.circleMarker([oApt.lat, oLon], {radius:5,color:'#005DAA',fillColor:'#005DAA',fillOpacity:0.7,weight:1}).bindTooltip(oLabel,{permanent:false,direction:'top'}));
      // Destination marker — use normalized lon from route end
      const dLon = remainPts[remainPts.length - 1][1];
      const dLabel = dApt.iata + (IATA_CITIES[dApt.iata] ? ' — ' + IATA_CITIES[dApt.iata] : '');
      layers.push(L.circleMarker([dApt.lat, dLon], {radius:5,color:'#005DAA',fillColor:'#fff',fillOpacity:0.9,weight:2}).bindTooltip(dLabel,{permanent:false,direction:'top'}));
      routeGroup = L.layerGroup(layers).addTo(map);
    }
  }
}

function greatCirclePoints(lat1, lon1, lat2, lon2, n) {
  const φ1 = toRad(lat1), λ1 = toRad(lon1), φ2 = toRad(lat2), λ2 = toRad(lon2);
  const d = Math.acos(Math.min(1, Math.max(-1,
    Math.sin(φ1)*Math.sin(φ2) + Math.cos(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1)
  )));
  if (d < 1e-6) return [[lat1,lon1],[lat2,lon2]];
  const sinD = Math.sin(d);
  const pts = [];
  for (let i = 0; i <= n; i++) {
    const f = i / n;
    const a = Math.sin((1-f)*d) / sinD;
    const b = Math.sin(f*d) / sinD;
    const x = a*Math.cos(φ1)*Math.cos(λ1) + b*Math.cos(φ2)*Math.cos(λ2);
    const y = a*Math.cos(φ1)*Math.sin(λ1) + b*Math.cos(φ2)*Math.sin(λ2);
    const z = a*Math.sin(φ1) + b*Math.sin(φ2);
    pts.push([toDeg(Math.atan2(z, Math.sqrt(x*x + y*y))), toDeg(Math.atan2(y, x))]);
  }
  return pts;
}

// Normalize a polyline so longitudes are continuous (no >180° jumps).
// Leaflet handles coordinates outside [-180,180] fine — this lets
// transpacific routes render correctly across the antimeridian.
function normalizeLonContinuity(pts) {
  if (!pts || pts.length < 2) return pts || [];
  const out = [[pts[0][0], pts[0][1]]];
  for (let i = 1; i < pts.length; i++) {
    let lon = pts[i][1];
    const prevLon = out[i - 1][1];
    // Shift lon to be within ±180 of previous point
    while (lon - prevLon > 180) lon -= 360;
    while (lon - prevLon < -180) lon += 360;
    out.push([pts[i][0], lon]);
  }
  return out;
}

// Legacy wrapper — no longer splits; just returns a single continuous segment
function splitAtAntimeridian(pts) {
  return [normalizeLonContinuity(pts)];
}

// ═══ STATS ═══
function updateStats() {
  const filtered = getFilteredFlights();
  let airborne = 0, ground = 0, climbing = 0, cruising = 0, descending = 0;
  let totalAlt = 0, altCount = 0, totalSpd = 0, spdCount = 0, starlinkAirborne = 0;

  filtered.forEach(f => {
    const p = getPhase(f.alt, f.vr, f.spd);
    if (f.onGround) ground++;
    else {
      airborne++;
      if (p.phase === 'Climb' || p.phase === 'Takeoff') climbing++;
      else if (p.phase === 'Cruise' || p.phase === 'En Route') cruising++;
      else if (p.phase === 'Descent' || p.phase === 'Approach') descending++;

      if (f.alt) { totalAlt += f.alt * 3.28084; altCount++; }
      if (f.spd) { totalSpd += f.spd * 1.944; spdCount++; }

      const ac = matchAircraft(f);
      if (ac && STARLINK_TAILS.has(ac.r)) starlinkAirborne++;
      else if (f.reg && STARLINK_TAILS.has(f.reg)) starlinkAirborne++;
    }
  });

  const filterLabel = (activeHubFilter || activePhaseFilter) ? ' (filtered)' : '';
  document.getElementById('st-airborne').textContent = airborne;
  document.getElementById('st-ground').textContent = ground;
  document.getElementById('st-climb').textContent = climbing;
  document.getElementById('st-cruise').textContent = cruising;
  document.getElementById('st-desc').textContent = descending;
  document.getElementById('st-avgalt').textContent = altCount ? Math.round(totalAlt / altCount).toLocaleString() + 'ft' : '--';
  document.getElementById('st-avgspd').textContent = spdCount ? Math.round(totalSpd / spdCount) + 'kts' : '--';
  document.getElementById('st-util').textContent = FLEET_DB.length ? Math.round((airborne / FLEET_DB.length) * 100) + '%' + filterLabel : '--';
  document.getElementById('st-starlink').textContent = starlinkAirborne;

  // Phase stats sidebar (always show total counts from allFlights, but make clickable)
  let allGround = 0, allClimb = 0, allCruise = 0, allDescent = 0, allApproach = 0;
  allFlights.forEach(f => {
    const p = getPhase(f.alt, f.vr, f.spd);
    const g = getPhaseGroup(p.phase);
    if (g === 'Ground') allGround++;
    else if (g === 'Climb') allClimb++;
    else if (g === 'Cruise') allCruise++;
    else if (g === 'Descent') allDescent++;
    else if (g === 'Approach') allApproach++;
  });

  document.getElementById('phase-stats').innerHTML = [
    ['🅿️ Ground', allGround, 'Ground'], ['🛫 Climb', allClimb, 'Climb'],
    ['✈️ Cruise', allCruise, 'Cruise'], ['↘️ Descent', allDescent, 'Descent'],
    ['🛬 Approach', allApproach, 'Approach']
  ].map(([label, val, key]) =>
    `<div class="phase-row${activePhaseFilter === key ? ' phase-selected' : ''}" data-action="toggle-phase-filter" data-phase="${key}" role="button" tabindex="0"><span style="color:var(--ua-muted)">${label}</span><span style="color:var(--ua-accent);font-weight:700">${val}</span></div>`
  ).join('');
}

function togglePhaseFilter(phase) {
  activePhaseFilter = activePhaseFilter === phase ? null : phase;
  updateMarkers();
  updateStats();
}

function toggleHubFilter(iata) {
  if (activeHubFilter === iata) {
    activeHubFilter = null;
    map.setView([39, -98], 4);
  } else {
    activeHubFilter = iata;
    const hub = HUBS.find(h => h.iata === iata);
    if (hub) map.setView([hub.lat, hub.lon], 7);
  }
  updateMarkers();
  updateStats();
  updateHubStats();
}

function clearAllFilters() {
  activeHubFilter = null;
  activePhaseFilter = null;
  map.setView([39, -98], 4);
  updateMarkers();
  updateStats();
  updateHubStats();
}

function updateHubStats() {
  const hubData = {};
  HUB_CODES.forEach(h => { hubData[h] = { inbound: 0, outbound: 0 }; });

  allFlights.forEach(f => {
    if (f.onGround) return;
    // Use FR24's real origin/dest
    if (f.origin && hubData[f.origin] !== undefined) hubData[f.origin].outbound++;
    if (f.dest && hubData[f.dest] !== undefined) hubData[f.dest].inbound++;
  });

  let maxTotal = 0, busiestHub = '';
  HUB_CODES.forEach(h => {
    const t = hubData[h].inbound + hubData[h].outbound;
    if (t > maxTotal) { maxTotal = t; busiestHub = h; }
  });

  let html = `<div class="show-all-btn" data-action="clear-filters">⊘ SHOW ALL</div>`;
  html += HUB_CODES.map(h => {
    const d = hubData[h];
    const total = d.inbound + d.outbound;
    const pct = maxTotal > 0 ? (total / maxTotal * 100) : 0;
    const isBusiest = h === busiestHub;
    const isSelected = activeHubFilter === h;
    return `<div class="hub-row${isSelected ? ' hub-selected' : ''}" data-action="toggle-hub-filter" data-hub="${h}">
      <div><span class="hub-code">${h}</span>${isBusiest ? ' <span class="busiest-badge">BUSIEST</span>' : ''}${isSelected ? ' <span style="font-size:9px;color:var(--ua-green)">✓ FILTERED</span>' : ''}</div>
      <div class="hub-counts">↗ ${d.outbound} ↙ ${d.inbound}</div>
    </div>
    <div style="padding:0 12px 6px"><div class="hub-bar"><div class="hub-bar-fill" style="width:${pct}%"></div></div></div>`;
  }).join('');
  document.getElementById('hub-stats').innerHTML = html;
}

// ═══ SEARCH ═══
document.getElementById('search-input-side').addEventListener('input', debounce(function() {
  const q = this.value.trim().toUpperCase();
  const results = document.getElementById('search-results-side');
  if (q.length < 2) { results.innerHTML = ''; return; }

  const allMatches = allFlights.filter(f => {
    const cs = (f.callsign || '').toUpperCase();
    const flt = (f.flightIATA || '').toUpperCase();
    const reg = (f.reg || '').toUpperCase();
    const routeStr = ((f.origin || '') + (f.dest || '')).toUpperCase();
    return cs.includes(q) || flt.includes(q) || reg.includes(q) || routeStr.includes(q);
  });
  const matches = allMatches.slice(0, 50);

  // Check if query matches a hub code — suggest hub filter
  const isHub = HUB_CODES.includes(q);
  const hubHint = isHub ? `<div style="padding:6px 12px;font-size:10px;background:rgba(0,93,170,.1);border-bottom:1px solid var(--ua-border);cursor:pointer" data-action="toggle-hub-filter" data-hub="${q}"><span style="color:var(--ua-accent)">🏢 Filter map to ${q}</span> <span style="color:var(--ua-muted)">(${allMatches.length} flights)</span></div>` : '';
  const countHeader = `<div style="padding:4px 12px;font-size:9px;color:var(--ua-muted);border-bottom:1px solid var(--ua-border)">${allMatches.length} flight${allMatches.length !== 1 ? 's' : ''} found${allMatches.length > 50 ? ' (showing 50)' : ''}</div>`;

  if (allMatches.length === 0) {
    results.innerHTML = `<div style="padding:10px 12px;color:var(--ua-muted);font-size:10px;line-height:1.5">
      <div style="margin-bottom:4px">No flights matching "${escapeHtml(q)}"</div>
      <div style="font-size:9px">✈️ Flights at the gate or boarding may not appear until after pushback. Check the <strong style="color:var(--ua-accent);cursor:pointer" data-action="switch-tab" data-tab="tab-schedule">Schedule</strong> tab for gate status.</div>
    </div>`;
  } else {
    results.innerHTML = hubHint + countHeader + matches.map(f => {
      const routeStr = (f.origin || '???') + '→' + (f.dest || '???');
      return `<div class="search-result" data-action="focus-flight" data-icao24="${escapeHtml(f.icao24)}">${escapeHtml(f.flightIATA || f.callsign || f.icao24)} <span style="color:var(--ua-muted)">${escapeHtml(routeStr)} ${escapeHtml(f.reg || '')}</span></div>`;
    }).join('');
  }
}, 150));

function focusFlight(icao24) {
  const f = allFlights.find(fl => fl.icao24 === icao24);
  if (f && flightMarkers[icao24]) {
    // Use marker's actual position (already IDL-normalized)
    const markerPos = flightMarkers[icao24].getLatLng();
    map.setView(markerPos, 8);
    showFlightPopup(f, flightMarkers[icao24]);
  }
}

// ═══ TICKER ═══
function updateTicker() {
  const airborne = allFlights.filter(f=>!f.onGround).length;
  const items = [];

  if (allFlights.length > 0) {
    items.push({ text: `${airborne} United flights airborne`, cls: 'info' });
    items.push({ text: `Fleet: ${FLEET_DB.length} mainline aircraft`, cls: 'info' });
    items.push({ text: `${STARLINK_TAILS.size} Starlink-equipped aircraft (incl. United Express)`, cls: 'info' });
  }

  // Check for emergency squawks
  allFlights.forEach(f => {
    const sq = decodeSquawk(f.squawk);
    if (sq && sq.cls === 'squawk-alert') {
      items.push({ text: `${sq.text}: ${escapeHtml(f.callsign)} (${escapeHtml(f.squawk)})`, cls: 'critical' });
    }
  });

  // Default message when no alerts
  if (items.length === 0 || items.every(i => i.cls === 'info')) {
    const countStr = allFlights.length > 0 ? ` — tracking ${allFlights.length} United flights` : '';
    items.unshift({ text: `✅ All systems normal${countStr}`, cls: 'info' });
  }

  const tickerHtml = items.map(i => `<span class="ticker-item ${escapeHtml(i.cls)}">${escapeHtml(i.text)}</span>`).join('');
  document.getElementById('ticker').innerHTML = tickerHtml + tickerHtml; // duplicate for seamless scroll
}

// ═══ FLEET TAB ═══
function initFleetTab() {
  // Set dynamic fleet count in title
  document.getElementById('fleet-overview-title').textContent = `Fleet Overview — ${FLEET_DB.length} Mainline Aircraft`;

  // Type chips
  const typeCounts = {};
  FLEET_DB.forEach(a => { typeCounts[a.t] = (typeCounts[a.t] || 0) + 1; });
  const typeOrder = ["A319","A320","A321neo","737-700","737-800","737-900","737-900ER","737 MAX 8","737 MAX 9","757-200","757-300","767-300ER","767-400ER","777-200","777-200ER","777-300ER","787-8","787-9","787-10"];
  const icons = {'A319':'🔹','A320':'🔹','737-700':'🔸','737-800':'🔸','737-900':'🔸','737 MAX':'⭐','757':'🔷','767':'🔷','777':'💎','777-200':'💎','787-8':'🌟','777-300ER':'👑'};

  document.getElementById('fleet-chips').innerHTML = typeOrder.map(t =>
    `<div class="fleet-chip" data-action="filter-fleet-type" data-type="${t}">
      <div style="font-size:14px">${icons[t]||'✈️'}</div>
      <div class="count">${typeCounts[t]||0}</div>
      <div class="label">${t}</div>
    </div>`
  ).join('');

  // Starlink progress
  const mainlineStarlink = STARLINK_DB.filter(s => s.fleet === 'Mainline').length;
  document.getElementById('starlink-progress').style.width = (mainlineStarlink / FLEET_DB.length * 100) + '%';
  document.getElementById('starlink-pct').textContent = Math.round(mainlineStarlink / FLEET_DB.length * 100) + '% (' + mainlineStarlink + '/' + FLEET_DB.length + ')';

  // Populate filters
  const wifiTypes = [...new Set(FLEET_DB.map(a => a.w).filter(Boolean))].sort();
  document.getElementById('fleet-filter-type').innerHTML = '<option value="">All Types</option>' +
    typeOrder.map(t => `<option value="${t}">${t} (${typeCounts[t]||0})</option>`).join('');
  document.getElementById('fleet-filter-wifi').innerHTML = '<option value="">All WiFi</option>' +
    wifiTypes.map(w => `<option value="${w}">${w}</option>`).join('');

  renderFleetTable();
  renderAgeChart();
  renderStarlinkTable();
  initStarlinkFilters();

  // Filter listeners
  const debouncedFleetRender = debounce(renderFleetTable, 120);
  ['fleet-filter-type','fleet-filter-wifi','fleet-filter-status','fleet-search'].forEach(id => {
    document.getElementById(id).addEventListener('input', debouncedFleetRender);
    document.getElementById(id).addEventListener('change', debouncedFleetRender);
  });
}

let fleetSortCol = 'r', fleetSortAsc = true;
function renderFleetTable() {
  const typeF = document.getElementById('fleet-filter-type').value;
  const wifiF = document.getElementById('fleet-filter-wifi').value;
  const statusF = document.getElementById('fleet-filter-status').value;
  const searchF = document.getElementById('fleet-search').value.toUpperCase();

  let data = FLEET_DB.filter(a => {
    if (typeF && a.t !== typeF) return false;
    if (wifiF && a.w !== wifiF) return false;
    if (statusF === 'active' && a.s) return false;
    if (statusF === 'stored' && !a.s) return false;
    if (statusF === 'starlink' && !STARLINK_TAILS.has(a.r)) return false;
    if (searchF && !a.r.toUpperCase().includes(searchF) && !a.c.toUpperCase().includes(searchF) && !a.t.toUpperCase().includes(searchF)) return false;
    return true;
  });

  data.sort((a, b) => {
    let va = a[fleetSortCol] || '', vb = b[fleetSortCol] || '';
    if (fleetSortCol === 'tot' || fleetSortCol === 'd' || fleetSortCol === 'a') {
      va = parseInt(va) || 0; vb = parseInt(vb) || 0;
    }
    return fleetSortAsc ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
  });

  document.getElementById('fleet-tbody').innerHTML = data.map(a => {
    const isSL = STARLINK_TAILS.has(a.r);
    const rowCls = a.s ? (a.s.toLowerCase().includes('stored') ? 'row-stored' : 'row-maint') : '';
    return `<tr class="${rowCls}">
      <td style="font-weight:700;color:var(--ua-accent)">${escapeHtml(a.r)}</td>
      <td>${escapeHtml(a.t)}</td><td>${escapeHtml(a.a)}</td><td>${escapeHtml(a.c)}</td>
      <td>${escapeHtml(a.tot || '')}</td><td>${escapeHtml(a.w)}</td><td>${escapeHtml(a.i)}</td><td>${escapeHtml(a.d)}</td>
      <td style="font-size:9px;max-width:120px;overflow:hidden;text-overflow:ellipsis">${escapeHtml(a.s)}</td>
      <td>${isSL ? '<span class="starlink-badge">⚡</span>' : ''}</td>
    </tr>`;
  }).join('');
}

// Sort handler
document.querySelectorAll('#fleet-table thead th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.sort;
    if (fleetSortCol === col) fleetSortAsc = !fleetSortAsc;
    else { fleetSortCol = col; fleetSortAsc = true; }
    renderFleetTable();
  });
});

function filterFleetType(type) {
  document.getElementById('fleet-filter-type').value = type;
  document.querySelectorAll('.fleet-chip').forEach(c => c.classList.toggle('active', c.dataset.type === type));
  renderFleetTable();
  showConfigGallery(type);
}

function showConfigGallery(type) {
  const aircraft = FLEET_DB.filter(a => a.t === type);
  const configs = {};
  aircraft.forEach(a => {
    const key = a.c || 'Unknown';
    if (!configs[key]) configs[key] = { count: 0, seats: a.seats, total: a.tot };
    configs[key].count++;
  });

  const colors = { J: '#2563eb', PP: '#0d9488', PE: '#0d9488', F: '#7c3aed', 'E+': '#16a34a', Y: '#475569', Domestic: '#6366f1' };
  let html = `<div style="font-size:13px;font-weight:700;color:var(--ua-accent);margin-bottom:8px">${type} Configurations</div>`;

  for (const [cfg, data] of Object.entries(configs)) {
    html += `<div style="margin-bottom:8px;padding:8px;background:rgba(0,0,0,.2);border-radius:4px">`;
    html += `<div style="font-size:10px;margin-bottom:4px"><strong>${cfg}</strong> <span style="color:var(--ua-muted)">(${data.count} aircraft, ${data.total} seats)</span></div>`;
    html += `<div class="config-gallery">`;
    for (const [cls, cnt] of Object.entries(data.seats)) {
      const w = Math.max(30, cnt / 2);
      html += `<div class="config-block" style="background:${colors[cls]||'#475569'};width:${w}px">${cnt}${cls}</div>`;
    }
    html += `</div></div>`;
  }

  document.getElementById('config-display').innerHTML = html;
}

function renderAgeChart() {
  const familyColor = {
    'A319': '#8b5cf6', 'A320': '#8b5cf6', 'A321neo': '#a78bfa',
    '737-700': '#3b82f6', '737-800': '#3b82f6', '737-900': '#3b82f6', '737-900ER': '#3b82f6',
    '737 MAX 8': '#22c55e', '737 MAX 9': '#22c55e',
    '757-200': '#f59e0b', '757-300': '#f59e0b',
    '767-300ER': '#ef4444', '767-400ER': '#ef4444',
    '777-200': '#ec4899', '777-200ER': '#ec4899', '777-300ER': '#ec4899',
    '787-8': '#06b6d4', '787-9': '#06b6d4', '787-10': '#06b6d4'
  };
  const familyNames = {
    '#8b5cf6': 'A320 family', '#a78bfa': 'A321neo', '#3b82f6': '737NG',
    '#22c55e': '737 MAX', '#f59e0b': '757', '#ef4444': '767',
    '#ec4899': '777', '#06b6d4': '787'
  };

  // Group by year and family
  const yearData = {};
  FLEET_DB.forEach(a => {
    const y = parseInt(a.d);
    if (!y || y < 1990 || y > 2030) return;
    if (!yearData[y]) yearData[y] = { total: 0, families: {} };
    yearData[y].total++;
    const color = familyColor[a.t] || '#64748b';
    yearData[y].families[color] = (yearData[y].families[color] || 0) + 1;
  });

  const minYear = Math.min(...Object.keys(yearData).map(Number));
  const maxYear = Math.max(...Object.keys(yearData).map(Number));
  const allYears = [];
  for (let y = minYear; y <= maxYear; y++) allYears.push(y);

  const maxCount = Math.max(...Object.values(yearData).map(d => d.total), 1);
  const barH = 140;

  // Build stacked bars
  let barsHtml = '<div style="display:flex;align-items:flex-end;gap:1px;height:' + barH + 'px;padding:0">';
  allYears.forEach(y => {
    const d = yearData[y];
    if (!d) {
      barsHtml += `<div style="flex:1;display:flex;flex-direction:column;align-items:center;min-width:0"><div style="height:${barH}px"></div></div>`;
      return;
    }
    const totalH = (d.total / maxCount) * barH;
    let stackHtml = '';
    // Stack segments bottom-up
    const segments = Object.entries(d.families).sort((a, b) => b[1] - a[1]);
    segments.forEach(([color, count]) => {
      const segH = Math.max(1, (count / d.total) * totalH);
      stackHtml += `<div style="width:100%;height:${segH}px;background:${color};min-height:1px" title="${count} aircraft"></div>`;
    });

    const showLabel = d.total >= 15;
    barsHtml += `<div style="flex:1;display:flex;flex-direction:column;align-items:center;min-width:0;cursor:default" title="${y}: ${d.total} aircraft">`;
    if (showLabel) barsHtml += `<div style="font-size:8px;color:var(--ua-accent);margin-bottom:1px;font-weight:700">${d.total}</div>`;
    barsHtml += `<div style="width:100%;display:flex;flex-direction:column;border-radius:2px 2px 0 0;overflow:hidden">${stackHtml}</div>`;
    barsHtml += `</div>`;
  });
  barsHtml += '</div>';

  // Year labels (show every 5 years + first/last)
  barsHtml += '<div style="display:flex;gap:1px">';
  allYears.forEach(y => {
    const show = y === minYear || y === maxYear || y % 5 === 0;
    barsHtml += `<div style="flex:1;text-align:center;font-size:8px;color:${show ? 'var(--ua-muted)' : 'transparent'};min-width:0;overflow:hidden">${show ? y : '·'}</div>`;
  });
  barsHtml += '</div>';

  // Legend
  const usedColors = new Set();
  FLEET_DB.forEach(a => { const c = familyColor[a.t]; if (c) usedColors.add(c); });
  barsHtml += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">';
  [...usedColors].forEach(c => {
    barsHtml += `<span style="font-size:9px;color:var(--ua-muted);display:flex;align-items:center;gap:3px"><span style="width:8px;height:8px;background:${c};border-radius:2px;display:inline-block"></span>${familyNames[c] || '?'}</span>`;
  });
  barsHtml += '</div>';

  document.getElementById('age-chart').innerHTML = barsHtml;

  // Stats
  const currentYear = new Date().getFullYear();
  const ages = FLEET_DB.filter(a => parseInt(a.d)).map(a => currentYear - parseInt(a.d));
  const avgAge = ages.length ? (ages.reduce((a, b) => a + b, 0) / ages.length).toFixed(1) : '--';
  const newest = FLEET_DB.filter(a => parseInt(a.d)).sort((a, b) => parseInt(b.d) - parseInt(a.d))[0];
  const oldest = FLEET_DB.filter(a => parseInt(a.d)).sort((a, b) => parseInt(a.d) - parseInt(b.d))[0];

  // Decade breakdown
  const decades = {'0-5y': 0, '6-10y': 0, '11-15y': 0, '16-20y': 0, '20y+': 0};
  ages.forEach(a => {
    if (a <= 5) decades['0-5y']++;
    else if (a <= 10) decades['6-10y']++;
    else if (a <= 15) decades['11-15y']++;
    else if (a <= 20) decades['16-20y']++;
    else decades['20y+']++;
  });

  document.getElementById('age-stats').innerHTML =
    `Average: <strong style="color:var(--ua-accent)">${avgAge}y</strong> · ` +
    `Newest: <strong style="color:var(--ua-green)">${newest?.r} (${newest?.d})</strong> · ` +
    `Oldest: <strong style="color:var(--ua-yellow)">${oldest?.r} (${oldest?.d})</strong><br>` +
    Object.entries(decades).map(([k, v]) => `<span style="margin-right:8px">${k}: <strong>${v}</strong></span>`).join('');
}

let starlinkSortKey = 'tail', starlinkSortAsc = true;

function initStarlinkFilters() {
  // Populate type and operator dropdowns from actual data
  const types = [...new Set(STARLINK_DB.map(s => s.type))].sort();
  const operators = [...new Set(STARLINK_DB.map(s => s.operator))].sort();
  const typeSelect = document.getElementById('starlink-filter-type');
  const opSelect = document.getElementById('starlink-filter-operator');
  types.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; typeSelect.appendChild(o); });
  operators.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; opSelect.appendChild(o); });

  // Event listeners for filters
  ['starlink-search', 'starlink-filter-fleet', 'starlink-filter-type', 'starlink-filter-operator'].forEach(id => {
    document.getElementById(id).addEventListener(id === 'starlink-search' ? 'input' : 'change', renderStarlinkTable);
  });

  // Sort headers
  document.querySelectorAll('[data-starlink-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.getAttribute('data-starlink-sort');
      if (starlinkSortKey === key) starlinkSortAsc = !starlinkSortAsc;
      else { starlinkSortKey = key; starlinkSortAsc = true; }
      renderStarlinkTable();
    });
  });
}

function renderStarlinkTable() {
  const search = (document.getElementById('starlink-search').value || '').trim().toUpperCase();
  const fleetFilter = document.getElementById('starlink-filter-fleet').value;
  const typeFilter = document.getElementById('starlink-filter-type').value;
  const opFilter = document.getElementById('starlink-filter-operator').value;

  let filtered = STARLINK_DB.filter(s => {
    if (search && !s.tail.toUpperCase().includes(search)) return false;
    if (fleetFilter && s.fleet !== fleetFilter) return false;
    if (typeFilter && s.type !== typeFilter) return false;
    if (opFilter && s.operator !== opFilter) return false;
    return true;
  });

  filtered.sort((a, b) => {
    const va = (a[starlinkSortKey] || '').toLowerCase();
    const vb = (b[starlinkSortKey] || '').toLowerCase();
    return starlinkSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
  });

  document.getElementById('starlink-filtered-count').textContent = filtered.length < STARLINK_DB.length ? `${filtered.length} of ${STARLINK_DB.length}` : '';
  document.getElementById('starlink-count').textContent = STARLINK_DB.length;

  document.getElementById('starlink-tbody').innerHTML = filtered.map(s =>
    `<tr><td style="font-weight:700;color:var(--ua-green)">${escapeHtml(s.tail)}</td><td>${escapeHtml(s.fleet)}</td><td>${escapeHtml(s.type)}</td><td style="font-size:10px">${escapeHtml(s.operator)}</td></tr>`
  ).join('');
}

// ═══ FLEET DATA REFRESH ═══
function refreshFleetData() {
  // Fleet data is embedded at build time — a page reload pulls the latest deployment
  location.reload();
}

// ═══ WEATHER TAB ═══
let weatherInitialized = false;
const HUB_NAMES = {EWR:"Newark Liberty",IAH:"Houston Intercontinental",ORD:"O'Hare International",DEN:"Denver International",SFO:"San Francisco Int'l",LAX:"Los Angeles Int'l",IAD:"Washington Dulles",NRT:"Tokyo Narita",GUM:"Guam Int'l"};
const CAT_COLORS = {VFR:'#22c55e',MVFR:'#eab308',IFR:'#ef4444',LIFR:'#c026d3'};

// Compute flight category from raw METAR — strict AIM standard (ceiling + vis only)
function computeFlightCategory(rawMetar) {
  if (!rawMetar) return null;
  // Parse visibility (handle "1 1/2SM", "3SM", "1/2SM")
  let visSM = 99;
  const vmMixed = rawMetar.match(/\b(\d+)\s+(\d+)\/(\d+)SM\b/);
  if (vmMixed) visSM = parseInt(vmMixed[1]) + parseInt(vmMixed[2]) / parseInt(vmMixed[3]);
  else { const vm = rawMetar.match(/\b(\d+)\s*SM\b/); if (vm) visSM = parseInt(vm[1]); }
  const vf = rawMetar.match(/\b(\d+)\/(\d+)SM\b/);
  if (vf && !vmMixed) visSM = parseInt(vf[1]) / parseInt(vf[2]);
  // Parse ceiling (lowest BKN or OVC)
  let ceiling = 99999;
  const cm = [...rawMetar.matchAll(/(BKN|OVC)(\d{3})/g)];
  if (cm.length) ceiling = parseInt(cm[0][2]) * 100;
  // Standard AIM flight category rules
  if (visSM < 1 || ceiling < 500) return 'LIFR';
  if (visSM < 3 || ceiling < 1000) return 'IFR';
  if (visSM <= 5 || ceiling <= 3000) return 'MVFR';
  return 'VFR';
}

// Compute operational impact — considers wind, precip, phenomena beyond just ceiling/vis
// Returns: {level: 'normal'|'caution'|'warning'|'severe', reasons: string[], color: string}
const OPS_COLORS = {normal:'#22c55e',caution:'#eab308',warning:'#ef4444',severe:'#c026d3'};
function computeOpsImpact(rawMetar, fltCat) {
  const reasons = [];
  let level = 'normal';
  const bump = (to) => {
    const rank = {normal:0,caution:1,warning:2,severe:3};
    if (rank[to] > rank[level]) level = to;
  };

  if (!rawMetar) return {level, reasons, color: OPS_COLORS[level]};

  // Flight category impact
  if (fltCat === 'LIFR') { bump('severe'); reasons.push('very low ceilings/visibility'); }
  else if (fltCat === 'IFR') { bump('warning'); reasons.push('instrument conditions'); }
  else if (fltCat === 'MVFR') { bump('caution'); reasons.push('marginal ceilings/visibility'); }

  // Wind/gusts
  const wm = rawMetar.match(/\b\d{3}(\d{2,3})(G(\d{2,3}))?KT\b/);
  if (wm) {
    const spd = parseInt(wm[1]), gust = wm[3] ? parseInt(wm[3]) : spd;
    if (gust >= 40) { bump('warning'); reasons.push(`gusts ${gust}kt`); }
    else if (gust >= 30) { bump('caution'); reasons.push(`gusts ${gust}kt`); }
  }

  // Weather phenomena — parse ALL groups, not just first
  const wxAll = [...rawMetar.matchAll(/\s([+-]?(?:VC)?(?:MI|PR|BC|DR|BL|SH|TS|FZ)?(?:DZ|RA|SN|SG|IC|PL|GR|GS|UP|BR|FG|FU|VA|DU|SA|HZ|PY|PO|SQ|FC|SS|DS)+)(?=\s)/g)];
  const wxCombined = wxAll.map(m => m[1]).join(' ');
  if (wxCombined.includes('TS')) { bump('warning'); reasons.push('thunderstorms'); }
  if (wxCombined.includes('FZ')) { bump('warning'); reasons.push('freezing precipitation'); }
  if (wxCombined.includes('SN')) { bump('caution'); reasons.push('snow'); }
  if (wxCombined.match(/\+/) && (wxCombined.includes('RA') || wxCombined.includes('SN'))) { bump('warning'); reasons.push('heavy precipitation'); }
  else if (wxCombined.includes('RA') || wxCombined.includes('DZ') || wxCombined.includes('SH')) { bump('caution'); reasons.push('precipitation'); }
  if (wxCombined.includes('FG')) { bump('caution'); reasons.push('fog'); }

  // Low clouds + active precip (even if not technically ceiling)
  const allClouds = [...rawMetar.matchAll(/(FEW|SCT|BKN|OVC)(\d{3})/g)];
  const lowestAlt = allClouds.length ? parseInt(allClouds[0][2]) * 100 : 99999;
  if (lowestAlt <= 1500 && wxAll.length > 0 && level === 'normal') {
    bump('caution'); reasons.push('low clouds with active weather');
  }

  // Deduplicate reasons
  const unique = [...new Set(reasons)];
  return {level, reasons: unique, color: OPS_COLORS[level]};
}

function parseMetarQuick(raw) {
  const r = {temp:'--',wind:'Calm',vis:'--',clouds:'Clear'};
  if (!raw) return r;
  const wm = raw.match(/\b(\d{3})(\d{2,3})(G(\d{2,3}))?KT\b/);
  if (wm) { r.wind = `${wm[1]}° @ ${wm[2]}kt${wm[4]?' G'+wm[4]:''}`;} else if(raw.includes('00000KT')){r.wind='Calm';}
  const vm = raw.match(/\b(\d+)\s*SM\b/) || raw.match(/\b(\d+\/\d+)SM\b/);
  if (vm) r.vis = vm[0].replace('SM','').trim()+' SM';
  const tm = raw.match(/\b(M?\d{2})\/(M?\d{2})\b/);
  if (tm) { const c=parseInt(tm[1].replace('M','-')); r.temp=`${c}°C / ${Math.round(c*9/5+32)}°F`;}
  const cm = [...raw.matchAll(/(FEW|SCT|BKN|OVC)(\d{3})/g)];
  const cn = {FEW:'Few',SCT:'Scattered',BKN:'Broken',OVC:'Overcast'};
  if (cm.length) { const l=cm[0]; r.clouds=`${cn[l[1]]||l[1]} ${parseInt(l[2])*100}ft`;} else if(raw.includes('CLR')||raw.includes('SKC')){r.clouds='Clear';}
  return r;
}

async function initWeatherTab() {
  if (weatherInitialized) return;
  weatherInitialized = true;
  // Ensure IRROPS data is loading (may not have fired from idle preload yet)
  fetchIrropsFromAPI();

  const hubStations = {EWR:'KEWR',IAH:'KIAH',ORD:'KORD',DEN:'KDEN',SFO:'KSFO',LAX:'KLAX',IAD:'KIAD',NRT:'RJAA',GUM:'PGUM'};
  const hubs = Object.keys(hubStations);

  // Show loading skeletons for hub cards immediately
  const hubCardsEl = document.getElementById('hub-cards');
  hubCardsEl.innerHTML = hubs.map(h => `<div class="hub-card" style="border-top:3px solid #334155;opacity:0.5"><div class="hub-card-top"><span class="hub-card-code">${h}</span><span class="cat-badge" style="background:#334155;color:#94a3b8">…</span></div><div class="hub-card-name">${HUB_NAMES[h]||h}</div><div style="padding:20px;text-align:center;color:var(--ua-muted);font-size:10px">Loading…</div></div>`).join('');

  // Initialize radar map IMMEDIATELY — don't wait for data fetches
  const radarMap = L.map('radar-map', {center:[39,-98],zoom:4,zoomControl:true,attributionControl:false});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:18,subdomains:'abcd'}).addTo(radarMap);
  L.tileLayer('https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png',{opacity:0.6}).addTo(radarMap);
  document.getElementById('radar-title').textContent = `🌧 NEXRAD Radar — ${new Date().toUTCString().slice(17,25)}Z`;

  // Place hub markers immediately with neutral color (updated after METAR loads)
  const radarHubMarkers = {};
  hubs.forEach(hub => {
    const h = HUBS.find(x=>x.iata===hub);
    if (h) {
      radarHubMarkers[hub] = L.circleMarker([h.lat,h.lon],{radius:8,color:'#334155',fillColor:'#334155',fillOpacity:0.8,weight:2})
        .bindTooltip(`<b>${hub}</b>`,{permanent:true,direction:'top',className:'hub-tooltip',offset:[0,-8]})
        .addTo(radarMap);
    }
  });

  // Fetch ALL METARs in a single request + FAA in parallel (2 requests instead of 8)
  const allStations = Object.values(hubStations).join(',');
  const [metarData, faaData] = await Promise.all([
    fetch(`/api/metar?ids=${allStations}`).then(r=>r.json()).catch(()=>[]),
    fetch('/api/faa').then(r=>r.json()).catch(()=>[])
  ]);

  // Index METAR results by station ID → hub
  const stationToHub = {};
  for (const [hub, station] of Object.entries(hubStations)) stationToHub[station] = hub;
  const metarByHub = {};
  if (Array.isArray(metarData)) metarData.forEach(m => {
    const hub = stationToHub[m.icaoId || m.stationId] || stationToHub[m.id];
    if (hub) metarByHub[hub] = m;
  });
  const metarResults = hubs.map(hub => ({hub, data: metarByHub[hub] || null}));

  // Index FAA delays by airport code
  const faaIndex = {};
  if (Array.isArray(faaData)) faaData.forEach(d => { faaIndex[d.airportCode||d.airport] = d; });
  // Store globally for IRROPS & schedule cross-reference
  faaDelayIndex = faaIndex;

  // Build cards + map markers
  let cardsHtml = '';
  metarResults.forEach(({hub, data}) => {
    const raw = data ? (data.rawOb || '') : '';
    const apiCat = data ? (data.fltCat || data.fltcat || 'UNK') : 'UNK';
    const localCat = computeFlightCategory(raw);
    // Use the worse (more restrictive) of API vs local computation
    const catRank = {LIFR:0,IFR:1,MVFR:2,VFR:3,UNK:3};
    const cat = localCat && (catRank[localCat] ?? 3) < (catRank[apiCat] ?? 3) ? localCat : apiCat;
    const catColor = CAT_COLORS[cat] || '#64748b';
    const m = parseMetarQuick(raw);
    const faa = faaIndex[hub];
    const hasDelay = faa && faa.delays && faa.delays.length > 0;

    // Compute ops impact (weather + wind + phenomena)
    const ops = computeOpsImpact(raw, cat);
    // Card border uses worst of: flight category color or ops impact color
    const borderColor = ops.level !== 'normal' ? ops.color : catColor;

    // Status line: FAA delays take priority, then ops impact, then normal
    let faaLine;
    if (hasDelay) {
      faaLine = `<div class="hub-faa delay">⚠ ${faa.delays.map(d=>d.reason||d.type||'Delay').join(', ')}</div>`;
    } else if (ops.level === 'severe') {
      faaLine = `<div class="hub-faa delay">⚠ Severe Weather Impact — ${ops.reasons.join(', ')}</div>`;
    } else if (ops.level === 'warning') {
      faaLine = `<div class="hub-faa delay">⚠ Weather Advisory — ${ops.reasons.join(', ')}</div>`;
    } else if (ops.level === 'caution') {
      faaLine = `<div class="hub-faa" style="color:#eab308">⚠ Weather Caution — ${ops.reasons.join(', ')}</div>`;
    } else {
      faaLine = `<div class="hub-faa normal">✓ Normal Operations</div>`;
    }

    const explainer = data ? explainMETAR(raw, hub, cat) : '';
    const faaExplainer = faa ? explainFAAStatus(hub, faa.delays||[], faa) : '';

    cardsHtml += `<div class="hub-card" style="border-top:3px solid ${borderColor}">
      <div class="hub-card-top"><span class="hub-card-code">${hub}</span><span class="cat-badge" style="background:${catColor};color:#000">${cat}</span></div>
      <div class="hub-card-name">${HUB_NAMES[hub]||hub}</div>
      <div class="hub-metrics">
        <div class="hub-metric"><div class="hub-metric-label">Temperature</div><div class="hub-metric-val">${m.temp}</div></div>
        <div class="hub-metric"><div class="hub-metric-label">Wind</div><div class="hub-metric-val">${m.wind}</div></div>
        <div class="hub-metric"><div class="hub-metric-label">Visibility</div><div class="hub-metric-val">${m.vis}</div></div>
        <div class="hub-metric"><div class="hub-metric-label">Ceiling</div><div class="hub-metric-val">${m.clouds}</div></div>
      </div>
      ${faaLine}
      ${explainer?`<div class="hub-explainer">${explainer}</div>`:''}
      ${faaExplainer?`<div class="hub-explainer">${faaExplainer}</div>`:''}
      ${raw?`<div class="hub-raw">${escapeHtml(raw)}</div>`:''}
    </div>`;

    // Update radar map marker — use ops impact color for operational awareness
    if (radarHubMarkers[hub]) {
      radarHubMarkers[hub].setStyle({color:borderColor,fillColor:borderColor});
      radarHubMarkers[hub].unbindTooltip();
      const opsTag = ops.level !== 'normal' ? ` (${ops.reasons[0] || ops.level})` : '';
      radarHubMarkers[hub].bindTooltip(`<b>${hub}</b> ${cat}${opsTag}`,{permanent:true,direction:'top',className:'hub-tooltip',offset:[0,-8]});
    }
  });

  if (!cardsHtml) {
    cardsHtml = '<div class="error-state" style="grid-column:1/-1"><div class="error-icon">🌦</div><div style="color:var(--ua-text)">Weather data unavailable</div><div style="color:var(--ua-muted);font-size:11px">Could not load METAR observations</div><button class="retry-btn" data-action="weather-retry">↻ Retry</button></div>';
  }
  document.getElementById('hub-cards').innerHTML = cardsHtml;
}

// ═══ ANALYTICS TAB ═══
function updateAnalytics() {
  const airborneFlights = allFlights.filter(f => !f.onGround);
  const airborne = airborneFlights.length;
  const currentYear = new Date().getFullYear();
  const ages = FLEET_DB.filter(a => parseInt(a.d)).map(a => currentYear - parseInt(a.d));
  const avgAge = ages.length ? (ages.reduce((a, b) => a + b, 0) / ages.length).toFixed(1) : '--';

  // Count Starlink airborne
  let starlinkAirborne = 0;
  airborneFlights.forEach(f => {
    const ac = matchAircraft(f);
    if ((ac && STARLINK_TAILS.has(ac.r)) || (f.reg && STARLINK_TAILS.has(f.reg))) starlinkAirborne++;
  });
  const starlinkPct = airborne > 0 ? Math.round((starlinkAirborne / airborne) * 100) : 0;
  const utilPct = FLEET_DB.length ? Math.round((airborne / FLEET_DB.length) * 100) : 0;

  document.getElementById('analytics-metrics').innerHTML = [
    { val: airborne, label: 'Flights Airborne' },
    { val: utilPct + '%', label: 'Fleet Utilization' },
    { val: avgAge + 'y', label: 'Avg Fleet Age' },
    { val: starlinkPct + '%', label: 'Starlink Coverage', sub: `${starlinkAirborne} of ${airborne} airborne` }
  ].map(m => `<div class="metric-card"><div class="metric-val">${m.val}</div><div class="metric-label">${m.label}</div>${m.sub ? `<div style="font-size:8px;color:var(--ua-muted);margin-top:2px">${m.sub}</div>` : ''}</div>`).join('');

  // ═══ LIVE FLEET UTILIZATION ═══
  const typeOrder = ["A319","A320","A321neo","737-700","737-800","737-900","737-900ER","737 MAX 8","737 MAX 9","757-200","757-300","767-300ER","767-400ER","777-200","777-200ER","777-300ER","787-8","787-9","787-10"];
  const typeTotals = {};
  const typeAirborne = {};
  FLEET_DB.forEach(a => { typeTotals[a.t] = (typeTotals[a.t] || 0) + 1; });
  typeOrder.forEach(t => { typeAirborne[t] = 0; });

  airborneFlights.forEach(f => {
    const ac = matchAircraft(f);
    if (ac && typeAirborne[ac.t] !== undefined) typeAirborne[ac.t]++;
  });

  document.getElementById('util-chart').innerHTML = typeOrder.map(t => {
    const total = typeTotals[t] || 0;
    const flying = typeAirborne[t] || 0;
    const pct = total > 0 ? Math.round((flying / total) * 100) : 0;
    const color = pct > 60 ? '#22c55e' : pct > 30 ? '#005DAA' : pct > 0 ? '#f59e0b' : '#334155';
    return `<div style="display:flex;align-items:center;padding:4px 0;border-bottom:1px solid rgba(30,41,59,.3)">
      <span style="font-size:10px;min-width:85px;color:var(--ua-text)">${t}</span>
      <div style="flex:1;margin:0 8px;height:10px;background:var(--ua-border);border-radius:4px;overflow:hidden;position:relative">
        <div style="height:100%;width:${pct}%;background:${color};border-radius:4px;transition:width .5s"></div>
      </div>
      <span style="font-size:10px;font-weight:700;min-width:70px;text-align:right"><span style="color:${color}">${flying}</span><span style="color:var(--ua-muted)">/${total}</span> <span style="color:${color};font-size:9px">${pct}%</span></span>
    </div>`;
  }).join('');

  // ═══ AIRBORNE BY FLIGHT PHASE ═══
  const phaseCounts = { 'Takeoff': 0, 'Climb': 0, 'Cruise': 0, 'En Route': 0, 'Descent': 0, 'Approach': 0, 'Ground': 0 };
  const phaseColors = { 'Takeoff': '#22c55e', 'Climb': '#3b82f6', 'Cruise': '#005DAA', 'En Route': '#6366f1', 'Descent': '#f59e0b', 'Approach': '#ef4444', 'Ground': '#64748b' };
  const phaseIcons = { 'Takeoff': '🛫', 'Climb': '↗️', 'Cruise': '✈️', 'En Route': '✈️', 'Descent': '↘️', 'Approach': '🛬', 'Ground': '🅿️' };

  allFlights.forEach(f => {
    const p = getPhase(f.alt, f.vr, f.spd);
    if (phaseCounts[p.phase] !== undefined) phaseCounts[p.phase]++;
  });

  const phaseTotal = Object.values(phaseCounts).reduce((a, b) => a + b, 0) || 1;
  const phaseOrder = ['Cruise', 'Climb', 'Descent', 'En Route', 'Takeoff', 'Approach', 'Ground'];

  // Donut segments
  let donutSegments = '';
  let offset = 0;
  const donutData = phaseOrder.filter(p => phaseCounts[p] > 0);
  donutData.forEach(p => {
    const pct = (phaseCounts[p] / phaseTotal) * 100;
    donutSegments += `<circle cx="50" cy="50" r="36" fill="none" stroke="${phaseColors[p]}" stroke-width="12" stroke-dasharray="${pct * 2.26} ${226 - pct * 2.26}" stroke-dashoffset="${-offset * 2.26}" />`;
    offset += pct;
  });

  let phaseHtml = `<div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">`;
  phaseHtml += `<svg viewBox="0 0 100 100" style="width:120px;height:120px;flex-shrink:0">${donutSegments}<text x="50" y="48" text-anchor="middle" fill="var(--ua-text)" font-size="14" font-weight="700">${phaseTotal}</text><text x="50" y="60" text-anchor="middle" fill="var(--ua-muted)" font-size="6">flights</text></svg>`;
  phaseHtml += `<div style="flex:1;min-width:180px">`;
  phaseOrder.forEach(p => {
    const count = phaseCounts[p];
    if (count === 0) return;
    const pct = Math.round((count / phaseTotal) * 100);
    phaseHtml += `<div style="display:flex;align-items:center;gap:6px;padding:3px 0">
      <span style="font-size:12px">${phaseIcons[p]}</span>
      <span style="font-size:10px;min-width:65px;color:var(--ua-text)">${p}</span>
      <div style="flex:1;height:8px;background:var(--ua-border);border-radius:4px;overflow:hidden">
        <div style="height:100%;width:${pct}%;background:${phaseColors[p]};border-radius:4px;transition:width .5s"></div>
      </div>
      <span style="font-size:10px;font-weight:700;color:${phaseColors[p]};min-width:45px;text-align:right">${count} <span style="font-size:8px;color:var(--ua-muted)">${pct}%</span></span>
    </div>`;
  });
  phaseHtml += `</div></div>`;
  document.getElementById('phase-chart').innerHTML = phaseHtml;

  // ═══ HUB-TO-HUB FLOW MATRIX ═══
  const hubCodes = ['ORD','DEN','IAH','EWR','SFO','IAD','LAX','NRT','GUM'];
  const hubSet = new Set(hubCodes);
  const matrix = {};
  hubCodes.forEach(o => { matrix[o] = {}; hubCodes.forEach(d => { matrix[o][d] = 0; }); });

  airborneFlights.forEach(f => {
    if (f.origin && f.dest && hubSet.has(f.origin) && hubSet.has(f.dest) && f.origin !== f.dest) {
      matrix[f.origin][f.dest]++;
    }
  });

  // Find max for color scaling
  let matrixMax = 1;
  hubCodes.forEach(o => hubCodes.forEach(d => { if (matrix[o][d] > matrixMax) matrixMax = matrix[o][d]; }));

  let mHtml = `<table style="border-collapse:collapse;width:100%;font-family:var(--mono);font-size:10px">`;
  mHtml += `<thead><tr><th style="padding:4px 6px;color:var(--ua-muted);font-size:9px">FROM \\ TO</th>`;
  hubCodes.forEach(d => { mHtml += `<th style="padding:4px 6px;color:var(--ua-accent);text-align:center">${d}</th>`; });
  mHtml += `<th style="padding:4px 6px;color:var(--ua-muted);text-align:center;font-size:9px">TOTAL</th></tr></thead><tbody>`;

  hubCodes.forEach(o => {
    let rowTotal = 0;
    mHtml += `<tr><td style="padding:4px 6px;color:var(--ua-accent);font-weight:700">${o}</td>`;
    hubCodes.forEach(d => {
      const v = matrix[o][d];
      rowTotal += v;
      if (o === d) {
        mHtml += `<td style="padding:4px 6px;text-align:center;background:rgba(30,41,59,.3);color:var(--ua-muted)">—</td>`;
      } else {
        const intensity = v > 0 ? Math.max(0.15, v / matrixMax) : 0;
        const bg = v > 0 ? `rgba(0,93,170,${intensity})` : 'transparent';
        mHtml += `<td style="padding:4px 6px;text-align:center;background:${bg};color:${v > 0 ? 'var(--ua-text)' : 'var(--ua-muted)'};font-weight:${v > 0 ? '700' : '400'};border:1px solid rgba(30,41,59,.3)">${v || '·'}</td>`;
      }
    });
    mHtml += `<td style="padding:4px 6px;text-align:center;color:var(--ua-muted);font-weight:700;border-left:2px solid var(--ua-border)">${rowTotal}</td>`;
    mHtml += `</tr>`;
  });
  mHtml += `</tbody></table>`;
  document.getElementById('hub-matrix').innerHTML = mHtml;

  // ═══ TOP ROUTES ═══
  const routeCount = {};
  airborneFlights.filter(f => f.origin && f.dest).forEach(f => {
    const key = f.origin + '→' + f.dest;
    routeCount[key] = (routeCount[key] || 0) + 1;
  });

  const topRoutes = Object.entries(routeCount).sort((a, b) => b[1] - a[1]).slice(0, 15);
  const maxRouteCount = topRoutes[0] ? topRoutes[0][1] : 1;

  document.getElementById('route-heatmap').innerHTML = topRoutes.map(([route, count], i) =>
    `<div style="display:flex;align-items:center;gap:8px;padding:3px 0">
      <span style="font-size:9px;color:var(--ua-muted);min-width:16px;text-align:right">${i+1}</span>
      <span style="font-size:11px;min-width:100px;font-weight:600">${route}</span>
      <div style="flex:1;height:6px;background:var(--ua-border);border-radius:3px;overflow:hidden">
        <div style="height:100%;width:${count/maxRouteCount*100}%;background:linear-gradient(90deg,var(--ua-blue),var(--ua-accent));border-radius:3px"></div>
      </div>
      <span style="font-size:10px;color:var(--ua-accent);font-weight:700">${count}</span>
    </div>`
  ).join('') || '<div style="color:var(--ua-muted)">Waiting for flight data…</div>';

  // ═══ AVERAGE FLEET AGE ═══
  const typeAges = {};
  FLEET_DB.forEach(a => {
    const y = parseInt(a.d);
    if (y) {
      if (!typeAges[a.t]) typeAges[a.t] = [];
      typeAges[a.t].push(currentYear - y);
    }
  });

  document.getElementById('avg-age-chart').innerHTML = typeOrder.map(t => {
    const tAges = typeAges[t] || [];
    const avg = tAges.length ? (tAges.reduce((a, b) => a + b, 0) / tAges.length).toFixed(1) : 0;
    const maxAge = 30;
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(30,41,59,.3)">
      <span style="font-size:10px;min-width:85px">${t}</span>
      <div style="flex:1;margin:0 8px;height:8px;background:var(--ua-border);border-radius:4px;overflow:hidden">
        <div style="height:100%;width:${avg / maxAge * 100}%;background:${avg > 20 ? '#ef4444' : avg > 15 ? '#f59e0b' : avg > 8 ? '#005DAA' : '#22c55e'};border-radius:4px"></div>
      </div>
      <span style="font-size:10px;color:var(--ua-accent);font-weight:700;min-width:40px;text-align:right">${avg}y</span>
    </div>`;
  }).join('');
}

// ═══ LIVE FLEET PANEL ═══
function updateLiveFleetPanel() {
  if (!allFlights.length) return;
  const airborne = [];
  const typeOrder = ["A319","A320","A321neo","737-700","737-800","737-900","737-900ER","737 MAX 8","737 MAX 9","757-200","757-300","767-300ER","767-400ER","777-200","777-200ER","777-300ER","787-8","787-9","787-10"];
  const typeCounts = {}; typeOrder.forEach(t => typeCounts[t] = { airborne: 0, total: 0 });
  FLEET_DB.forEach(a => { if (typeCounts[a.t]) typeCounts[a.t].total++; });

  let matched = 0, unmatched = 0;
  allFlights.forEach(f => {
    if (f.onGround) return;
    const ac = matchAircraft(f);
    if (!ac) { unmatched++; return; }
    matched++;
    if (typeCounts[ac.t]) typeCounts[ac.t].airborne++;
    // Use FR24's real route data
    const routeStr = (f.origin || '???') + '→' + (f.dest || '???');
    const phase = getPhase(f.alt, f.vr, f.spd);
    const isStar = STARLINK_TAILS.has(ac.r) || STARLINK_TAILS.has(f.reg);
    airborne.push({
      reg: ac.r, type: ac.t,
      flight: f.flightIATA || f.callsign,
      route: routeStr,
      alt: f.alt ? Math.round(f.alt * 3.28084).toLocaleString() + 'ft' : '--',
      phase: phase.phase,
      starlink: isStar
    });
  });

  airborne.sort((a, b) => a.type.localeCompare(b.type) || a.reg.localeCompare(b.reg));

  const totalAirborne = allFlights.filter(f => !f.onGround).length;
  let html = `<div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">`;
  html += `<div><div class="big-number" style="display:flex;align-items:center;gap:8px"><span class="pulse-dot"></span>${totalAirborne}</div>`;
  html += `<div class="big-number-label">${matched} matched to fleet DB · ${unmatched} regional/partner</div></div>`;
  html += `</div>`;

  html += `<div class="type-breakdown">`;
  typeOrder.forEach(t => {
    const d = typeCounts[t];
    if (!d.total) return;
    const pct = d.total > 0 ? Math.round(d.airborne / d.total * 100) : 0;
    html += `<div class="type-bar"><span>${t}</span><span><span class="airborne">${d.airborne}</span><span class="total">/${d.total}</span> <span style="color:var(--ua-muted);font-size:9px">${pct}%</span></span></div>`;
  });
  html += `</div>`;

  if (airborne.length) {
    html += `<div class="live-table-wrap"><table><thead><tr><th>Reg</th><th>Type</th><th>Flight</th><th>Route</th><th>Alt</th><th>Phase</th><th></th></tr></thead><tbody>`;
    airborne.forEach(a => {
      html += `<tr><td style="font-weight:700;color:var(--ua-accent)">${escapeHtml(a.reg)}</td><td>${escapeHtml(a.type)}</td><td>${escapeHtml(a.flight)}</td><td>${escapeHtml(a.route)}</td><td>${escapeHtml(a.alt)}</td><td>${escapeHtml(a.phase)}</td><td>${a.starlink ? '⚡' : ''}</td></tr>`;
    });
    html += `</tbody></table></div>`;
  }

  document.getElementById('fleet-live-content').innerHTML = html;
  document.getElementById('fleet-live-time').textContent = 'Updated ' + new Date().toUTCString().slice(17, 25) + 'Z';
}

// ═══ WEATHER EXPLAINERS ═══
function explainMETAR(rawMetar, hub, cat) {
  if (!rawMetar) return '';
  const hubNames = {EWR:"Newark",IAH:"Houston Intercontinental",ORD:"O'Hare",DEN:"Denver International",SFO:"San Francisco",LAX:"Los Angeles",IAD:"Washington Dulles",NRT:"Tokyo Narita",GUM:"Guam"};
  const name = hubNames[hub] || hub;

  // Build context-aware assessment instead of static category blurbs

  let parts = [];

  // Wind
  const windMatch = rawMetar.match(/\b(\d{3})(\d{2,3})(G(\d{2,3}))?KT\b/);
  if (windMatch) {
    const dir = parseInt(windMatch[1]), spd = parseInt(windMatch[2]), gust = windMatch[4] ? parseInt(windMatch[4]) : null;
    const dirs = ['north','north-northeast','northeast','east-northeast','east','east-southeast','southeast','south-southeast','south','south-southwest','southwest','west-southwest','west','west-northwest','northwest','north-northwest'];
    const dirName = dirs[Math.round(dir / 22.5) % 16];
    parts.push(`Winds from the ${dirName} at ${spd} knots${gust ? ' gusting to ' + gust : ''}`);
  } else if (rawMetar.includes('00000KT')) {
    parts.push('Winds are calm');
  }

  // Visibility
  const visMatch = rawMetar.match(/\b(\d+)\s*SM\b/) || rawMetar.match(/\b(\d+)\/(\d+)SM\b/) || rawMetar.match(/\bM?(\d+\/\d+)SM\b/);
  if (visMatch) {
    const vis = visMatch[0].replace('SM', '').trim();
    parts.push(`Visibility is ${vis} statute miles`);
  }

  // Ceiling / clouds
  const cloudMatches = [...rawMetar.matchAll(/(FEW|SCT|BKN|OVC)(\d{3})/g)];
  const cloudNames = {FEW:'few clouds',SCT:'scattered',BKN:'broken ceiling',OVC:'overcast ceiling'};
  if (cloudMatches.length) {
    const lowest = cloudMatches[0];
    const altHun = parseInt(lowest[2]) * 100;
    parts.push(`${cloudNames[lowest[1]] || lowest[1]} at ${altHun.toLocaleString()} feet`);
  } else if (rawMetar.includes('CLR') || rawMetar.includes('SKC')) {
    parts.push('Clear skies');
  }

  // Weather phenomena
  const wxCodes = {RA:'rain',SN:'snow',DZ:'drizzle',FG:'fog',BR:'mist',HZ:'haze',TS:'thunderstorms',FZ:'freezing',SH:'showers',GR:'hail',PL:'ice pellets'};
  const wxMatch = rawMetar.match(/\s([+-]?(?:VC)?(?:MI|PR|BC|DR|BL|SH|TS|FZ)?(?:DZ|RA|SN|SG|IC|PL|GR|GS|UP|BR|FG|FU|VA|DU|SA|HZ|PY|PO|SQ|FC|SS|DS)+)\s/);
  if (wxMatch) {
    const wx = wxMatch[1];
    let desc = [];
    if (wx.startsWith('-')) desc.push('light');
    else if (wx.startsWith('+')) desc.push('heavy');
    for (const [code, name] of Object.entries(wxCodes)) {
      if (wx.includes(code)) desc.push(name);
    }
    if (desc.length) parts.push(desc.join(' '));
  }

  // Temperature
  const tempMatch = rawMetar.match(/\b(M?\d{2})\/(M?\d{2})\b/);
  if (tempMatch) {
    const t = tempMatch[1].replace('M', '-');
    const tempC = parseInt(t);
    const tempF = Math.round(tempC * 9/5 + 32);
    parts.push(`Temperature is ${tempC}°C (${tempF}°F)`);
  }

  // Altimeter
  const altMatch = rawMetar.match(/A(\d{4})/);
  if (altMatch) {
    const alt = (parseInt(altMatch[1]) / 100).toFixed(2);
    parts.push(`altimeter setting of ${alt} inHg`);
  }

  let text = `${name} is currently reporting ${cat || 'unknown'} conditions`;
  if (parts.length) text += '. ' + parts.join('. ') + '.';

  // Build dynamic operational assessment from actual conditions
  const assessParts = [];
  // Check for active weather phenomena
  const wxMatch2 = rawMetar.match(/\s([+-]?(?:VC)?(?:MI|PR|BC|DR|BL|SH|TS|FZ)?(?:DZ|RA|SN|SG|IC|PL|GR|GS|UP|BR|FG|FU|VA|DU|SA|HZ|PY|PO|SQ|FC|SS|DS)+)\s/);
  if (wxMatch2) {
    const wx = wxMatch2[1];
    if (wx.includes('SN') || wx.includes('FZ')) assessParts.push('winter weather active');
    else if (wx.includes('TS')) assessParts.push('thunderstorm activity');
    else if (wx.includes('RA') || wx.includes('DZ') || wx.includes('SH')) assessParts.push('precipitation');
    else if (wx.includes('FG')) assessParts.push('fog');
    else if (wx.includes('BR') || wx.includes('HZ')) assessParts.push('reduced visibility');
  }
  // Check winds
  const wm2 = rawMetar.match(/\b\d{3}(\d{2,3})(G(\d{2,3}))?KT\b/);
  if (wm2) {
    const gust = wm2[3] ? parseInt(wm2[3]) : parseInt(wm2[1]);
    if (gust >= 30) assessParts.push('strong/gusty winds');
    else if (gust >= 20) assessParts.push('gusty conditions');
  }
  // Check ceiling
  const ceil = [...rawMetar.matchAll(/(BKN|OVC)(\d{3})/g)];
  if (ceil.length) {
    const ceilFt = parseInt(ceil[0][2]) * 100;
    if (ceilFt < 500) assessParts.push('very low ceilings');
    else if (ceilFt < 1000) assessParts.push('low ceilings');
    else if (ceilFt <= 3000) assessParts.push('low overcast');
  }

  if (cat === 'LIFR') {
    text += ` Very low ceilings/visibility — major operational impact, expect ground stops and diversions.`;
  } else if (cat === 'IFR') {
    text += ` Instrument conditions${assessParts.length ? ' with ' + assessParts.join(', ') : ''} — expect significant delays and possible diversions.`;
  } else if (cat === 'MVFR') {
    text += ` Marginal conditions${assessParts.length ? ' with ' + assessParts.join(', ') : ''} — some delays possible.`;
  } else if (assessParts.length) {
    // VFR but with notable conditions
    text += ` ${assessParts.join(', ').replace(/^./, c => c.toUpperCase())} — monitor for changes.`;
  } else {
    text += ` Clear skies, good visibility — no impact on operations.`;
  }

  return text;
}

function explainFAAStatus(airportCode, delays, rawData) {
  if (!delays || delays.length === 0) {
    return `${airportCode} is operating normally — no reported delays or restrictions.`;
  }

  const explanations = delays.map(d => {
    let text = `${airportCode} is currently experiencing `;
    const dtype = (d.type || '').toLowerCase();
    const reason = d.reason || 'unknown causes';

    if (dtype.includes('departure')) text += `departure delays`;
    else if (dtype.includes('arrival')) text += `arrival delays`;
    else if (dtype.includes('ground stop') || dtype.includes('groundstop')) text += `a ground stop`;
    else if (dtype.includes('ground delay') || dtype.includes('gdp')) text += `a ground delay program`;
    else if (dtype.includes('closure') || dtype.includes('closed')) {
      return `${airportCode} is closed${d.startTime ? ' from ' + d.startTime : ''}${d.endTime ? ' to ' + d.endTime : ''}${reason !== 'unknown causes' ? ' due to ' + reason : ''} per NOTAM. This is a recurring restriction.`;
    }
    else text += `delays`;

    if (d.avgDelay || d.minDelay || d.maxDelay) {
      const range = d.minDelay && d.maxDelay ? `${d.minDelay}-${d.maxDelay} minutes` : d.avgDelay ? `approximately ${d.avgDelay} minutes` : '';
      if (range) text += ` of ${range}`;
    }

    text += ` due to ${reason}.`;

    if (d.trend) {
      if (d.trend.toLowerCase().includes('increas')) text += ` This is an increasing trend — delays may get worse.`;
      else if (d.trend.toLowerCase().includes('decreas')) text += ` Delays are decreasing — conditions improving.`;
    }

    return text;
  });

  return explanations.join(' ');
}

// ═══ SCHEDULE TAB ═══
const SCHED_HUB_TZ = {ORD:'America/Chicago',DEN:'America/Denver',IAH:'America/Chicago',EWR:'America/New_York',SFO:'America/Los_Angeles',IAD:'America/New_York',LAX:'America/Los_Angeles',NRT:'Asia/Tokyo',GUM:'Pacific/Guam'};
let schedCache = {}; // key: "hub-dir-day-page"
let schedAllFlights = []; // current filtered UA flights
let schedRawByHub = {}; // key: "hub-dir-day" → [pages of UA flights]
let schedCurrentDay = 0;
let schedCurrentHub = '';
let schedCurrentDir = 'departures';
let schedInitialized = false;
let schedSortCol = 'time';
let schedSortAsc = true;
let schedLoading = false;

function initScheduleTab() {
  if (!schedInitialized) {
    schedInitialized = true;
    updateSchedDayLabels();
    // Day buttons
    document.querySelectorAll('.sched-day-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.sched-day-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        schedCurrentDay = parseInt(btn.dataset.day);
        loadScheduleData();
      });
    });
    // Filters
    document.getElementById('sched-hub').addEventListener('change', () => { schedCurrentHub = document.getElementById('sched-hub').value; updateSchedDayLabels(); loadScheduleData(); });
    document.getElementById('sched-dir').addEventListener('change', () => { schedCurrentDir = document.getElementById('sched-dir').value; loadScheduleData(); });
    const debouncedSchedRender = debounce(renderScheduleTable, 120);
    document.getElementById('sched-status').addEventListener('change', debouncedSchedRender);
    document.getElementById('sched-aircraft').addEventListener('change', debouncedSchedRender);
    document.getElementById('sched-search').addEventListener('input', debouncedSchedRender);
    // Sort headers
    document.querySelectorAll('#sched-table th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.sort;
        if (schedSortCol === col) schedSortAsc = !schedSortAsc;
        else { schedSortCol = col; schedSortAsc = true; }
        renderScheduleTable();
      });
    });
    // Auto-load if hub already selected
    if (!schedCurrentHub) {
      document.getElementById('sched-hub').value = 'ORD';
      schedCurrentHub = 'ORD';
    }
    loadScheduleData();
  }
}

function getSchedDayTimestamp(dayOffset) {
  // Use the selected hub's timezone for day boundaries (not browser local time)
  const tz = SCHED_HUB_TZ[schedCurrentHub] || 'America/Chicago';
  const now = new Date();
  // Get current date string in the hub's timezone
  const hubDateStr = now.toLocaleDateString('en-CA', { timeZone: tz }); // YYYY-MM-DD
  const [y, m, d] = hubDateStr.split('-').map(Number);
  // Build midnight in hub timezone by finding the UTC offset
  const target = new Date(Date.UTC(y, m - 1, d + dayOffset, 12, 0, 0)); // noon UTC as seed
  const hubNoon = new Date(target.toLocaleString('en-US', { timeZone: tz }));
  const utcNoon = new Date(target.toLocaleString('en-US', { timeZone: 'UTC' }));
  const offsetMs = utcNoon - hubNoon;
  const midnight = new Date(Date.UTC(y, m - 1, d + dayOffset, 0, 0, 0) + offsetMs);
  return Math.floor(midnight.getTime() / 1000);
}

function getSchedDayLabel(dayOffset) {
  const tz = SCHED_HUB_TZ[schedCurrentHub] || 'America/Chicago';
  const now = new Date();
  const hubDateStr = now.toLocaleDateString('en-CA', { timeZone: tz });
  const [y, m, d] = hubDateStr.split('-').map(Number);
  const target = new Date(y, m - 1, d + dayOffset);
  return target.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
}

function getHubTzAbbrev(hub) {
  const tz = SCHED_HUB_TZ[hub] || 'America/Chicago';
  return new Date().toLocaleTimeString('en-US', { timeZone: tz, timeZoneName: 'short' }).split(' ').pop();
}

function updateSchedDayLabels() {
  const names = { '-1': 'Yesterday', '0': 'Today', '1': 'Tomorrow' };
  document.querySelectorAll('.sched-day-btn').forEach(btn => {
    const day = btn.dataset.day;
    const dateStr = getSchedDayLabel(parseInt(day));
    btn.textContent = `${names[day]} (${dateStr})`;
  });
}

async function preloadScheduleData() {
  // Fetch all 9 hubs IN PARALLEL — no sequential waiting
  // Only preload top 3 domestic hubs on startup; rest load on demand
  const preloadHubs = ['ORD','DEN','EWR'];
  const timestamp = getSchedDayTimestamp(0); // today
  const results = await Promise.allSettled(
    preloadHubs.map(hub => fetchScheduleAggregated(hub, 'departures', timestamp).then(r => ({hub, result: r})))
  );
  let loaded = 0;
  results.forEach(r => {
    if (r.status !== 'fulfilled') return;
    const {hub, result} = r.value;
    const hubKey = `${hub}-departures-0`;
    if (result.flights && result.flights.length && !schedRawByHub[hubKey]) {
      schedRawByHub[hubKey] = result.flights;
      loaded++;
    }
  });
  if (loaded > 0) {
    updateHubHealth();
    updateIrrops();
  }
}

async function fetchScheduleAggregated(hub, dir, timestamp) {
  const cacheKey = `agg-${hub}-${dir}-${timestamp}`;
  if (schedCache[cacheKey]) return { ...schedCache[cacheKey], fromLocalCache: true };
  const url = `/api/schedule?hub=${encodeURIComponent(hub)}&dir=${encodeURIComponent(dir)}&timestamp=${timestamp}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`Schedule API ${resp.status}`);
  const data = await resp.json();
  if (data.error) throw new Error(data.error);
  schedCache[cacheKey] = data;
  return data;
}

function classifySchedStatus(flight) {
  const s = flight.status;
  if (!s) return { text: 'Unknown', cls: 'unknown', key: 'unknown' };
  const generic = s.generic?.status;
  const txt = s.text || '';
  const statusText = generic?.text || '';
  const diverted = generic?.diverted;
  const txtLower = txt.toLowerCase();
  if (diverted) return { text: 'Diverted', cls: 'diverted', key: 'diverted' };
  // FR24 uses various cancellation indicators: generic.status.text, status.text, status.icon
  const iconColor = s.icon || '';
  if (statusText === 'canceled' || statusText === 'cancelled' || txtLower.includes('cancel') || (iconColor === 'red' && generic?.type === 'canceled')) return { text: txt || 'Canceled', cls: 'canceled', key: 'canceled' };
  if (statusText === 'landed' || txtLower.includes('landed')) return { text: txt || 'Landed', cls: 'landed', key: 'landed' };
  if (statusText === 'departed' || txtLower.startsWith('departed')) return { text: txt || 'Departed', cls: 'departed', key: 'departed' };
  // A flight is en-route if: FR24 says so, OR it's live with a real departure (actually airborne)
  const isAirborne = s.live === true && (flight.time?.real?.departure != null);
  if (statusText === 'en-route' || txtLower.includes('en route') || isAirborne) return { text: txt || 'En Route', cls: 'enroute', key: 'enroute' };
  if (statusText === 'scheduled') return { text: txt || 'Scheduled', cls: 'scheduled', key: 'scheduled' };
  if (statusText === 'estimated') {
    const schedTime = flight.time?.scheduled?.departure || flight.time?.scheduled?.arrival;
    const estTime = flight.time?.estimated?.departure || flight.time?.estimated?.arrival;
    if (schedTime && estTime && estTime > schedTime + 900) return { text: txt, cls: 'delayed', key: 'estimated' };
    return { text: txt, cls: 'estimated', key: 'estimated' };
  }
  if (txtLower.includes('delay')) return { text: txt, cls: 'delayed', key: 'delayed' };
  return { text: txt || 'Unknown', cls: 'unknown', key: 'unknown' };
}

let _schedPendingReload = false;
async function loadScheduleData() {
  if (schedLoading) { _schedPendingReload = true; return; }
  if (!schedCurrentHub) {
    document.getElementById('sched-loading').style.display = 'block';
    document.getElementById('sched-loading').innerHTML = '<div style="font-size:24px;margin-bottom:8px">📅</div>Select a hub to load schedule data';
    document.getElementById('sched-table-wrap').style.display = 'none';
    return;
  }
  schedLoading = true;
  const loadEl = document.getElementById('sched-loading');
  const tableWrap = document.getElementById('sched-table-wrap');
  loadEl.style.display = 'block';
  tableWrap.style.display = 'none';
  loadEl.innerHTML = `<div style="font-size:24px;margin-bottom:8px;animation:pulse 1.5s infinite">✈️</div>Loading ${escapeHtml(schedCurrentHub)} ${escapeHtml(schedCurrentDir)} for ${escapeHtml(getSchedDayLabel(schedCurrentDay))}...<br><span style="font-size:10px">Fetching via server cache</span>`;
  const btn = document.getElementById('sched-refresh-btn');
  btn.disabled = true;
  btn.textContent = '⏳ Loading...';

  try {
    const timestamp = getSchedDayTimestamp(schedCurrentDay);
    const hubKey = `${schedCurrentHub}-${schedCurrentDir}-${schedCurrentDay}`;

    // Check if IRROPS already hydrated this data
    let result;
    if (schedRawByHub[hubKey] && schedRawByHub[hubKey].length) {
      result = { flights: schedRawByHub[hubKey], cached: true, fromIrrops: true };
    } else {
      result = await fetchScheduleAggregated(schedCurrentHub, schedCurrentDir, timestamp);
    }
    const allUAFlights = result.flights || [];

    // Show cache indicator
    if (result.cached || result.fromLocalCache) {
      loadEl.innerHTML = `<div style="font-size:24px;margin-bottom:8px;animation:pulse 1.5s infinite">✈️</div>Loading ${escapeHtml(schedCurrentHub)} ${escapeHtml(schedCurrentDir)}...<br><span style="font-size:10px;color:#4ecdc4">⚡ Served from cache · ${allUAFlights.length} UA flights</span>`;
    }

    schedAllFlights = allUAFlights;
    schedRawByHub[hubKey] = allUAFlights;
    detectEquipmentSwaps(allUAFlights, schedCurrentHub, schedCurrentDir, schedCurrentDay);
    populateAircraftFilter();
    loadEl.style.display = 'none';
    tableWrap.style.display = 'block';
    renderScheduleTable();
    renderScheduleStats();
    updateHubHealth();
    updateIrrops();
    checkWatchedFlightChanges(allUAFlights);
  } catch (err) {
    console.error('Schedule load error:', err);
    loadEl.innerHTML = `<div style="font-size:24px;margin-bottom:8px">⚠️</div>Error loading schedule: ${escapeHtml(err.message)}<br><span style="font-size:10px">Try again in a moment (rate limiting)</span>`;
  } finally {
    schedLoading = false;
    btn.disabled = false;
    btn.textContent = '↻ Refresh';
    if (_schedPendingReload) { _schedPendingReload = false; loadScheduleData(); }
  }
}

function populateAircraftFilter() {
  const sel = document.getElementById('sched-aircraft');
  const current = sel.value;
  const types = {};
  schedAllFlights.forEach(fl => {
    const code = fl.aircraft?.model?.code;
    const name = fl.aircraft?.model?.text;
    if (code) types[code] = name || code;
  });
  const sorted = Object.entries(types).sort((a, b) => a[0].localeCompare(b[0]));
  sel.innerHTML = '<option value="">All Aircraft</option>' + sorted.map(([code, name]) => `<option value="${code}">${code} — ${name}</option>`).join('');
  if (current && types[current]) sel.value = current;
}

function formatSchedTime(utcTimestamp, hub) {
  if (!utcTimestamp) return '—';
  const tz = SCHED_HUB_TZ[hub] || 'America/Chicago';
  const d = new Date(utcTimestamp * 1000);
  return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: tz });
}

function getFilteredScheduleFlights() {
  const statusFilter = document.getElementById('sched-status').value;
  const aircraftFilter = document.getElementById('sched-aircraft').value;
  const searchFilter = document.getElementById('sched-search').value.toLowerCase().trim();

  return schedAllFlights.filter(fl => {
    // Status filter
    if (statusFilter) {
      const s = classifySchedStatus(fl);
      if (s.key !== statusFilter) return false;
    }
    // Aircraft filter
    if (aircraftFilter && fl.aircraft?.model?.code !== aircraftFilter) return false;
    // Search filter
    if (searchFilter) {
      const flNum = fl.identification?.number?.default?.toLowerCase() || '';
      const callsign = fl.identification?.callsign?.toLowerCase() || '';
      const reg = fl.aircraft?.registration?.toLowerCase() || '';
      const destName = (fl.airport?.destination?.name || '').toLowerCase();
      const destCode = (fl.airport?.destination?.code?.iata || '').toLowerCase();
      const origName = (fl.airport?.origin?.name || '').toLowerCase();
      const origCode = (fl.airport?.origin?.code?.iata || '').toLowerCase();
      const acType = (fl.aircraft?.model?.code || '').toLowerCase();
      const haystack = `${flNum} ${callsign} ${reg} ${destName} ${destCode} ${origName} ${origCode} ${acType}`;
      if (!haystack.includes(searchFilter)) return false;
    }
    return true;
  });
}

function sortScheduleFlights(flights) {
  const dir = schedSortAsc ? 1 : -1;
  return [...flights].sort((a, b) => {
    switch (schedSortCol) {
      case 'time': {
        const tA = (schedCurrentDir === 'departures' ? a.time?.scheduled?.departure : a.time?.scheduled?.arrival) || 0;
        const tB = (schedCurrentDir === 'departures' ? b.time?.scheduled?.departure : b.time?.scheduled?.arrival) || 0;
        return (tA - tB) * dir;
      }
      case 'flight': return ((a.identification?.number?.default || '') .localeCompare(b.identification?.number?.default || '')) * dir;
      case 'route': {
        const rA = schedCurrentDir === 'departures' ? (a.airport?.destination?.code?.iata || '') : (a.airport?.origin?.code?.iata || '');
        const rB = schedCurrentDir === 'departures' ? (b.airport?.destination?.code?.iata || '') : (b.airport?.origin?.code?.iata || '');
        return rA.localeCompare(rB) * dir;
      }
      case 'aircraft': return ((a.aircraft?.model?.code || '').localeCompare(b.aircraft?.model?.code || '')) * dir;
      case 'reg': return ((a.aircraft?.registration || '').localeCompare(b.aircraft?.registration || '')) * dir;
      case 'status': {
        const sA = classifySchedStatus(a).key;
        const sB = classifySchedStatus(b).key;
        return sA.localeCompare(sB) * dir;
      }
      default: return 0;
    }
  });
}

function updateSchedTzFooter() {
  const hub = schedCurrentHub || 'ORD';
  const abbr = getHubTzAbbrev(hub);
  const hubLabel = hub || 'selected hub';
  const footer = document.getElementById('sched-tz-footer');
  if (footer) footer.innerHTML = `Schedule data via <a href="https://www.flightradar24.com" target="_blank" rel="noopener noreferrer" style="color:var(--ua-green)">Flightradar24</a> · United flights only · All times ${hubLabel} local (<b>${abbr}</b>)`;
}

function renderScheduleTable() {
  const filtered = getFilteredScheduleFlights();
  const sorted = sortScheduleFlights(filtered);
  const tbody = document.getElementById('sched-tbody');
  const hub = schedCurrentHub;
  updateSchedTzFooter();

  // Update sort indicators
  document.querySelectorAll('#sched-table th[data-sort]').forEach(th => {
    const arrow = th.dataset.sort === schedSortCol ? (schedSortAsc ? ' ↑' : ' ↓') : ' ↕';
    th.textContent = th.textContent.replace(/\s[↑↓↕]$/, '') + arrow;
  });

  if (sorted.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--ua-muted)"><div style="font-size:24px;margin-bottom:8px">🔍</div>No flights match your filters<br><span style="font-size:10px">Try adjusting hub, status, or search criteria</span></td></tr>`;
    renderScheduleStats(filtered);
    return;
  }

  const rows = sorted.map(fl => {
    const ident = fl.identification?.number?.default || '—';
    const schedTime = schedCurrentDir === 'departures' ? fl.time?.scheduled?.departure : fl.time?.scheduled?.arrival;
    const actualTime = schedCurrentDir === 'departures' ? (fl.time?.real?.departure || fl.time?.estimated?.departure) : (fl.time?.real?.arrival || fl.time?.estimated?.arrival);
    const timeStr = formatSchedTime(schedTime, hub);
    let timeExtra = '';
    if (actualTime && schedTime && actualTime !== schedTime) {
      const diff = Math.round((actualTime - schedTime) / 60);
      const actualStr = formatSchedTime(actualTime, hub);
      if (diff > 5) timeExtra = `<div class="sched-time-actual">→ ${actualStr} (+${diff}m)</div>`;
      else if (diff < -5) timeExtra = `<div class="sched-time-actual" style="color:#22c55e">→ ${actualStr} (${diff}m)</div>`;
    }

    const dest = fl.airport?.destination;
    const orig = fl.airport?.origin;
    let routeStr;
    if (schedCurrentDir === 'departures') {
      routeStr = `${escapeHtml(hub)} → ${escapeHtml(dest?.code?.iata || '?')}`;
      if (dest?.name) routeStr += `<div style="font-size:9px;color:var(--ua-muted)">${escapeHtml(dest.name.replace(/ Airport| International/g, '').substring(0, 30))}</div>`;
    } else {
      routeStr = `${escapeHtml(orig?.code?.iata || '?')} → ${escapeHtml(hub)}`;
      if (orig?.name) routeStr += `<div style="font-size:9px;color:var(--ua-muted)">${escapeHtml(orig.name.replace(/ Airport| International/g, '').substring(0, 30))}</div>`;
    }

    const acCode = fl.aircraft?.model?.code || '—';
    const acText = fl.aircraft?.model?.text || '';
    const acShort = acText ? acText.replace(/Boeing |Airbus |Embraer /g, '').substring(0, 20) : '';
    const reg = fl.aircraft?.registration || '—';

    const gate = schedCurrentDir === 'departures'
      ? (orig?.info?.gate ? `${orig.info.terminal || ''}${orig.info.gate}` : (orig?.info?.terminal ? `T${orig.info.terminal}` : '—'))
      : (dest?.info?.gate ? `${dest.info.terminal || ''}${dest.info.gate}` : (dest?.info?.terminal ? `T${dest.info.terminal}` : '—'));

    const status = classifySchedStatus(fl);

    // Fleet match + enrichment
    let fleetMatch = '';
    let fleetEnrich = '';
    if (reg && reg !== '—') {
      const regClean = reg.replace('-', '');
      const match = FLEET_BY_REG[regClean] || FLEET_BY_REG[reg];
      if (match) {
        const isStar = STARLINK_TAILS.has(regClean) || STARLINK_TAILS.has(reg);
        fleetMatch = `<span class="sched-fleet-match">${isStar ? '⚡' : '✓'} ${escapeHtml(match.c || match.t)}</span>`;
        // Fleet enrichment inline
        const parts = [];
        if (match.seats && typeof match.seats === 'object') {
          const seatStr = Object.entries(match.seats).map(([cls,cnt]) => cnt + cls).join('/');
          parts.push(seatStr);
        }
        if (match.w) parts.push(match.w);
        if (isStar) parts.push('⚡ Starlink');
        if (match.i) parts.push(match.i);
        if (match.d) parts.push('Del ' + match.d);
        if (parts.length) fleetEnrich = `<div class="fleet-enrich-inline">${escapeHtml(parts.join(' · '))}</div>`;
      } else {
        fleetMatch = `<span class="sched-fleet-miss">—</span>`;
      }
    }

    // Equipment change detection
    let equipBadge = '';
    const eqChange = getEquipChangeForFlight(ident);
    if (eqChange) {
      equipBadge = `<div class="equip-change-badge">⚠️ ${escapeHtml(eqChange.oldAc)} → ${escapeHtml(eqChange.newAc)}</div>`;
    }

    // FAA delay context
    let faaContext = '';
    if (status.cls === 'delayed' || (status.key === 'estimated' && status.cls === 'delayed')) {
      const origIata = fl.airport?.origin?.code?.iata;
      const destIata = fl.airport?.destination?.code?.iata;
      const ctx = getFAADelayContext(origIata, destIata);
      if (ctx) faaContext = `<div class="faa-delay-context">${escapeHtml(ctx)}</div>`;
    }

    // Watch button
    const isWatched = isFlightWatched(ident);
    const origCode = fl.airport?.origin?.code?.iata || '?';
    const destCode = fl.airport?.destination?.code?.iata || '?';
    const watchRoute = `${origCode}→${destCode}`;
    const watchBtn = ident !== '—' ? `<button class="watch-btn${isWatched ? ' watching' : ''}" data-action="toggle-watch-flight" data-flight="${escapeHtml(ident)}" data-route="${escapeHtml(watchRoute)}" data-status="${escapeHtml(status.text)}" data-stop-prop="1" aria-label="${isWatched ? 'Unwatch flight' : 'Watch flight'}" title="${isWatched ? 'Unwatch' : 'Watch'} this flight">${isWatched ? '👁️' : '👁'}</button>` : '';

    return `<tr>
      <td>${escapeHtml(timeStr)}${timeExtra}</td>
      <td style="font-weight:600;color:var(--ua-accent)">${escapeHtml(ident)}</td>
      <td>${routeStr}</td>
      <td title="${escapeHtml(acText)}">${escapeHtml(acCode)}${acShort ? `<div style="font-size:9px;color:var(--ua-muted)">${escapeHtml(acShort)}</div>` : ''}${equipBadge}</td>
      <td style="font-family:var(--mono);font-size:10px">${reg !== '—' ? `<a href="#fleet" data-action="fleet-search" data-reg="${escapeHtml(reg)}" data-prevent-default="1" style="color:var(--ua-accent);text-decoration:none;cursor:pointer">${escapeHtml(reg)}</a>` : '—'}${fleetEnrich}</td>
      <td>${escapeHtml(gate)}</td>
      <td><span class="sched-status ${escapeHtml(status.cls)}">${escapeHtml(status.text)}</span>${faaContext}</td>
      <td>${fleetMatch}</td>
      <td>${watchBtn}</td>
    </tr>`;
  });

  tbody.innerHTML = rows.join('');
  renderScheduleStats(filtered);
}

function renderScheduleStats(filtered) {
  if (!filtered) filtered = getFilteredScheduleFlights();
  const showing = filtered.length;
  const statuses = {};
  filtered.forEach(fl => {
    const s = classifySchedStatus(fl);
    statuses[s.key] = (statuses[s.key] || 0) + 1;
  });

  // OTP: only count flights with real departure/arrival data (actually operated)
  let depOnTime = 0;
  let depDelayed = 0;
  let scheduled = 0;
  let canceled = statuses.canceled || 0;
  filtered.forEach(fl => {
    const status = classifySchedStatus(fl);
    const hasOperated = status.key === 'departed' || status.key === 'enroute' || status.key === 'landed';
    if (!hasOperated) {
      if (status.key === 'scheduled' || status.key === 'estimated') scheduled++;
      return;
    }
    const schedT = schedCurrentDir === 'departures' ? fl.time?.scheduled?.departure : fl.time?.scheduled?.arrival;
    const realT = fl.time?.real?.departure || fl.time?.real?.arrival;
    const actT = realT || (schedCurrentDir === 'departures' ? fl.time?.estimated?.departure : fl.time?.estimated?.arrival);
    if (!schedT || !actT) return; // skip flights without usable timestamps
    if (actT > schedT + 1800) depDelayed++;
    else depOnTime++;
  });

  const totalOperated = depOnTime + depDelayed;
  const otp = totalOperated > 0 ? Math.round((depOnTime / totalOperated) * 100) : (showing > 0 ? '—' : 0);
  const otpColor = typeof otp === 'number' ? (otp >= 70 ? '#22c55e' : otp >= 50 ? '#f59e0b' : '#ef4444') : 'var(--ua-muted)';
  const otpStr = typeof otp === 'number' ? otp + '%' : otp;

  const dayLabel = getSchedDayLabel(schedCurrentDay);
  const dirLabel = schedCurrentDir === 'departures' ? 'DEP' : 'ARR';

  document.getElementById('sched-stats').innerHTML = `
    <div class="metric-card">
      <div class="metric-value" style="color:var(--ua-blue)">${showing}</div>
      <div class="metric-label">UA ${dirLabel} · ${dayLabel}</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" style="color:${otpColor}">${otpStr}</div>
      <div class="metric-label">On-Time % (${totalOperated} operated)</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" style="color:#22c55e">${depOnTime}</div>
      <div class="metric-label">On Time (±30m)</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" style="color:#f59e0b">${depDelayed}</div>
      <div class="metric-label">Late (&gt;30m)</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" style="color:#94a3b8">${scheduled}</div>
      <div class="metric-label">Upcoming</div>
    </div>
  `;
}

// ═══ OFFLINE DETECTION ═══
function updateOnlineStatus() {
  const banner = document.getElementById('offline-banner');
  if (!navigator.onLine) {
    banner.classList.add('show');
  } else {
    banner.classList.remove('show');
  }
}
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();

// ═══ GLOBAL SEARCH ═══
document.getElementById('global-search-input').addEventListener('input', debounce(function() {
  const q = this.value.trim().toUpperCase();
  const results = document.getElementById('global-search-results');
  if (q.length < 2) { results.style.display = 'none'; return; }

  // Normalize route queries: "ORD-DEN", "ORD DEN", "ORD → DEN" all become "ORDDEN"
  const qNorm = q.replace(/[\s\-→>]+/g, '');
  const matches = [];
  // Search live flights
  allFlights.forEach(f => {
    const cs = (f.callsign || '').toUpperCase();
    const flt = (f.flightIATA || '').toUpperCase();
    const reg = (f.reg || '').toUpperCase();
    const routeStr = ((f.origin || '') + (f.dest || '')).toUpperCase();
    const routeRev = ((f.dest || '') + (f.origin || '')).toUpperCase();
    if (cs.includes(q) || flt.includes(q) || reg.includes(q) || routeStr.includes(qNorm) || routeRev.includes(qNorm)) {
      matches.push({ type: 'live', label: `${f.flightIATA || f.callsign} ${f.origin||'?'}→${f.dest||'?'} ${f.reg||''}`, icao24: f.icao24 });
    }
  });
  // Search schedule data
  if (schedAllFlights.length) {
    schedAllFlights.forEach(fl => {
      const ident = (fl.identification?.number?.default || '').toUpperCase();
      const reg = (fl.aircraft?.registration || '').toUpperCase();
      const dest = (fl.airport?.destination?.code?.iata || '').toUpperCase();
      const orig = (fl.airport?.origin?.code?.iata || '').toUpperCase();
      if (ident.includes(q) || reg.includes(q) || dest.includes(q) || orig.includes(q)) {
        matches.push({ type: 'sched', label: `📅 ${fl.identification?.number?.default||'?'} ${orig||'?'}→${dest||'?'} ${fl.aircraft?.registration||''}` });
      }
    });
  }

  // Check if query looks like a flight number for FR24 lookup
  const flightPattern = /^(UA[L]?\s*\d{1,4}|\d{1,4})$/i;
  const normalizedQ = q.replace(/\s+/g, '');
  const looksLikeFlight = flightPattern.test(normalizedQ);
  const fr24Option = looksLikeFlight ? `<div class="search-result" style="border-top:1px solid var(--ua-border);color:var(--ua-accent);font-size:10px" data-action="lookup-fr24" data-query="${escapeHtml(normalizedQ)}" data-close-global="1">🔍 Look up ${escapeHtml(normalizedQ.startsWith('UA') || normalizedQ.startsWith('UAL') ? normalizedQ : 'UA' + normalizedQ)} via FlightRadar24...</div>` : '';

  if (matches.length === 0) {
    results.innerHTML = '<div style="padding:10px 12px;color:var(--ua-muted);font-size:10px">No results for "' + escapeHtml(q) + '"</div>' + fr24Option;
  } else {
    results.innerHTML = matches.slice(0, 20).map(m => {
      if (m.type === 'live') return `<div class="search-result" data-action="focus-flight" data-icao24="${escapeHtml(m.icao24)}" data-close-global="1">${escapeHtml(m.label)}</div>`;
      return `<div class="search-result" data-action="switch-tab" data-tab="tab-schedule" data-close-global="1"><span style="color:var(--ua-muted)">${escapeHtml(m.label)}</span></div>`;
    }).join('') + fr24Option;
  }
  results.style.display = 'block';
}, 150));
document.addEventListener('click', function(e) { if (!document.getElementById('global-search-wrap').contains(e.target)) document.getElementById('global-search-results').style.display = 'none'; });

// ═══ EQUIPMENT SWAP DETECTION ═══
let equipmentChanges = [];

function detectEquipmentSwaps(flights, hub, dir, day) {
  const storageKey = `bb_sched_${hub}_${dir}_${day}`;
  const newMap = {};
  flights.forEach(fl => {
    const fnum = fl.identification?.number?.default;
    const acCode = fl.aircraft?.model?.code;
    if (fnum && acCode) newMap[fnum] = acCode;
  });
  equipmentChanges = [];
  try {
    const oldData = localStorage.getItem(storageKey);
    if (oldData) {
      const oldMap = JSON.parse(oldData);
      for (const [fnum, newAc] of Object.entries(newMap)) {
        if (oldMap[fnum] && oldMap[fnum] !== newAc) {
          equipmentChanges.push({ flight: fnum, oldAc: oldMap[fnum], newAc });
        }
      }
    }
    localStorage.setItem(storageKey, JSON.stringify(newMap));
  } catch(e) { /* localStorage full or unavailable */ }
  updateEquipChangeSummary();
}

function updateEquipChangeSummary() {
  const el = document.getElementById('equip-change-summary');
  if (equipmentChanges.length > 0) {
    el.style.display = 'block';
    el.innerHTML = `⚠️ ${equipmentChanges.length} equipment change${equipmentChanges.length > 1 ? 's' : ''} detected since last check`;
  } else {
    el.style.display = 'none';
  }
}

function getEquipChangeForFlight(flightNum) {
  return equipmentChanges.find(c => c.flight === flightNum);
}

// ═══ HUB HEALTH ═══
let hubHealthData = {};

function updateHubHealth() {
  const bar = document.getElementById('hub-health-bar');
  const hubs = ['ORD','DEN','IAH','EWR','SFO','IAD','LAX','NRT','GUM'];
  let hasData = false;

  // Gather OTP from all loaded schedule data
  for (const key of Object.keys(schedRawByHub)) {
    const flights = schedRawByHub[key];
    if (!flights || !flights.length) continue;
    const hub = key.split('-')[0];
    let onTime = 0, operated = 0;
    flights.forEach(fl => {
      const status = classifySchedStatus(fl);
      const hasOp = status.key === 'departed' || status.key === 'enroute' || status.key === 'landed';
      if (!hasOp) return;
      const schedT = fl.time?.scheduled?.departure || fl.time?.scheduled?.arrival;
      const realT = fl.time?.real?.departure || fl.time?.real?.arrival;
      if (!realT || !schedT) return; // skip flights without real timestamps
      operated++;
      if (realT <= schedT + 1800) onTime++;
    });
    if (operated >= 5) {
      hubHealthData[hub] = Math.round((onTime / operated) * 100);
      hasData = true;
    } else {
      delete hubHealthData[hub]; // clear stale data when sample too small
    }
  }

  if (!hasData) {
    bar.innerHTML = '<span class="hh-label">Hub Health</span><span class="hh-explainer">ON-TIME %</span><span class="hh-info">?<span class="hh-tooltip">% of operated flights departing within 30 min of schedule. 🟢 &gt;70% · 🟡 50–70% · 🔴 &lt;50%</span></span><span style="color:var(--ua-muted)">Load schedule data for hub health</span>';
    return;
  }

  let html = '<span class="hh-label">Hub Health</span><span class="hh-explainer">ON-TIME %</span><span class="hh-info">?<span class="hh-tooltip">% of operated flights departing within 30 min of schedule. 🟢 &gt;70% · 🟡 50–70% · 🔴 &lt;50%</span></span>';
  hubs.forEach((hub, i) => {
    const pct = hubHealthData[hub];
    if (pct === undefined) {
      html += `<span class="hh-hub"><a href="/hubs/${hub.toLowerCase()}" class="hh-code" style="color:inherit;text-decoration:none" title="${hub} Hub Guide">${hub}</a> <span style="color:var(--ua-muted)">⚪ —</span></span>`;
    } else {
      const emoji = pct > 70 ? '🟢' : pct >= 50 ? '🟡' : '🔴';
      const color = pct > 70 ? '#22c55e' : pct >= 50 ? '#f59e0b' : '#ef4444';
      html += `<span class="hh-hub"><a href="/hubs/${hub.toLowerCase()}" class="hh-code" style="color:inherit;text-decoration:none" title="${hub} Hub Guide">${hub}</a> ${emoji} <span class="hh-pct" style="color:${color}">${pct}%</span></span>`;
    }
    if (i < hubs.length - 1) html += '<span class="hh-sep">│</span>';
  });
  // Network average label
  const pcts2 = hubs.map(h => hubHealthData[h]).filter(p => p !== undefined);
  if (pcts2.length) {
    const avg = Math.round(pcts2.reduce((a,b)=>a+b,0) / pcts2.length);
    const avgLabel = avg > 70 ? 'Smooth Ops' : avg >= 50 ? 'Some Delays' : 'Rough Day';
    const avgColor = avg > 70 ? '#22c55e' : avg >= 50 ? '#f59e0b' : '#ef4444';
    html += `<span class="hh-sep">│</span><span class="hh-avg" style="color:${avgColor};font-size:9px;font-weight:700">${avgLabel}</span>`;
  }
  bar.innerHTML = html;
}

// ═══ IRROPS DASHBOARD ═══
let faaDelayIndex = {};

function updateIrrops() {
  const content = document.getElementById('irrops-content');
  // Gather all schedule data
  let allSchedFlts = [];
  for (const flights of Object.values(schedRawByHub)) {
    if (Array.isArray(flights)) allSchedFlts = allSchedFlts.concat(flights);
  }

  if (allSchedFlts.length === 0) {
    content.innerHTML = '<div class="irrops-empty">Load schedule data from the Schedule tab to see IRROPS metrics<br><button class="retry-btn" style="margin-top:8px" data-action="irrops-load">📅 Load Schedule Data</button></div>';
    return;
  }

  let cancellations = 0, delayed30 = 0, delayed60 = 0, diversions = 0, totalFlights = allSchedFlts.length;

  const worstDelays = [];

  allSchedFlts.forEach(fl => {
    const s = classifySchedStatus(fl);
    if (s.key === 'canceled') cancellations++;
    if (s.key === 'diverted') diversions++;
    const schedT = fl.time?.scheduled?.departure || fl.time?.scheduled?.arrival || 0;
    const actT = fl.time?.real?.departure || fl.time?.real?.arrival || fl.time?.estimated?.departure || fl.time?.estimated?.arrival || 0;
    if (schedT && actT && actT > schedT) {
      const delayMin = Math.round((actT - schedT) / 60);
      if (delayMin > 30) delayed30++;
      if (delayMin > 60) delayed60++;
      if (delayMin > 15) {
        const ident = fl.identification?.number?.default || '?';
        const orig = fl.airport?.origin?.code?.iata || '?';
        const dest = fl.airport?.destination?.code?.iata || '?';
        worstDelays.push({ ident, route: `${orig}→${dest}`, delay: delayMin });
      }
    }
  });

  // Ground stops from FAA
  const groundStops = Object.values(faaDelayIndex).filter(d => {
    if (!d.delays) return false;
    return d.delays.some(dl => (dl.type||'').toLowerCase().includes('ground stop'));
  }).length;

  const score = totalFlights > 0 ? ((cancellations * 3 + delayed60 * 2 + delayed30 + diversions * 2) / totalFlights * 100).toFixed(1) : 0;
  const scoreCls = score < 5 ? 'low' : score < 15 ? 'med' : 'high';
  const scoreLabel = score < 5 ? 'Normal Ops' : score < 15 ? 'Minor Disruptions' : 'Significant IRROPS';

  worstDelays.sort((a, b) => b.delay - a.delay);
  const top5 = worstDelays.slice(0, 5);

  let html = `<div style="margin-bottom:10px"><span class="irrops-score ${scoreCls}">${score}</span> <span style="font-size:10px;color:var(--ua-muted)">${scoreLabel} · Disruption Score</span></div>`;
  html += '<div class="irrops-metrics">';
  html += `<div class="irrops-card"><div class="iv" style="color:#f59e0b">${delayed30}</div><div class="il">Delayed &gt;30m</div></div>`;
  html += `<div class="irrops-card"><div class="iv" style="color:#ef4444">${delayed60}</div><div class="il">Delayed &gt;60m</div></div>`;
  html += `<div class="irrops-card"><div class="iv" style="color:#c026d3">${diversions}</div><div class="il">Diversions</div></div>`;
  html += `<div class="irrops-card"><div class="iv" style="color:#ef4444">${groundStops}</div><div class="il">Ground Stops (FAA)</div></div>`;
  html += `<div class="irrops-card"><div class="iv" style="color:var(--ua-blue)">${totalFlights}</div><div class="il">Total Flights</div></div>`;
  html += '</div>';

  // FAA alerts
  const faaAlerts = [];
  for (const [apt, data] of Object.entries(faaDelayIndex)) {
    if (data.delays && data.delays.length > 0) {
      data.delays.forEach(d => faaAlerts.push(`${apt}: ${d.type || d.reason || 'Delay'}`));
    }
  }
  if (faaAlerts.length) {
    html += `<div style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:4px;padding:8px 10px;margin-bottom:10px;font-size:10px;color:#f59e0b"><strong>FAA Alerts:</strong> ${faaAlerts.map(a => escapeHtml(a)).join(' · ')}</div>`;
  }

  if (top5.length) {
    html += '<div class="irrops-worst"><h4>Most Disrupted Flights</h4>';
    top5.forEach(f => {
      html += `<div class="irrops-worst-row"><span style="color:var(--ua-accent);font-weight:600">${escapeHtml(f.ident)} <span style="color:var(--ua-muted);font-weight:400">${escapeHtml(f.route)}</span></span><span style="color:#ef4444;font-weight:700">+${f.delay}m</span></div>`;
    });
    html += '</div>';
  }

  content.innerHTML = html;
}

function autoLoadIrrops() {
  // Try server-side precomputed IRROPS first
  fetchIrropsFromAPI();
}

async function fetchIrropsFromAPI() {
  const content = document.getElementById('irrops-content');
  content.innerHTML = '<div class="irrops-empty" style="color:var(--ua-muted);font-size:10px">Loading IRROPS data…</div>';
  try {
    const resp = await fetch('/api/irrops');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    renderIrropsFromAPI(data);
  } catch (e) {
    console.error('IRROPS API failed, falling back to manual:', e);
    content.innerHTML = '<div class="irrops-empty">Load schedule data from the Schedule tab to see IRROPS metrics<br><button class="retry-btn" style="margin-top:8px" data-action="irrops-load">📅 Load Schedule Data</button></div>';
  }
}

function renderIrropsFromAPI(data) {
  // Hydrate schedule cache from IRROPS hub flights (avoids 7 separate schedule calls)
  if (data.hubFlights) {
    const hubs = ['ORD','DEN','IAH','EWR','SFO','IAD','LAX','NRT','GUM'];
    hubs.forEach(hub => {
      const flights = data.hubFlights[hub];
      if (!flights || !flights.length) return;
      const hubKey = `${hub}-departures-0`;
      if (!schedRawByHub[hubKey]) {
        schedRawByHub[hubKey] = flights;
        // Also populate the fetch cache so Schedule tab doesn't re-fetch
        const timestamp = getSchedDayTimestamp(0);
        const cacheKey = `agg-${hub}-departures-${timestamp}`;
        if (!schedCache[cacheKey]) {
          schedCache[cacheKey] = { flights, total: flights.length, cached: true, hub, dir: 'departures' };
        }
      }
    });
  }

  // Use hub metrics from IRROPS API to populate hub health bar immediately
  if (data.hubMetrics) {
    const bar = document.getElementById('hub-health-bar');
    const hubs = ['ORD','DEN','IAH','EWR','SFO','IAD','LAX','NRT','GUM'];
    let html = '<span class="hh-label">Hub Health</span><span class="hh-explainer">ON-TIME %</span><span class="hh-info">?<span class="hh-tooltip">% of operated flights departing within 30 min of schedule. 🟢 &gt;70% · 🟡 50–70% · 🔴 &lt;50%</span></span>';
    hubs.forEach((hub, i) => {
      const m = data.hubMetrics[hub];
      if (!m || !m.total) {
        html += `<span class="hh-hub"><a href="/hubs/${hub.toLowerCase()}" class="hh-code" style="color:inherit;text-decoration:none" title="${hub} Hub Guide">${hub}</a> <span style="color:var(--ua-muted)">⚪ —</span></span>`;
      } else {
        // OTP = on-time flights / operated flights (within 30 min of schedule)
        const operated = m.operated || (m.total - m.cancellations);
        // High cancellation rate: show red even if too few operated flights
        const cancelRate = m.total > 10 ? (m.cancellations || 0) / m.total : 0;
        if ((!operated || operated < 5) && cancelRate >= 0.5) {
          // Mostly/fully cancelled hub — show as critical
          const cancelPct = Math.round(cancelRate * 100);
          hubHealthData[hub] = 0;
          html += `<span class="hh-hub"><a href="/hubs/${hub.toLowerCase()}" class="hh-code" style="color:inherit;text-decoration:none" title="${hub} Hub Guide">${hub}</a> 🔴 <span class="hh-pct" style="color:#ef4444">${cancelPct}% CX</span></span>`;
          if (i < hubs.length - 1) html += '<span class="hh-sep">│</span>';
          return;
        }
        if (!operated || operated < 5) {
          delete hubHealthData[hub]; // clear stale data when sample too small
          html += `<span class="hh-hub"><a href="/hubs/${hub.toLowerCase()}" class="hh-code" style="color:inherit;text-decoration:none" title="${hub} Hub Guide">${hub}</a> <span style="color:var(--ua-muted)">⚪ —</span></span>`;
          if (i < hubs.length - 1) html += '<span class="hh-sep">│</span>';
          return;
        }
        const onTime = m.onTime !== undefined ? m.onTime : Math.max(0, operated - m.delayed30);
        const pct = Math.round((onTime / operated) * 100);
        const emoji = pct > 70 ? '🟢' : pct >= 50 ? '🟡' : '🔴';
        const color = pct > 70 ? '#22c55e' : pct >= 50 ? '#f59e0b' : '#ef4444';
        hubHealthData[hub] = pct;
        html += `<span class="hh-hub"><a href="/hubs/${hub.toLowerCase()}" class="hh-code" style="color:inherit;text-decoration:none" title="${hub} Hub Guide">${hub}</a> ${emoji} <span class="hh-pct" style="color:${color}">${pct}%</span></span>`;
      }
      if (i < hubs.length - 1) html += '<span class="hh-sep">│</span>';
    });
    // Network average label
    const pcts = hubs.map(h => hubHealthData[h]).filter(p => p !== undefined);
    if (pcts.length) {
      const avg = Math.round(pcts.reduce((a,b)=>a+b,0) / pcts.length);
      const avgLabel = avg > 70 ? 'Smooth Ops' : avg >= 50 ? 'Some Delays' : 'Rough Day';
      const avgColor = avg > 70 ? '#22c55e' : avg >= 50 ? '#f59e0b' : '#ef4444';
      html += `<span class="hh-sep">│</span><span class="hh-avg" style="color:${avgColor};font-size:9px;font-weight:700">${avgLabel}</span>`;
    }
    bar.innerHTML = html;
  }

  const content = document.getElementById('irrops-content');
  const score = data.score;
  const scoreCls = score < 5 ? 'low' : score < 15 ? 'med' : 'high';
  const scoreLabel = score < 5 ? 'Normal Ops' : score < 15 ? 'Minor Disruptions' : 'Significant IRROPS';

  let html = `<div style="margin-bottom:10px"><span class="irrops-score ${scoreCls}">${score}</span> <span style="font-size:10px;color:var(--ua-muted)">${scoreLabel} · Disruption Score</span></div>`;
  html += '<div class="irrops-metrics">';
  html += `<div class="irrops-card"><div class="iv" style="color:#ef4444">${data.cancellations || '—'}</div><div class="il">Cancellations<span style="font-size:7px;display:block;color:var(--ua-muted)" title="FR24 schedule data does not reliably include cancelled flights">Limited data</span></div></div>`;
  html += `<div class="irrops-card"><div class="iv" style="color:#f59e0b">${data.delayed30}</div><div class="il">Delayed &gt;30m</div></div>`;
  html += `<div class="irrops-card"><div class="iv" style="color:#ef4444">${data.delayed60}</div><div class="il">Delayed &gt;60m</div></div>`;
  html += `<div class="irrops-card"><div class="iv" style="color:#c026d3">${data.diversions}</div><div class="il">Diversions</div></div>`;
  html += `<div class="irrops-card"><div class="iv" style="color:var(--ua-blue)">${data.totalFlights}</div><div class="il">Total Flights</div></div>`;
  html += '</div>';

  // Worst delays
  if (data.worstDelays && data.worstDelays.length) {
    html += '<div class="irrops-worst"><h4>Most Disrupted Flights</h4>';
    data.worstDelays.forEach(f => {
      html += `<div class="irrops-worst-row"><span style="color:var(--ua-accent);font-weight:600">${escapeHtml(f.ident)} <span style="color:var(--ua-muted);font-weight:400">${escapeHtml(f.route)}</span></span><span style="color:#ef4444;font-weight:700">+${f.delay}m</span></div>`;
    });
    html += '</div>';
  }

  // Timestamp
  if (data.generatedAt) {
    const ago = Math.round((Date.now() - new Date(data.generatedAt).getTime()) / 60000);
    html += `<div style="text-align:right;font-size:8px;color:var(--ua-muted);margin-top:8px">${ago < 1 ? 'Just now' : ago + 'm ago'}${data.cached ? ' · cached' : ''}</div>`;
  }

  content.innerHTML = html;
}

// ═══ FAA DELAY CONTEXT ═══
function getFAADelayContext(originIata, destIata) {
  const contexts = [];
  [originIata, destIata].forEach(apt => {
    if (!apt) return;
    const faa = faaDelayIndex[apt];
    if (!faa || !faa.delays || !faa.delays.length) return;
    faa.delays.forEach(d => {
      const dtype = (d.type || '').toLowerCase();
      let label = 'Delay';
      if (dtype.includes('ground stop')) label = 'Ground Stop';
      else if (dtype.includes('ground delay') || dtype.includes('gdp')) label = 'GDP';
      else if (dtype.includes('departure')) label = 'Dep Delay';
      else if (dtype.includes('arrival')) label = 'Arr Delay';
      const avg = d.avgDelay ? `, avg ${d.avgDelay} min` : '';
      contexts.push(`${label} at ${apt}${avg}`);
    });
  });
  return contexts.join(' · ');
}

// ═══ FLIGHT WATCH ═══
const MAX_WATCHED = 20;

function getWatchedFlights() {
  try { return JSON.parse(localStorage.getItem('bb_watched_flights') || '[]'); } catch(e) { return []; }
}

function saveWatchedFlights(list) {
  try { localStorage.setItem('bb_watched_flights', JSON.stringify(list.slice(0, MAX_WATCHED))); } catch(e) {}
  updateWatchBadge();
}

function isFlightWatched(flightNum) {
  return getWatchedFlights().some(w => w.flight === flightNum);
}

function toggleWatchFlight(flightNum, route, currentStatus) {
  let watched = getWatchedFlights();
  const idx = watched.findIndex(w => w.flight === flightNum);
  if (idx >= 0) {
    watched.splice(idx, 1);
  } else {
    watched.push({ flight: flightNum, route: route || '', status: currentStatus || '', ts: Date.now() });
    // Show push notification prompt if not yet asked
    const prompted = localStorage.getItem('bb_push_prompted');
    if (!prompted && 'Notification' in window && Notification.permission === 'default') {
      setTimeout(() => {
        document.getElementById('push-prompt').classList.add('show');
        setTimeout(() => document.getElementById('push-prompt').classList.remove('show'), 15000);
      }, 500);
    }
  }
  saveWatchedFlights(watched);
  renderScheduleTable();
  renderWatchPanel();
}

function updateWatchBadge() {
  const watched = getWatchedFlights();
  const badge = document.getElementById('watch-badge');
  if (watched.length > 0) {
    badge.style.display = 'block';
    badge.textContent = watched.length;
  } else {
    badge.style.display = 'none';
  }
}

function toggleWatchPanel() {
  const panel = document.getElementById('watch-panel');
  panel.classList.toggle('show');
  renderWatchPanel();
}

function renderWatchPanel() {
  const watched = getWatchedFlights();
  const list = document.getElementById('watch-panel-list');
  if (watched.length === 0) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--ua-muted);font-size:10px">No watched flights<br>Click 👁️ on any flight to watch it</div>';
    return;
  }
  list.innerHTML = watched.map(w => `<div class="watch-flight-item">
    <div class="watch-flight-info"><span class="wf-num">${escapeHtml(w.flight)}</span> <span class="wf-route">${escapeHtml(w.route)}</span></div>
    <div style="display:flex;align-items:center;gap:4px"><span class="watch-flight-status" style="font-size:9px;color:var(--ua-muted)">${escapeHtml(w.status)}</span><button class="watch-remove" data-action="toggle-watch-flight" data-flight="${escapeHtml(w.flight)}" data-stop-prop="1" aria-label="Remove watched flight" title="Remove">✕</button></div>
  </div>`).join('');
}

function clearAllWatched() {
  saveWatchedFlights([]);
  renderWatchPanel();
  renderScheduleTable();
}

function isSignificantStatusChange(oldStatus, newStatus) {
  if (!oldStatus || !newStatus || oldStatus === newStatus) return false;
  const nl = newStatus.toLowerCase();
  // Always notify: cancelled, diverted, landed, departed
  if (nl.includes('cancel') || nl.includes('divert') || nl.includes('landed') || nl.includes('departed')) return true;
  // Notify if delay appeared or gate changed
  if (nl.includes('delay')) return true;
  if (nl.includes('gate') && nl !== oldStatus.toLowerCase()) return true;
  // Generic status text changed (e.g. scheduled → en route)
  const ol = oldStatus.toLowerCase();
  const significantKeys = ['cancel', 'divert', 'landed', 'departed', 'en route', 'delay', 'gate'];
  if (significantKeys.some(k => nl.includes(k) || ol.includes(k))) return true;
  return false;
}

function checkWatchedFlightChanges(flights) {
  let watched = getWatchedFlights();
  if (!watched.length) return;
  let changed = false;
  flights.forEach(fl => {
    const ident = fl.identification?.number?.default;
    if (!ident) return;
    const wIdx = watched.findIndex(w => w.flight === ident);
    if (wIdx < 0) return;
    const s = classifySchedStatus(fl);
    const newStatus = s.text;
    const oldStatus = watched[wIdx].status;
    if (oldStatus && newStatus !== oldStatus && isSignificantStatusChange(oldStatus, newStatus)) {
      const orig = fl.airport?.origin?.code?.iata || '?';
      const dest = fl.airport?.destination?.code?.iata || '?';
      const msg = `🔔 ${ident} ${orig}→${dest}: ${newStatus} (was: ${oldStatus})`;
      if (document.hidden) {
        // Page not visible — fire native notification
        if ('Notification' in window && Notification.permission === 'granted') {
          const n = new Notification('The Blue Board', {
            body: `${ident}: ${newStatus} (was: ${oldStatus})`,
            icon: '/icons/icon-192.png',
            tag: 'bb-watch-' + ident,
            data: { flight: ident }
          });
          n.onclick = function() { window.focus(); focusWatchedFlight(ident); };
        }
      } else {
        // Page visible — show in-page banner
        showWatchNotification(msg);
      }
      // Show BMAC prompt when a watched flight lands
      if (newStatus.toLowerCase().includes('landed') && typeof window.showBmacLandingToast === 'function') {
        window.showBmacLandingToast(ident);
      }
      changed = true;
    }
    watched[wIdx].status = newStatus;
    watched[wIdx].ts = Date.now();
  });
  if (changed) saveWatchedFlights(watched);
}

function focusWatchedFlight(ident) {
  const match = allFlights.find(f => (f.flightIATA || f.callsign) === ident);
  if (match && flightMarkers[match.icao24]) {
    focusFlight(match.icao24);
  }
}

function showWatchNotification(msg) {
  const el = document.getElementById('watch-notification');
  document.getElementById('wn-text').textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 10000);
}

function hideGlobalSearchResults() {
  const results = document.getElementById('global-search-results');
  if (results) results.style.display = 'none';
}

function toggleSidebarFilters() {
  const panel = document.getElementById('sidebar-extra-filters');
  const btn = document.getElementById('sidebar-filters-toggle');
  if (!panel || !btn) return;
  panel.classList.toggle('show');
  btn.textContent = panel.classList.contains('show') ? 'Filters ▴' : 'Filters ▾';
}

function toggleScheduleMoreFilters() {
  const panel = document.getElementById('sched-adv-filters');
  const btn = document.getElementById('sched-more-filters-btn');
  if (!panel || !btn) return;
  const isHidden = panel.style.display === 'none' || panel.style.display === '';
  panel.style.display = isHidden ? 'flex' : 'none';
  btn.textContent = isHidden ? 'Less Filters ▴' : 'More Filters ▾';
}

// Keyboard support: Enter/Space triggers click on [data-action][role="button"] elements
document.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' || e.key === ' ') {
    const el = e.target.closest('[data-action][role="button"]');
    if (el) { e.preventDefault(); el.click(); }
  }
});
document.addEventListener('click', function(e) {
  const actionEl = e.target.closest('[data-action]');
  if (!actionEl) return;
  if (actionEl.dataset.preventDefault) e.preventDefault();
  if (actionEl.dataset.stopProp) e.stopPropagation();
  const action = actionEl.dataset.action;
  switch (action) {
    case 'dismiss-watch-notification': {
      const wn = document.getElementById('watch-notification');
      if (wn) wn.classList.remove('show');
      break;
    }
    case 'toggle-watch-panel':
      toggleWatchPanel();
      break;
    case 'clear-all-watched':
      clearAllWatched();
      break;
    case 'toggle-sidebar-filters':
      toggleSidebarFilters();
      break;
    case 'toggle-hubs':
      toggleHubs();
      break;
    case 'toggle-longhaul':
      toggleLonghaul();
      break;
    case 'toggle-weather':
      toggleWeather();
      break;
    case 'view-pacific':
      togglePacific();
      break;
    case 'refresh-flights':
      refreshFlights();
      break;
    case 'schedule-refresh':
      loadScheduleData();
      break;
    case 'schedule-more-filters':
      toggleScheduleMoreFilters();
      break;
    case 'refresh-fleet-data':
      refreshFleetData();
      break;
    case 'irrops-load':
      autoLoadIrrops();
      break;
    case 'map-error-retry': {
      const overlay = actionEl.closest('#map-error-overlay');
      if (overlay) overlay.remove();
      refreshFlights();
      break;
    }
    case 'weather-retry':
      weatherInitialized = false;
      initWeatherTab();
      break;
    case 'toggle-watch-flight':
      toggleWatchFlight(actionEl.dataset.flight, actionEl.dataset.route, actionEl.dataset.status);
      break;
    case 'share-flight': {
      const flightId = actionEl.dataset.flight;
      const shareUrl = new URL(window.location);
      shareUrl.searchParams.set('flight', flightId);
      shareUrl.hash = '';
      navigator.clipboard.writeText(shareUrl.toString()).then(() => {
        actionEl.classList.add('copied');
        actionEl.textContent = '✓ Copied!';
        setTimeout(() => { actionEl.classList.remove('copied'); actionEl.textContent = '📤 Share'; }, 2000);
      }).catch(() => {
        // Fallback for older browsers
        const ta = document.createElement('textarea');
        ta.value = shareUrl.toString();
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        actionEl.classList.add('copied');
        actionEl.textContent = '✓ Copied!';
        setTimeout(() => { actionEl.classList.remove('copied'); actionEl.textContent = '📤 Share'; }, 2000);
      });
      break;
    }
    case 'enable-push':
      if ('Notification' in window) {
        Notification.requestPermission().then(p => {
          if (p === 'granted') showWatchNotification('🔔 Push notifications enabled for watched flights');
        });
      }
      try { localStorage.setItem('bb_push_prompted', '1'); } catch(e) {}
      document.getElementById('push-prompt').classList.remove('show');
      break;
    case 'dismiss-push':
      try { localStorage.setItem('bb_push_prompted', '1'); } catch(e) {}
      document.getElementById('push-prompt').classList.remove('show');
      break;
    case 'toggle-phase-filter':
      togglePhaseFilter(actionEl.dataset.phase);
      break;
    case 'clear-filters':
      clearAllFilters();
      break;
    case 'toggle-hub-filter':
      toggleHubFilter(actionEl.dataset.hub);
      break;
    case 'focus-flight':
      focusFlight(actionEl.dataset.icao24);
      if (actionEl.dataset.closeGlobal) hideGlobalSearchResults();
      break;
    case 'filter-fleet-type':
      filterFleetType(actionEl.dataset.type);
      break;
    case 'switch-tab':
      switchToTab(actionEl.dataset.tab);
      if (actionEl.dataset.closeGlobal) hideGlobalSearchResults();
      break;
    case 'go-home':
      e.preventDefault();
      switchToTab('tab-live');
      window.scrollTo({top:0,behavior:'smooth'});
      break;
    case 'lookup-fr24':
      lookupFR24Flight(actionEl.dataset.query || '');
      if (actionEl.dataset.closeGlobal) hideGlobalSearchResults();
      break;
    case 'fleet-search': {
      switchToTab('tab-fleet');
      if (actionEl.dataset.reg) {
        const input = document.getElementById('fleet-search');
        if (input) input.value = actionEl.dataset.reg;
      }
      renderFleetTable();
      break;
    }
    case 'show-disclaimer':
      showDisclaimer();
      break;
    case 'hide-disclaimer':
      hideDisclaimer();
      break;
    case 'close-bmac': {
      const toast = actionEl.closest('#bmac-toast');
      if (toast) toast.remove();
      else if (actionEl.parentElement) actionEl.parentElement.remove();
      localStorage.setItem('bb-bmac-dismissed', Date.now());
      break;
    }
    case 'close-fr24-modal': {
      const modal = document.getElementById('fr24-modal');
      if (modal) modal.style.display = 'none';
      break;
    }
    default:
      break;
  }
});

// Close watch panel on outside click
document.addEventListener('click', function(e) {
  const wp = document.getElementById('watch-panel');
  const wb = document.getElementById('watch-header-btn');
  if (wp && wb && !wp.contains(e.target) && !wb.contains(e.target)) wp.classList.remove('show');
});

document.addEventListener('click', function(e) {
  const modal = document.getElementById('disclaimer-modal');
  if (modal && e.target === modal) hideDisclaimer();
});

// ═══ INIT ═══
async function initApp() {
  updateWatchBadge();
  // Start fleet data load in parallel — don't block map init
  const fleetReady = loadFleetData();
  initMap();
  await fleetReady; // Ensure fleet data is loaded before fleet tab init
  initFleetTab();
  showConfigGallery('737-800'); // default
  updateTicker();
  // Defer IRROPS + schedule preload to idle — they're only needed for Weather/Schedule tabs
  // Background preload: fetch top 3 hubs on idle so Schedule tab is fast without hammering mobile
  const idlePreload = () => { preloadScheduleData(); fetchIrropsFromAPI(); };
  if ('requestIdleCallback' in window) requestIdleCallback(idlePreload); else setTimeout(idlePreload, 5000);
}

// Wait for deferred Leaflet to load before initializing
if (typeof L !== 'undefined') { initApp(); }
else { document.addEventListener('DOMContentLoaded', () => initApp()); }

// ═══ DISCLAIMER MODAL ═══
function showDisclaimer() {
  document.getElementById('disclaimer-modal').style.display = 'flex';
}
function hideDisclaimer() {
  document.getElementById('disclaimer-modal').style.display = 'none';
}
</script>

</main>
<!-- DISCLAIMER MODAL -->
<div id="disclaimer-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:10000;align-items:center;justify-content:center;padding:20px">
  <div style="background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:8px;max-width:600px;width:100%;padding:24px;max-height:80vh;overflow-y:auto">
    <h2 style="color:var(--ua-blue);font-size:14px;margin-bottom:16px;text-transform:uppercase;letter-spacing:1px">⚖️ About The Blue Board</h2>
    <div style="font-size:11px;line-height:1.7;color:var(--ua-text)">
      <p style="margin-bottom:12px"><strong style="color:var(--ua-yellow)">The Blue Board is an independent, fan-built project and is not affiliated with, endorsed by, or connected to United Airlines, Inc.</strong> "United Airlines" and the United logo are trademarks of United Airlines, Inc. An independent tool built for the United community.</p>
      <p style="margin-bottom:12px"><strong>Data Sources & Attribution:</strong></p>
      <ul style="margin:0 0 12px 20px;color:var(--ua-muted)">
        <li><a href="https://www.flightradar24.com" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent)">Flightradar24</a> — Live flight positions and schedule data</li>
        <li><a href="https://aviationweather.gov" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent)">Aviation Weather Center (NOAA)</a> — METAR weather observations</li>
        <li><a href="https://nasstatus.faa.gov" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent)">FAA NAS Status</a> — Airport delay and closure information</li>
        <li>Fleet configuration data sourced from publicly available records</li>
      </ul>
      <p style="margin-bottom:12px"><strong>Data Accuracy:</strong> All flight data is provided for informational purposes only and may be delayed, incomplete, or inaccurate. <strong style="color:var(--ua-red)">Do not use this dashboard for operational or safety-critical decisions.</strong> Always verify flight status directly with <a href="https://www.united.com" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent)">united.com</a> or your airline.</p>
      <p style="margin-bottom:12px"><strong>Open Source:</strong> This project is open source. <a href="https://github.com/notjbg/the-blue-board" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent)">View on GitHub →</a> · <a href="https://x.com/theblueboard" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent)">Follow on X →</a></p>
      <p style="margin-bottom:12px"><strong>Support:</strong> Built by a United flyer, not a corporation. If Blue Board saved you a headache today, consider <a href="https://buymeacoffee.com/notjbg" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent)">supporting our site ☕</a>, <a href="https://buymeacoffee.com/notjbg/membership" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent)">become a monthly supporter →</a>, or <a href="https://github.com/notjbg/the-blue-board/issues" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent)">suggest a feature →</a></p>
      <!-- Supporters Wall — update periodically from BMAC CSV exports -->
      <div style="margin-bottom:12px">
        <p style="margin-bottom:8px"><strong>✈️ Supporters</strong></p>
        <div style="display:flex;flex-wrap:wrap;gap:4px 8px;font-size:10px;color:var(--ua-muted);line-height:1.6">
          <span>Greeby</span><span>·</span><span>natto</span><span>·</span><span>u/WrldDriftR</span><span>·</span><span>Leo</span><span>·</span><span>FlyerTalk JCG1005</span><span>·</span><span>@paytonwolfee</span><span>·</span><span>@misadventurelab</span><span>·</span><span>@MissLynsey</span><span>·</span><span>Danny</span><span>·</span><span>K2</span><span>·</span><span>James W</span><span>·</span><span>Aaron</span><span>·</span><span>@pconrad0</span><span>·</span><span>Stephen R</span><span>·</span><span>ML</span>
        </div>
        <p style="margin-top:6px;font-size:10px;color:var(--ua-muted)">Want to see your name here? <a href="https://buymeacoffee.com/notjbg" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent)">☕ Buy me a coffee</a></p>
      </div>
    </div>
    <button data-action="hide-disclaimer" style="margin-top:16px;background:var(--ua-blue);color:white;border:none;padding:8px 24px;font-family:var(--mono);font-size:11px;cursor:pointer;border-radius:4px;width:100%">Got it</button>
  </div>
</div>

<!-- SITE FOOTER -->
<footer style="background:var(--ua-panel);border-top:1px solid var(--ua-border);padding:10px 16px;font-size:9px;color:var(--ua-muted);text-align:center;line-height:1.8">
  <div style="display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:4px 10px">
    <a href="#" data-action="show-disclaimer" data-prevent-default="1" style="color:var(--ua-accent);text-decoration:none">About</a>
    <span>·</span>
    <a href="#" data-action="show-disclaimer" data-prevent-default="1" style="color:var(--ua-accent);text-decoration:none">Disclaimer</a>
    <span>·</span>
    <a href="/fleet" style="color:var(--ua-accent);text-decoration:none">Fleet Database</a>
    <span>·</span>
    <a href="https://github.com/notjbg/the-blue-board/issues" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent);text-decoration:none">Support / Feedback</a>
    <span>·</span>
    <a href="https://buymeacoffee.com/notjbg" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent);text-decoration:none">Donate</a>
  </div>
  <div style="margin-top:4px">The Blue Board · Independent · Not affiliated with United Airlines, Inc. · Data may be delayed</div>
  <div class="footer-hub-links" style="display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:4px 8px;margin-top:4px">
    <span>Hubs:</span>
    <a href="/hubs/ord" style="color:var(--ua-accent);text-decoration:none">ORD</a> ·
    <a href="/hubs/den" style="color:var(--ua-accent);text-decoration:none">DEN</a> ·
    <a href="/hubs/iah" style="color:var(--ua-accent);text-decoration:none">IAH</a> ·
    <a href="/hubs/ewr" style="color:var(--ua-accent);text-decoration:none">EWR</a> ·
    <a href="/hubs/sfo" style="color:var(--ua-accent);text-decoration:none">SFO</a> ·
    <a href="/hubs/iad" style="color:var(--ua-accent);text-decoration:none">IAD</a> ·
    <a href="/hubs/lax" style="color:var(--ua-accent);text-decoration:none">LAX</a> ·
    <a href="/hubs/nrt" style="color:var(--ua-accent);text-decoration:none">NRT</a> ·
    <a href="/hubs/gum" style="color:var(--ua-accent);text-decoration:none">GUM</a>
  </div>
  <div class="footer-data-sources" style="display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:6px 12px;margin-top:4px">
    <span>Data: <a href="https://www.flightradar24.com" target="_blank" rel="noopener noreferrer" style="color:var(--ua-muted);text-decoration:none">FR24</a> · <a href="https://aviationweather.gov" target="_blank" rel="noopener noreferrer" style="color:var(--ua-muted);text-decoration:none">AWC</a> · <a href="https://nasstatus.faa.gov" target="_blank" rel="noopener noreferrer" style="color:var(--ua-muted);text-decoration:none">FAA</a></span>
    <a href="https://buymeacoffee.com/notjbg" target="_blank" rel="noopener noreferrer" style="background:var(--ua-blue);color:white;padding:3px 10px;border-radius:3px;text-decoration:none;font-size:9px;font-family:var(--mono);white-space:nowrap">☕ Support Server Costs</a>
    <span style="white-space:nowrap">Built by <a href="https://github.com/notjbg" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent);text-decoration:none">Jonah Berg</a> · <a href="https://x.com/theblueboard" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent);text-decoration:none">Follow @theblueboard</a></span>
  </div>
</footer>

<script defer src="/_vercel/insights/script.js"></script>
<script defer src="/_vercel/speed-insights/script.js"></script>
<script>
(function(){
  var overlay=document.getElementById('onboarding-overlay');
  var btn=document.getElementById('onboarding-dismiss');
  var helpBtn=document.getElementById('onboarding-help');
  function hideOverlay(){overlay.classList.add('ob-hidden');localStorage.setItem('bb-onboarded','1');setTimeout(function(){overlay.style.display='none'},300)}
  function showOverlay(){overlay.style.display='flex';overlay.classList.remove('ob-hidden');overlay.style.animation='none';overlay.offsetHeight;overlay.style.animation='obFadeIn .4s ease forwards'}

  // ═══ BMAC ENGAGEMENT-BASED PROMPTS ═══
  var bmacDismissedAt = parseInt(localStorage.getItem('bb-bmac-dismissed') || '0');
  var bmacDismissed = bmacDismissedAt && (Date.now() - bmacDismissedAt < 7 * 24 * 60 * 60 * 1000); // resets after 7 days
  var bmacInteractions = 0;
  var bmacShownThisSession = false;

  function showBmacToast(message, duration) {
    if (bmacShownThisSession || bmacDismissed) return;
    if (document.getElementById('bmac-toast')) return;
    bmacShownThisSession = true;
    var t = document.createElement('div'); t.id = 'bmac-toast';
    t.style.cssText = 'position:fixed;bottom:16px;right:16px;background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:8px;padding:14px 16px;z-index:9999;font-size:12px;color:var(--ua-text);box-shadow:0 4px 20px rgba(0,0,0,.5);max-width:340px;line-height:1.5;animation:fadeIn .3s ease';
    t.innerHTML = message + ' <button data-action="close-bmac" aria-label="Dismiss" style="background:none;border:none;color:var(--ua-muted);cursor:pointer;font-size:16px;position:absolute;top:6px;right:8px">✕</button>';
    document.body.appendChild(t);
    setTimeout(function(){ if(t.parentElement) { t.style.opacity='0'; t.style.transition='opacity .3s'; setTimeout(function(){ if(t.parentElement) t.remove() }, 300); } }, duration || 12000);
  }

  // Trigger 1: After 5 minutes of active use
  setTimeout(function() {
    if (!bmacShownThisSession && !bmacDismissed) {
      showBmacToast('Built by a United flyer, not a corporation. If Blue Board saved you a headache today, consider <a href="https://buymeacoffee.com/notjbg" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent);text-decoration:none;font-weight:700">supporting our site ☕</a>');
    }
  }, 5 * 60 * 1000);

  // Trigger 2: After 10+ meaningful interactions (tab switches, searches, flight clicks)
  document.addEventListener('click', function() {
    bmacInteractions++;
    if (bmacInteractions === 10 && !bmacShownThisSession && !bmacDismissed) {
      showBmacToast('You\'re really digging in! 🛫 This dashboard is free, ad-free, and built with love. <a href="https://buymeacoffee.com/notjbg" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent);text-decoration:none;font-weight:700">☕ Support the project</a>');
    }
  });

  // Trigger 3: Flight watch landing payoff (called from checkWatchedFlightChanges)
  window.showBmacLandingToast = function(flight) {
    if (bmacDismissed) return;
    // Delay slightly so the watch notification shows first
    setTimeout(function() {
      bmacShownThisSession = false; // Allow this special one even if another showed
      showBmacToast('Your flight ' + escapeHtml(flight) + ' landed! 🎉 If Blue Board helped ease the wait — <a href="https://buymeacoffee.com/notjbg" target="_blank" rel="noopener noreferrer" style="color:var(--ua-accent);text-decoration:none;font-weight:700">☕ buy me a coffee</a>', 15000);
    }, 3000);
  };

  var visited=localStorage.getItem('bb-visited');
  if(!visited){localStorage.setItem('bb-visited','1');overlay.style.display='none'}
  else if(localStorage.getItem('bb-onboarded')){overlay.style.display='none'}
  btn.addEventListener('click',hideOverlay);
  overlay.addEventListener('click',function(e){if(e.target===overlay)hideOverlay()});
  helpBtn.addEventListener('click',showOverlay);
})();

// ═══ FR24 FLIGHT LOOKUP ═══
function lookupFR24Flight(query) {
  let q = query.trim().toUpperCase().replace(/\s+/g, '');
  if (/^\d{1,4}$/.test(q)) q = 'UA' + q;
  if (q.startsWith('UAL') && /\d/.test(q[3])) q = 'UA' + q.slice(3);

  // Show loading modal
  let modal = document.getElementById('fr24-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'fr24-modal';
    modal.style.cssText = 'position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7);backdrop-filter:blur(4px)';
    modal.addEventListener('click', function(e) { if (e.target === modal) modal.style.display = 'none'; });
    document.body.appendChild(modal);
  }
  modal.style.display = 'flex';
  modal.innerHTML = '<div style="background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:8px;padding:24px;max-width:420px;width:90%;color:var(--ua-text);font-family:var(--mono);position:relative"><div style="text-align:center;padding:20px;color:var(--ua-muted)"><div style="font-size:24px;margin-bottom:8px">🔍</div>Looking up ' + escapeHtml(q) + '...</div></div>';

  fetch('/api/fr24-flight?flight=' + encodeURIComponent(q))
    .then(r => r.json())
    .then(data => {
      if (!data.success || !data.flight) {
        modal.innerHTML = '<div style="background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:8px;padding:24px;max-width:420px;width:90%;color:var(--ua-text);font-family:var(--mono);position:relative"><button data-action="close-fr24-modal" aria-label="Close" style="position:absolute;top:8px;right:12px;background:none;border:none;color:var(--ua-muted);cursor:pointer;font-size:16px">✕</button><div style="text-align:center;padding:20px"><div style="font-size:24px;margin-bottom:8px">✈️</div><div style="color:var(--ua-muted);font-size:11px">' + escapeHtml(data.error || 'No data found for ' + q) + '</div><div style="margin-top:12px;font-size:9px;color:var(--ua-muted)">The flight may not be active right now.<br>Check the Schedule tab for gate status.</div></div></div>';
        return;
      }
      renderFR24Modal(data.flight, data.source, data.cached);
    })
    .catch(err => {
      console.error('FR24 lookup error:', err);
      modal.innerHTML = '<div style="background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:8px;padding:24px;max-width:420px;width:90%;color:var(--ua-text);font-family:var(--mono);position:relative"><button data-action="close-fr24-modal" aria-label="Close" style="position:absolute;top:8px;right:12px;background:none;border:none;color:var(--ua-muted);cursor:pointer;font-size:16px">✕</button><div style="text-align:center;padding:20px;color:var(--ua-muted)"><div style="font-size:24px;margin-bottom:8px">⚠️</div>Failed to look up flight. Try again later.</div></div>';
    });
}

function renderFR24Modal(f, source, cached) {
  var modal = document.getElementById('fr24-modal');
  var statusColors = {'en-route':'#22c55e','on-ground':'#f59e0b','landed':'#3b82f6','scheduled':'#6b7280','unknown':'#6b7280'};
  var statusColor = statusColors[f.status] || statusColors['unknown'];
  var statusLabel = (f.status || 'unknown').replace(/-/g, ' ');

  // Cross-reference with FLEET_DB for enrichment
  var fleetInfo = '';
  if (f.aircraft && f.aircraft.reg && typeof FLEET_DB !== 'undefined') {
    var match = FLEET_DB.find(function(a) { return a.r === f.aircraft.reg; });
    if (match) {
      fleetInfo = '<div style="margin-top:8px;padding:8px;background:rgba(0,93,170,.1);border-radius:4px;font-size:10px">' +
        '<span style="color:var(--ua-accent)">Fleet Match:</span> ' + escapeHtml(match.t) +
        (match.c ? ' • ' + escapeHtml(match.c) : '') +
        (match.w ? ' • WiFi: ' + escapeHtml(match.w) : '') +
        '</div>';
    }
  }

  var posHtml = '';
  if (f.position && f.position.lat != null && f.position.lon != null) {
    posHtml = '<div style="margin-top:8px;padding:8px;background:rgba(15,23,41,.6);border-radius:4px;font-size:10px">' +
      '<span style="color:var(--ua-muted)">Position:</span> ' + Number(f.position.lat).toFixed(2) + '°, ' + Number(f.position.lon).toFixed(2) + '°' +
      (f.position.alt != null ? ' • ' + f.position.alt.toLocaleString() + ' ft' : '') +
      (f.position.speed != null ? ' • ' + f.position.speed + ' kts' : '') +
      (f.position.heading != null ? ' • hdg ' + f.position.heading + '°' : '') +
      '</div>';
  }

  function fmtTime(t) {
    if (!t) return '—';
    try { var d = new Date(typeof t === 'number' ? t * 1000 : t); return isNaN(d) ? String(t) : d.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit',timeZoneName:'short'}); }
    catch(e) { return String(t); }
  }

  var html = '<div style="background:var(--ua-panel);border:1px solid var(--ua-border);border-radius:8px;padding:0;max-width:420px;width:90%;color:var(--ua-text);font-family:var(--mono);position:relative;overflow:hidden">';
  // Header
  html += '<div style="background:linear-gradient(135deg,rgba(0,93,170,.3),rgba(0,50,100,.2));padding:16px 20px;border-bottom:1px solid var(--ua-border)">';
  html += '<button data-action="close-fr24-modal" aria-label="Close" style="position:absolute;top:8px;right:12px;background:none;border:none;color:var(--ua-muted);cursor:pointer;font-size:16px">✕</button>';
  html += '<div style="font-size:16px;font-weight:700;color:var(--ua-accent)">' + escapeHtml(f.flightNumber || '?') + '</div>';
  if (f.callsign) html += '<div style="font-size:10px;color:var(--ua-muted)">' + escapeHtml(f.callsign) + '</div>';
  html += '<div style="margin-top:6px"><span style="display:inline-block;padding:2px 8px;border-radius:3px;font-size:9px;font-weight:600;background:' + statusColor + '22;color:' + statusColor + ';border:1px solid ' + statusColor + '44">' + escapeHtml(statusLabel.toUpperCase()) + '</span></div>';
  html += '</div>';
  // Body
  html += '<div style="padding:16px 20px">';
  // Route
  var origLabel = (f.origin && f.origin.iata) ? f.origin.iata : '?';
  var destLabel = (f.destination && f.destination.iata) ? f.destination.iata : '?';
  var origName = (f.origin && f.origin.name) ? f.origin.name : '';
  var destName = (f.destination && f.destination.name) ? f.destination.name : '';
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">';
  html += '<div style="text-align:center"><div style="font-size:18px;font-weight:700">' + escapeHtml(origLabel) + '</div><div style="font-size:9px;color:var(--ua-muted);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + escapeHtml(origName) + '</div></div>';
  html += '<div style="flex:1;text-align:center;color:var(--ua-muted);font-size:16px">✈ →</div>';
  html += '<div style="text-align:center"><div style="font-size:18px;font-weight:700">' + escapeHtml(destLabel) + '</div><div style="font-size:9px;color:var(--ua-muted);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + escapeHtml(destName) + '</div></div>';
  html += '</div>';
  // Aircraft
  if (f.aircraft && (f.aircraft.type || f.aircraft.reg)) {
    html += '<div style="font-size:10px;margin-bottom:4px"><span style="color:var(--ua-muted)">Aircraft:</span> ' + escapeHtml(f.aircraft.type || '?') + (f.aircraft.reg ? ' • ' + escapeHtml(f.aircraft.reg) : '') + '</div>';
  }
  // Times
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;font-size:10px">';
  html += '<div><span style="color:var(--ua-muted)">Dep Sched:</span><br>' + escapeHtml(fmtTime(f.departure?.scheduled)) + '</div>';
  html += '<div><span style="color:var(--ua-muted)">Dep Actual:</span><br>' + escapeHtml(fmtTime(f.departure?.actual)) + '</div>';
  html += '<div><span style="color:var(--ua-muted)">Arr Sched:</span><br>' + escapeHtml(fmtTime(f.arrival?.scheduled)) + '</div>';
  html += '<div><span style="color:var(--ua-muted)">Arr Est:</span><br>' + escapeHtml(fmtTime(f.arrival?.estimated)) + '</div>';
  html += '</div>';
  html += fleetInfo;
  html += posHtml;
  html += '</div>';
  // Footer
  html += '<div style="padding:10px 20px;border-top:1px solid var(--ua-border);display:flex;justify-content:space-between;align-items:center">';
  html += '<div style="font-size:8px;color:var(--ua-muted)">Powered by Flightradar24 Official API' + (cached ? ' • cached' : '') + '</div>';
  html += '<button class="share-btn" data-action="share-flight" data-flight="' + escapeHtml(f.flightNumber || '') + '" aria-label="Share flight link" title="Copy shareable link">📤 Share</button>';
  html += '</div>';
  html += '</div>';

  modal.innerHTML = html;
}
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}
</script>
</body></html>
